# Phase 2: Taskbar 플래시 + Progress Bar

## 목표

- FR-19-006: `flash: true` 파라미터로 비포그라운드 창의 태스크바/독 아이콘 깜빡임
- FR-19-007: `progress` 파라미터(0.0~1.0, -1)로 창 태스크바 진행률 바 표시/제거

## 선행 조건

- Phase 1 완료 (WindowEntry.meta 구조 확립)
- Electron `win.flashFrame()`, `win.setProgressBar()` API 확인

## 구현 체크리스트

### 1. window-manager.js — Flash 처리 (FR-19-006)

- [x] `createWindow(opts)` 수정 — flash 처리:
  - 창 생성 후 `opts.flash === true` 이면:
    - `entry.win.isFocused()` 확인
    - 비포그라운드 상태면 `try { entry.win.flashFrame(true) } catch (e) { console.warn('flashFrame not supported:', e.message) }`
    - 포그라운드 상태면 생략
- [x] `updateWindow(windowId, opts)` 수정 — flash 처리:
  - 동일한 flash 로직 적용

### 2. window-manager.js — Progress Bar 처리 (FR-19-007)

- [x] `createWindow(opts)` 수정 — progress 처리:
  - `opts.progress !== undefined` 이면:
    - 범위 검증: `progress < -1 || progress > 1.0` → isError (핸들러 단에서)
    - `entry.win.setProgressBar(opts.progress)`
    - `entry.meta.progress = opts.progress`
- [x] `updateWindow(windowId, opts)` 수정 — progress 처리:
  - 동일한 progress 로직 적용
- [x] `meta.progress` 초기값 `undefined` 설정

### 3. index.js — IPC 핸들러 파라미터 확장

- [x] `open` 액션 핸들러:
  - `flash` (boolean, 기본 false), `progress` (number, 선택) 파라미터 수신 및 전달
  - `progress` 범위 검증: `< -1` 또는 `> 1.0` 또는 `NaN` → error 응답
- [x] `update` 액션 핸들러:
  - `flash`, `progress` 파라미터 수신 및 전달

### 4. mcp-http.mjs — TOOLS 스키마 업데이트

- [x] `open_markdown` tool 에 추가:
  ```json
  "flash": { "type": "boolean", "default": false, "description": "Flash taskbar/dock icon if not focused" },
  "progress": { "type": "number", "minimum": -1, "maximum": 1.0, "description": "Taskbar progress bar (0.0-1.0, -1 to remove)" }
  ```
- [x] `update_markdown` tool 에 `flash`, `progress` 추가
- [x] 핸들러에서 progress 범위 검증 (NaN, null 포함)
- [x] `list_viewers` 응답 포맷에 progress 포함 (0 이상인 경우만)

### 5. mcp-server.mjs — Zod 스키마 업데이트

- [x] `open_markdown` Zod 스키마에 `flash`, `progress` 추가:
  ```javascript
  flash: z.boolean().default(false),
  progress: z.number().min(-1).max(1.0).optional()
  ```
- [x] `update_markdown` Zod 스키마에 동일하게 추가
- [x] NaN 처리: `z.number().finite()` 사용 또는 superRefine으로 NaN 검사
- [x] 핸들러 로직 동기화

## 테스트 시나리오

### 정상 케이스 1: Progress Bar 표시
- **Given**: 창이 열려 있음
- **When**: `open_markdown { progress: 0.5, content: "다운로드 중..." }` 호출
- **Then**: 태스크바 아이콘에 50% 진행률 바 표시 (`win.setProgressBar(0.5)` 호출 확인)

### 정상 케이스 2: Progress Bar 제거
- **Given**: progress: 0.75 인 창 (windowId: X)
- **When**: `update_markdown { windowId: X, progress: -1 }` 호출
- **Then**: 진행률 바 제거 (`win.setProgressBar(-1)` 호출 확인), `meta.progress = -1` 저장

### 정상 케이스 3: Flash — 비포그라운드 시 플래시
- **Given**: 창이 백그라운드 상태 (isFocused() === false)
- **When**: `open_markdown { flash: true, content: "알람!" }` 호출
- **Then**: `win.flashFrame(true)` 호출됨

### 정상 케이스 4: Flash — 포그라운드 시 플래시 생략
- **Given**: 창이 포그라운드(isFocused() === true)
- **When**: `open_markdown { flash: true, content: "..." }` 호출
- **Then**: `flashFrame` 호출 없음, MCP 응답 정상 반환

### 예외 케이스 1: progress 범위 초과
- **Given**: `progress: 1.5`
- **Then**: isError 응답 반환

### 예외 케이스 2: progress = NaN
- **Given**: `progress: NaN` (또는 null)
- **Then**: isError 응답 반환

### 예외 케이스 3: Linux flashFrame 실패
- **Given**: Linux 환경에서 flashFrame 미지원
- **When**: `open_markdown { flash: true }` 호출 시 예외 발생
- **Then**: `console.warn` 출력, MCP 응답은 정상 반환 (isError 아님)

### 경계값: progress = 0.0
- **Given**: `progress: 0.0`
- **Then**: `win.setProgressBar(0.0)` 호출 (정상 처리), 진행률 0% 표시

### 경계값: progress = 1.0
- **Given**: `progress: 1.0`
- **Then**: `win.setProgressBar(1.0)` 호출, 진행률 100% 표시

## list_viewers progress 출력 규칙

```
# progress가 0 이상인 경우에만 출력
1. [win-42] "다운로드 중" (progress: 75%)       ← progress >= 0
2. [win-43] "일반 창"                             ← progress === undefined
3. [win-44] "완료 창" (progress: 100%)           ← progress === 1.0
# progress === -1 은 "제거" 시그널 → 출력 안 함
```

## 회귀테스트 실행 조건

- [x] Phase 1 기능 (Named Window, Severity) 정상 동작
- [x] `flash: false` 또는 미지정 시 flashFrame 미호출
- [x] `progress` 미지정 시 setProgressBar 미호출
- [x] 기존 `open_markdown`, `update_markdown` 동작 유지
