# Phase 3: Window 태그

## 목표

- FR-19-005: 창에 태그 목록 부여, 태그 기반 창 목록 조회 및 일괄 닫기 지원

## 선행 조건

- Phase 1 완료 (WindowEntry.meta에 `tags: []` 초기값 설정 완료)
- `createWindow()`, `updateWindow()` 파라미터 확장 패턴 확립

## 구현 체크리스트

### 1. window-manager.js — Tags 처리 (FR-19-005)

- [x] `createWindow(opts)` 수정 — tags 처리:
  - `opts.tags` 있으면 `meta.tags = opts.tags` 저장
  - 검증은 index.js/mcp 핸들러 단에서 수행 (개수/길이)
- [x] `updateWindow(windowId, opts)` 수정 — tags 처리:
  - `opts.tags !== undefined` 이면 `entry.meta.tags = opts.tags` (전체 교체)
- [x] `listWindows()` 수정 — tag 필터 파라미터 지원:
  - `tag` 파라미터 없음 → 전체 창 목록 (기존 동작)
  - `tag` 있음 → `entry.meta.tags.includes(tag)` 인 창만 반환
- [x] `closeWindow()` 수정 — tag 기반 일괄 닫기:
  - `tag` 파라미터 있고 `windowId` 없음 → 해당 태그 가진 모든 창 닫기
  - 닫힌 수 반환
- [x] `listWindows()` 응답 포맷 업데이트: `[tags: alarm, critical]` 포함

### 2. index.js — IPC 핸들러 파라미터 확장

- [x] `open` 액션 핸들러:
  - `tags` (string[]) 파라미터 수신
  - 검증: `tags.length > 10` → error, 각 태그 `> 64자` → error
  - 검증 통과 시 windowManager에 전달
- [x] `update` 액션 핸들러:
  - `tags` 파라미터 수신 및 동일 검증 후 전달
- [x] `close` 액션 핸들러:
  - `tag` 파라미터 (단수) 수신
  - `windowId` 없고 `tag` 있으면 → 태그 기반 일괄 닫기
  - 응답: `"Closed N window(s) with tag: <tag>."` 또는 `"No windows with tag: <tag>."`
- [x] `list` 액션 핸들러:
  - `tag` 파라미터 수신 → windowManager.listWindows({ tag }) 호출

### 3. mcp-http.mjs — TOOLS 스키마 업데이트

- [x] `open_markdown` tool 에 추가:
  ```json
  "tags": { "type": "array", "items": { "type": "string", "maxLength": 64 }, "maxItems": 10, "description": "Window group tags" }
  ```
- [x] `update_markdown` tool 에 `tags` 추가
- [x] `close_viewer` tool 에 추가:
  ```json
  "tag": { "type": "string", "description": "Close all windows with this tag" }
  ```
- [x] `list_viewers` tool 에 추가:
  ```json
  "tag": { "type": "string", "description": "Filter windows by tag" }
  ```
- [x] 핸들러에서 tags 검증 (개수, 길이) 및 로직 구현
- [x] 응답 포맷에 tags 포함: `[tags: alarm, critical]`

### 4. mcp-server.mjs — Zod 스키마 업데이트

- [x] `open_markdown` Zod 스키마에 `tags` 추가:
  ```javascript
  tags: z.array(z.string().max(64)).max(10).optional()
  ```
- [x] `update_markdown`, `close_viewer`, `list_viewers` Zod 스키마 업데이트
- [x] 핸들러 로직 동기화

## 테스트 시나리오

### 정상 케이스 1: 태그 할당 및 목록 조회
- **Given**: tags: ["alarm"] 인 창 2개, tags: ["report"] 인 창 1개
- **When**: `list_viewers { tag: "alarm" }` 호출
- **Then**: alarm 태그 2개 창만 반환

### 정상 케이스 2: 태그 일괄 닫기
- **Given**: tags: ["temp"] 인 창 3개
- **When**: `close_viewer { tag: "temp" }` 호출
- **Then**: 3개 창 모두 닫힘, `"Closed 3 window(s) with tag: temp."` 반환

### 정상 케이스 3: 해당 태그 창이 없을 때 일괄 닫기
- **Given**: tags: ["nonexistent"] 인 창 없음
- **When**: `close_viewer { tag: "nonexistent" }` 호출
- **Then**: 에러 아님, `"No windows with tag: nonexistent."` 또는 `closed: 0` 반환

### 정상 케이스 4: tags 갱신 (전체 교체)
- **Given**: 창 X에 `tags: ["a", "b"]` 설정
- **When**: `update_markdown { windowId: X, tags: ["c"] }` 호출
- **Then**: `tags: ["c"]` 로 교체됨 (a, b 제거)

### 예외 케이스 1: tags 10개 초과
- **Given**: `tags: ["t1", "t2", ..., "t11"]` (11개)
- **Then**: isError 반환

### 예외 케이스 2: 태그 항목 64자 초과
- **Given**: 65자 태그 문자열 1개
- **Then**: isError 반환

### 경계값: tags 빈 배열 설정
- **Given**: `tags: []`
- **Then**: 태그 빈 배열로 저장, list_viewers 응답에서 [tags:] 없음

## list_viewers 출력 포맷

```
Open viewer windows (3):
  1. [win-42] "오류 보고서" (severity: error) [tags: alarm, critical]
  2. [win-43] "진행 상황" (severity: info) [tags: progress] (progress: 50%)
  3. [win-44] "일반 창"
```

## 회귀테스트 실행 조건

- [x] Phase 1, 2 기능 정상 동작
- [x] `close_viewer { windowId: X }` 기존 단일 창 닫기 정상 동작
- [x] `list_viewers` tag 미지정 시 전체 창 반환 (기존 동작)
- [x] tags 미지정 창은 tags 필드 없음 또는 빈 배열로 표시
