# Architecture: DocLight Step 19 — 병렬 알람·보고 환경 지원

## 1. System Context

DocLight Step 19는 기존 Step 18 아키텍처 위에 7개 기능을 레이어링한다.
핵심 변경은 **WindowManager에 이름/태그 인덱스 추가**와 **렌더러 IPC 이벤트 2종 추가**다.
신규 파일 생성은 없으며, 기존 파일만 수정한다.

```
┌──────────────────────────────────────────────────────────────────┐
│                        Main Process (CJS)                         │
│                                                                    │
│  ┌──────────┐  ┌───────────────────────────┐  ┌────────────────┐ │
│  │ index.js  │  │   window-manager.js       │  │ mcp-http.mjs   │ │
│  │ (IPC hub) │  │ ★ nameToId: Map           │  │ ★ schema 확장  │ │
│  │           │  │ ★ getWindowByName()       │  │                │ │
│  │           │  │ ★ autoCloseTimer 관리     │  │                │ │
│  │           │  │ ★ severity/tags/progress  │  │                │ │
│  └─────┬─────┘  └──────────┬───────────────┘  └────────────────┘ │
│        │                   │                                       │
│        │  IPC channels     │                                       │
│        ▼                   ▼                                       │
│  ┌──────────────────────────────────────┐                        │
│  │            preload.js (변경 없음)     │                        │
│  │  (contextBridge: window.doclight)    │                        │
│  └──────────────┬───────────────────────┘                        │
├─────────────────┼────────────────────────────────────────────────┤
│                 ▼          Renderer Process (sandbox)             │
│                                                                    │
│  ┌────────────────────────────────────────────────────────────┐  │
│  │                      viewer.js                              │  │
│  │  ★ IPC: 'set-severity' → data-severity 속성 설정           │  │
│  │  ★ IPC: 'auto-close-start' → 카운트다운 타이머 표시         │  │
│  └────────────────────────────────────────────────────────────┘  │
│                                                                    │
│  ┌────────────────────────────────────────────────────────────┐  │
│  │                      viewer.css                             │  │
│  │  ★ .severity-bar { 4px top bar }                           │  │
│  │  ★ .auto-close-bar { bottom countdown }                    │  │
│  └────────────────────────────────────────────────────────────┘  │
│                                                                    │
│  기존 모듈 (변경 없음): image-resolver.js, sidebar-search.js,     │
│    pdf-export-ui.js, tab-manager.js                               │
└──────────────────────────────────────────────────────────────────┘
```

## 2. Component Design

### 2.1 WindowManager 확장

```
WindowManager (window-manager.js)
├── 기존 (Step 18 이전)
│   ├── windows: Map<windowId, { win, meta }>
│   ├── createWindow(opts)
│   ├── updateWindow(windowId, opts)
│   ├── closeWindow(windowId?)
│   └── listWindows()
│
├── FR-19-001 Named Window
│   ├── nameToId: Map<string, number>   ★ 신규
│   ├── getWindowByName(name): entry | null   ★ 신규
│   └── createWindow() 수정: windowName 있으면 upsert
│
├── FR-19-003 Severity
│   └── updateWindow() / createWindow() 수정: severity IPC 전송
│
├── FR-19-004 Auto-close
│   ├── entry.meta.autoCloseTimer 관리   ★ 신규
│   └── _onWindowClosed() 수정: clearTimeout 호출
│
├── FR-19-005 Window Tags
│   └── entry.meta.tags 관리   ★ 신규
│
├── FR-19-006 Flash
│   └── updateWindow() / createWindow() 수정: flashFrame 호출
│
├── FR-19-007 Progress
│   └── updateWindow() / createWindow() 수정: setProgressBar 호출
│
└── FR-19-002 Append Mode
    └── entry.meta.lastRenderedContent 관리   ★ 신규
```

### 2.2 WindowEntry.meta 신규 필드

```javascript
// WindowEntry.meta 구조 (Step 19 이후)
{
  // 기존 필드 (생략)
  windowId: number,
  title: string,
  filePath: string | null,
  alwaysOnTop: boolean,

  // ★ Step 19 신규 필드
  windowName: string | undefined,         // FR-19-001: Named Window
  tags: string[],                          // FR-19-005: Window Tags (기본: [])
  severity: string | undefined,            // FR-19-003: Severity 값
  autoCloseTimer: ReturnType<typeof setTimeout> | undefined,  // FR-19-004
  progress: number | undefined,            // FR-19-007: 진행률 (-1 ~ 1.0)
  lastRenderedContent: string | undefined  // FR-19-002: Append 모드용 콘텐츠
}
```

### 2.3 WindowManager 신규 상태

```javascript
class WindowManager {
  constructor() {
    this.windows = new Map();       // 기존
    this.nameToId = new Map();      // ★ FR-19-001: windowName → windowId
    this.lastPosition = { x: 0, y: 0 };  // 기존
  }
}
```

### 2.4 MCP 도구 스키마 확장

**open_markdown 신규 파라미터:**
```javascript
{
  windowName: z.string().max(256).optional(),
  severity: z.enum(['error', 'warning', 'info', 'success']).optional(),
  autoCloseSeconds: z.number().int().min(1).max(3600).optional(),
  tags: z.array(z.string().max(64)).max(10).optional(),
  flash: z.boolean().default(false),
  progress: z.number().min(-1).max(1.0).optional()
}
```

**update_markdown 신규 파라미터:**
```javascript
{
  appendMode: z.boolean().default(false),
  separator: z.string().default('\n\n'),
  severity: z.enum(['error', 'warning', 'info', 'success']).nullable().optional(),
  tags: z.array(z.string().max(64)).max(10).optional(),
  flash: z.boolean().default(false),
  progress: z.number().min(-1).max(1.0).optional(),
  autoCloseSeconds: z.number().int().min(1).max(3600).optional()
}
```

**close_viewer 신규 파라미터:**
```javascript
{ tag: z.string().optional() }
```

**list_viewers 신규 파라미터:**
```javascript
{ tag: z.string().optional() }
```

### 2.5 렌더러 IPC 이벤트 (viewer.js)

| 이벤트 | 방향 | 페이로드 | 처리 |
|--------|------|---------|------|
| `set-severity` | main → renderer | `{ severity: string \| null }` | `<body>` 에 `data-severity` 속성 설정/제거 |
| `auto-close-start` | main → renderer | `{ seconds: number }` | 하단 상태 바 카운트다운 시작 |

## 3. Data Flow

### 3.1 Named Window upsert 흐름 (FR-19-001)

```
MCP open_markdown { windowName: "alarm-001", content: "..." }
  │
  ▼
index.js / mcp-http.mjs 파라미터 수신
  │
  ▼
windowManager.createWindow({ windowName: "alarm-001", ... })
  │
  ├── windowName 없음 → 기존 새 창 생성 로직
  └── windowName 있음
        │
        ▼
      getWindowByName("alarm-001")
        │
        ├── 기존 창 없음(또는 소멸됨)
        │     → _createNewWindow() + nameToId.set("alarm-001", id)
        └── 기존 창 존재
              → updateWindow(existingId, params)
              → 응답: "Updated existing window (named: alarm-001)..."
```

### 3.2 Severity 흐름 (FR-19-003)

```
MCP open/update_markdown { severity: "error" }
  │
  ▼
index.js 핸들러
  │
  ▼
entry.win.webContents.send('set-severity', { severity: 'error' })
  │
  ▼
viewer.js: window.doclight.onSetSeverity(({ severity }) => {
  document.body.setAttribute('data-severity', severity ?? '');
})
  │
  ▼
viewer.css: [data-severity="error"] .severity-bar { display: block; background: #ef4444; }
```

### 3.3 Auto-close 흐름 (FR-19-004)

```
MCP open_markdown { autoCloseSeconds: 10 }
  │
  ▼
entry.meta.autoCloseTimer = setTimeout(() => closeWindow(id), 10000)
entry.win.webContents.send('auto-close-start', { seconds: 10 })
  │
  ▼
viewer.js: 카운트다운 interval 시작
  │
  ├── 1초마다: statusBar.textContent = `자동 종료: ${n}초`
  │            n <= 5 → 배경 주황으로 강조
  └── 0초: interval 종료 (main 프로세스가 창 닫음)

수동 닫기 시:
  _onWindowClosed() → clearTimeout(entry.meta.autoCloseTimer)
```

### 3.4 Append 모드 흐름 (FR-19-002)

```
MCP update_markdown { windowId: 42, content: "항목 2", appendMode: true }
  │
  ▼
entry.meta.lastRenderedContent 조회
  │
  ▼
newContent = (lastRenderedContent || '') + separator + content
  │
  ├── 누적 크기 > 10MB → isError 반환
  └── 정상
        → updateWindow(42, { content: newContent })
        → entry.meta.lastRenderedContent = newContent 저장
```

### 3.5 Window Tags 일괄 닫기 흐름 (FR-19-005)

```
MCP close_viewer { tag: "temp" }
  │
  ▼
windows.entries() 순회
  │
  ▼
entry.meta.tags.includes("temp") → closeWindow(id)
  │
  ▼
응답: "Closed N window(s) with tag: temp."
```

## 4. Data Model

### 4.1 WindowManager 전체 상태 (Step 19 이후)

```javascript
class WindowManager {
  windows: Map<number, { win: BrowserWindow, meta: WindowMeta }>
  nameToId: Map<string, number>   // ★ 신규
  lastPosition: { x: number, y: number }
  // ... fileWatchers (Step 18)
}

interface WindowMeta {
  // Step 18 이전
  windowId: number
  title: string
  filePath: string | null
  alwaysOnTop: boolean
  content: string | null
  // Step 18 추가
  imageBasePath: string | null
  // Step 19 추가 ★
  windowName: string | undefined
  tags: string[]
  severity: string | undefined
  autoCloseTimer: ReturnType<typeof setTimeout> | undefined
  progress: number | undefined
  lastRenderedContent: string | undefined
}
```

### 4.2 list_viewers 응답 포맷 (확장)

```
Open viewer windows (2):
  1. [win-42] "오류 보고서" (severity: error) [tags: alarm, critical] (progress: 75%)
  2. [win-43] "진행 상황" (severity: info) [tags: progress]
```

## 5. 파일 변경 매트릭스

| 파일 | P1 | P2 | P3 | P4 | P5 | P6 |
|------|:--:|:--:|:--:|:--:|:--:|:--:|
| `src/main/window-manager.js` | ● | ● | ● | ● | ● |   |
| `src/main/index.js` | ● | ● | ● | ● | ● |   |
| `src/main/mcp-http.mjs` | ● | ● | ● | ● | ● |   |
| `src/main/mcp-server.mjs` | ● | ● | ● | ● | ● |   |
| `src/renderer/viewer.js` | ● |   |   | ● |   |   |
| `src/renderer/viewer.css` | ● |   |   | ● |   |   |
| `src/locales/*.json` (4개) |   |   |   | ● |   |   |
| `CLAUDE.md` |   |   |   |   |   | ● |

P1=Named Window+Severity, P2=Flash+Progress, P3=Tags, P4=Auto-close, P5=Append, P6=통합

## 6. 보안 모델

| 보안 항목 | 구현 방식 | 관련 FR |
|-----------|----------|---------|
| windowName 인젝션 | meta 저장 전 길이 검증(256자), 렌더러 미전송 | FR-19-001 |
| severity 인젝션 | enum 검증 (error/warning/info/success만 허용) | FR-19-003 |
| tags 인젝션 | 개수(10개), 길이(64자) 검증, data-attribute 미사용 | FR-19-005 |
| separator 인젝션 | 렌더러에서 DOMPurify 처리 | FR-19-002 |
| lastRenderedContent | in-memory only, 영속화 없음 | FR-19-002 |
| autoCloseSeconds 범위 | 1~3600 정수 검증 | FR-19-004 |
| progress 범위 | -1 또는 0.0~1.0 검증 | FR-19-007 |
