# Phase 1: Named Window + Severity 테마

## 목표

- FR-19-001: `windowName` 파라미터로 창 upsert 지원 (이름 기반 창 관리)
- FR-19-003: `severity` 파라미터로 창 상단 4px 색상 바 표시

## 선행 조건

- Step 18 코드베이스 완료 상태
- `src/main/window-manager.js` — `WindowManager` 클래스 확인
- `src/main/index.js` — IPC 핸들러 확인
- `src/main/mcp-http.mjs` — TOOLS 스키마 확인
- `src/main/mcp-server.mjs` — Zod 스키마 확인

## 구현 체크리스트

### 1. window-manager.js — Named Window 인프라 (FR-19-001)

- [x] `constructor()` 에 `this.nameToId = new Map()` 추가
- [x] `getWindowByName(windowName)` 메서드 신규 구현:
  - `nameToId.get(name)` 조회
  - 창이 없거나 `entry.win.isDestroyed()` 이면 `nameToId.delete(name)` 후 `null` 반환
  - 유효한 창이면 entry 반환
- [x] `createWindow(opts)` 수정 — windowName upsert 로직:
  - `opts.windowName` 있으면 `getWindowByName()` 호출
  - 기존 창 존재 → `updateWindow(existingId, opts)` 호출 후 `{ windowId, upserted: true }` 반환
  - 기존 창 없음 → `_createNewWindow()` 실행 후 `nameToId.set(windowName, id)` + `meta.windowName = windowName`
- [x] `_onWindowClosed(windowId)` 수정:
  - `entry.meta.windowName` 있으면 `nameToId.delete(entry.meta.windowName)`
- [x] `meta.windowName` 초기값 `undefined` 설정
- [x] `meta.tags` 초기값 `[]` 설정 (Phase 3 준비)

### 2. window-manager.js — Severity 처리 (FR-19-003)

- [x] `createWindow(opts)` 수정 — severity 처리:
  - `opts.severity` 있으면 창 생성 후 `win.webContents.send('set-severity', { severity })`
  - `meta.severity = opts.severity` 저장
- [x] `updateWindow(windowId, opts)` 수정 — severity 처리:
  - `opts.severity !== undefined` 이면 IPC 전송 + meta 갱신
  - `opts.severity === null` 이면 `send('set-severity', { severity: null })` + `meta.severity = undefined`

### 3. index.js — IPC 핸들러 파라미터 확장

- [x] `open` 액션 핸들러:
  - `windowName`, `severity` 파라미터 수신 및 windowManager에 전달
  - `windowName` 길이 256자 초과 시 error 응답
- [x] `update` 액션 핸들러:
  - `severity` 파라미터 수신 및 전달

### 4. mcp-http.mjs — TOOLS 스키마 업데이트

- [x] `open_markdown` tool 의 `inputSchema.properties` 에 추가:
  ```json
  "windowName": { "type": "string", "maxLength": 256, "description": "Named window identifier for upsert" },
  "severity": { "type": "string", "enum": ["error", "warning", "info", "success"], "description": "Top color bar severity" }
  ```
- [x] `update_markdown` tool 에 `severity` 추가 (nullable)
- [x] 핸들러에서 `windowName`, `severity` 파라미터 처리
- [x] 응답 메시지에 windowName 포함 (upsert 시 "Updated existing window (named: X)...")
- [x] `list_viewers` 응답 포맷에 severity 포함

### 5. mcp-server.mjs — Zod 스키마 업데이트

- [x] `open_markdown` Zod 스키마에 `windowName`, `severity` 추가
- [x] `update_markdown` Zod 스키마에 `severity` (nullable) 추가
- [x] 핸들러 로직 동기화

### 6. viewer.js — set-severity IPC 처리 (FR-19-003)

- [x] `window.doclight.onSetSeverity` 또는 `ipcRenderer.on('set-severity', ...)` 수신 핸들러 등록
  - `severity` 값이 있으면 `document.body.setAttribute('data-severity', severity)`
  - `severity` 가 null/빈 문자열이면 `document.body.removeAttribute('data-severity')`

### 7. viewer.css — severity 색상 바 스타일 (FR-19-003)

- [x] `.severity-bar` 요소 스타일 추가:
  ```css
  .severity-bar {
    position: fixed;
    top: 0; left: 0; right: 0;
    height: 4px;
    z-index: 9999;
    display: none;
  }
  ```
- [x] 4가지 severity 색상 규칙:
  - `[data-severity="error"] .severity-bar { display: block; background: #ef4444; }`
  - `[data-severity="warning"] .severity-bar { display: block; background: #f59e0b; }`
  - `[data-severity="info"] .severity-bar { display: block; background: #3b82f6; }`
  - `[data-severity="success"] .severity-bar { display: block; background: #22c55e; }`

### 8. viewer.html — severity-bar 요소 추가

- [x] `<body>` 태그 최상단에 `<div class="severity-bar"></div>` 추가

## 테스트 시나리오

### 정상 케이스 1: Named Window 신규 생성
- **Given**: windowName `"alarm-001"` 인 창이 없음
- **When**: `open_markdown { windowName: "alarm-001", content: "새 알람" }` 호출
- **Then**: 새 창 생성, 응답에 `windowName: "alarm-001"` 포함, `nameToId`에 매핑 추가

### 정상 케이스 2: Named Window upsert
- **Given**: windowName `"alarm-001"` 인 창이 열려 있음
- **When**: `open_markdown { windowName: "alarm-001", content: "갱신된 내용" }` 호출
- **Then**: 새 창 미생성, 기존 창 콘텐츠 교체, 응답에 "Updated existing window" 포함

### 정상 케이스 3: Severity 색상 바 표시
- **Given**: 창이 정상 상태
- **When**: `open_markdown { severity: "error", content: "..." }` 호출
- **Then**: 창 상단 4px 빨간 바 표시 (`data-severity="error"`)

### 정상 케이스 4: Severity null로 제거
- **Given**: severity: "warning" 인 창 (windowId: X)
- **When**: `update_markdown { windowId: X, severity: null }` 호출
- **Then**: 상단 색상 바 사라짐 (`data-severity` 속성 제거)

### 예외 케이스 1: windowName 빈 문자열
- **Given**: `open_markdown { windowName: "", content: "..." }` 호출
- **Then**: windowName 없는 것으로 간주, 새 창 생성

### 예외 케이스 2: windowName 256자 초과
- **Given**: 257자 windowName
- **Then**: isError 응답 반환

### 예외 케이스 3: 잘못된 severity 값
- **Given**: `severity: "critical"` (enum 외)
- **Then**: isError 응답 반환

### 경계값: Named Window 창 닫힘 후 재생성
- **Given**: windowName `"test"` 창이 닫힘
- **When**: `open_markdown { windowName: "test", content: "..." }` 재호출
- **Then**: 새 창 생성 (upsert 아닌 신규), `nameToId` 매핑 재등록

## 회귀테스트 실행 조건

- [x] 기존 `open_markdown` (windowName 없음) 정상 동작
- [x] 기존 `update_markdown` 정상 동작
- [x] `list_viewers` 응답 포맷 하위 호환성 유지
- [x] 기존 창 닫기 동작 정상
