# Phase 2: 인증 API 구현

| 항목 | 내용 |
|------|------|
| **Phase** | 2 |
| **예상 시간** | 6시간 |
| **선행 조건** | Phase 1 완료 |
| **관련 요구사항** | REQ-AUTH-002, REQ-AUTH-004, REQ-AUTH-005 |

---

## 1. 목표 및 범위

### 1.1 목표

- 관리자 인증 API 엔드포인트 구현
- 세션 기반 인증 미들웨어 구현
- 권한 검사 미들웨어 구현

### 1.2 범위

**포함:**
- POST /api/admin/auth (로그인)
- POST /api/admin/logout (로그아웃)
- GET /api/admin/session (세션 확인)
- admin-auth.js 미들웨어

**제외:**
- 파일 조작 API (Phase 3)
- 클라이언트 UI (Phase 4)

---

## 2. 아키텍처 참조

> 참조: [00-1.architecture.md](00-1.architecture.md) - 3.2.1 API 엔드포인트

### 2.1 관련 컴포넌트

```
src/routes/admin-api.js           ← 신규
src/middleware/admin-auth.js      ← 신규
src/controllers/admin/admin-auth-controller.js  ← 신규
```

### 2.2 요청 흐름

```
클라이언트 → admin-api.js → admin-auth.js → admin-auth-controller.js → session-service.js
```

---

## 3. 구현 항목 체크리스트

### 3.1 admin-auth.js 미들웨어

- [ ] **TASK-201**: adminAuth() 미들웨어 구현
  - Cookie 또는 Authorization 헤더에서 토큰 추출
  - session-service.validateSession() 호출
  - req.adminSession에 세션 저장
  - 실패 시 401 반환

- [ ] **TASK-202**: requirePermission(permission) 미들웨어 구현
  - req.adminSession.permissions 확인
  - 권한 없으면 403 반환

### 3.2 admin-auth-controller.js

- [ ] **TASK-203**: login() 핸들러 구현
  - Request: { apiKey: string }
  - session-service.createSession() 호출
  - 성공 시 세션 정보 + Set-Cookie 반환
  - 실패 시 401 반환

- [ ] **TASK-204**: logout() 핸들러 구현
  - 토큰 추출
  - session-service.invalidateSession() 호출
  - Clear-Cookie 반환

- [ ] **TASK-205**: getSession() 핸들러 구현
  - req.adminSession 반환 (토큰 제외)

### 3.3 admin-api.js 라우터

- [ ] **TASK-206**: 라우터 파일 생성
- [ ] **TASK-207**: POST /auth 라우트 연결
- [ ] **TASK-208**: POST /logout 라우트 연결 (adminAuth 필요)
- [ ] **TASK-209**: GET /session 라우트 연결 (adminAuth 필요)

### 3.4 app.js 수정

- [ ] **TASK-210**: cookie-parser 미들웨어 추가
- [ ] **TASK-211**: /api/admin 라우터 마운트
- [ ] **TASK-212**: 서버 시작 시 session cleanup timer 시작

---

## 4. 상세 구현 명세

### 4.1 admin-auth.js

```javascript
// src/middleware/admin-auth.js
const sessionService = require('../services/session-service');

function adminAuth() {
  return (req, res, next) => {
    // 토큰 추출 (Cookie 우선, Header 폴백)
    const token = req.cookies?.doclight_admin_session
               || req.headers.authorization?.replace('Bearer ', '');

    if (!token) {
      return res.status(401).json({
        success: false,
        error: { code: 'UNAUTHORIZED', message: 'No session token provided' }
      });
    }

    const session = sessionService.validateSession(token);
    if (!session) {
      return res.status(401).json({
        success: false,
        error: { code: 'SESSION_EXPIRED', message: 'Session expired or invalid' }
      });
    }

    req.adminSession = session;
    next();
  };
}

function requirePermission(permission) {
  return (req, res, next) => {
    if (!req.adminSession) {
      return res.status(401).json({
        success: false,
        error: { code: 'UNAUTHORIZED', message: 'Not authenticated' }
      });
    }

    if (!req.adminSession.permissions.includes(permission)) {
      return res.status(403).json({
        success: false,
        error: { code: 'FORBIDDEN', message: `Permission "${permission}" required` }
      });
    }

    next();
  };
}

module.exports = { adminAuth, requirePermission };
```

### 4.2 admin-auth-controller.js

```javascript
// src/controllers/admin/admin-auth-controller.js
const sessionService = require('../../services/session-service');

async function login(req, res, next) {
  try {
    const { apiKey } = req.body;
    const config = req.app.locals.config;

    if (!apiKey) {
      return res.status(400).json({
        success: false,
        error: { code: 'MISSING_KEY', message: 'API key is required' }
      });
    }

    const session = sessionService.createSession(apiKey, config);
    if (!session) {
      return res.status(401).json({
        success: false,
        error: { code: 'INVALID_KEY', message: 'Invalid API key' }
      });
    }

    // 쿠키 설정
    const cookieOptions = {
      httpOnly: true,
      secure: config.ssl?.enabled || false,
      sameSite: 'strict',
      maxAge: config.admin?.sessionTimeout || 3600000
    };

    res.cookie('doclight_admin_session', session.token, cookieOptions);

    // 응답 (토큰 포함)
    res.json({
      success: true,
      session: {
        token: session.token,
        name: session.name,
        permissions: session.permissions,
        expiresAt: session.expiresAt
      }
    });
  } catch (error) {
    next(error);
  }
}

async function logout(req, res, next) {
  try {
    const token = req.cookies?.doclight_admin_session
               || req.headers.authorization?.replace('Bearer ', '');

    if (token) {
      sessionService.invalidateSession(token);
    }

    res.clearCookie('doclight_admin_session');
    res.json({ success: true });
  } catch (error) {
    next(error);
  }
}

async function getSession(req, res, next) {
  try {
    const session = req.adminSession;

    res.json({
      success: true,
      session: {
        name: session.name,
        permissions: session.permissions,
        expiresAt: session.expiresAt,
        createdAt: session.createdAt
      }
    });
  } catch (error) {
    next(error);
  }
}

module.exports = { login, logout, getSession };
```

### 4.3 admin-api.js

```javascript
// src/routes/admin-api.js
const express = require('express');
const { adminAuth, requirePermission } = require('../middleware/admin-auth');
const authController = require('../controllers/admin/admin-auth-controller');

const router = express.Router();

// 인증 (공개)
router.post('/auth', authController.login);

// 인증 필요
router.post('/logout', adminAuth(), authController.logout);
router.get('/session', adminAuth(), authController.getSession);

module.exports = router;
```

### 4.4 app.js 수정 사항

```javascript
// 추가 import
const cookieParser = require('cookie-parser');
const adminApiRouter = require('./routes/admin-api');
const sessionService = require('./services/session-service');

// 미들웨어 추가 (express.json() 이후)
app.use(cookieParser());

// 라우터 마운트
app.use('/api/admin', adminApiRouter);

// 서버 시작 시
sessionService.startCleanupTimer();

// 서버 종료 시
sessionService.stopCleanupTimer();
```

---

## 5. 테스트 섹션

### 5.1 테스트 시나리오

#### TC-201: 유효한 API 키로 로그인

```
Given: config에 유효한 apiKey 설정됨
When: POST /api/admin/auth { apiKey: "valid-key" }
Then: 200 응답
And: response.session.token이 64자 hex
And: Set-Cookie 헤더에 doclight_admin_session 포함
```

#### TC-202: 잘못된 API 키로 로그인

```
Given: 잘못된 API 키
When: POST /api/admin/auth { apiKey: "wrong-key" }
Then: 401 응답
And: error.code === "INVALID_KEY"
```

#### TC-203: API 키 누락

```
Given: 요청 본문에 apiKey 없음
When: POST /api/admin/auth {}
Then: 400 응답
And: error.code === "MISSING_KEY"
```

#### TC-204: 유효한 세션으로 세션 확인

```
Given: 로그인 후 세션 토큰 획득
When: GET /api/admin/session (Cookie: doclight_admin_session=xxx)
Then: 200 응답
And: response.session.name 포함
And: response.session.permissions 포함
```

#### TC-205: 만료된 세션으로 세션 확인

```
Given: 만료된 세션 토큰
When: GET /api/admin/session
Then: 401 응답
And: error.code === "SESSION_EXPIRED"
```

#### TC-206: 로그아웃

```
Given: 유효한 세션
When: POST /api/admin/logout
Then: 200 응답
And: Clear-Cookie 헤더 포함
And: 이후 세션 확인 시 401
```

#### TC-207: 권한 검사 (성공)

```
Given: permissions: ["read", "write"] 세션
When: write 권한 필요한 요청
Then: 요청 성공 (다음 미들웨어로 진행)
```

#### TC-208: 권한 검사 (실패)

```
Given: permissions: ["read"] 세션
When: delete 권한 필요한 요청
Then: 403 응답
And: error.code === "FORBIDDEN"
```

### 5.2 테스트 코드 구조

```javascript
// test/test-admin-auth-api.js
const request = require('supertest');
const app = require('../src/app');

describe('Admin Auth API', () => {
  describe('POST /api/admin/auth', () => {
    it('should login with valid API key', async () => { /* TC-201 */ });
    it('should reject invalid API key', async () => { /* TC-202 */ });
    it('should require API key', async () => { /* TC-203 */ });
  });

  describe('GET /api/admin/session', () => {
    it('should return session for valid token', async () => { /* TC-204 */ });
    it('should reject expired token', async () => { /* TC-205 */ });
  });

  describe('POST /api/admin/logout', () => {
    it('should logout and clear session', async () => { /* TC-206 */ });
  });
});
```

```javascript
// test/test-admin-auth-middleware.js
describe('Admin Auth Middleware', () => {
  describe('requirePermission', () => {
    it('should allow with correct permission', () => { /* TC-207 */ });
    it('should deny without permission', () => { /* TC-208 */ });
  });
});
```

### 5.3 테스트 실행 명령

```bash
npm test -- --grep "Admin Auth"
```

---

## 6. 회귀테스트 실행 조건

Phase 2 완료 후 아래 테스트 모두 통과해야 함:

- [ ] Phase 1 테스트 전체
- [ ] 기존 API 테스트 (영향 없음 확인)
- [ ] 신규 Admin Auth API 테스트 전체
- [ ] 신규 Admin Auth 미들웨어 테스트 전체

---

## 7. 완료 조건

- [ ] 모든 구현 항목 체크리스트 완료 (TASK-201 ~ TASK-212)
- [ ] 모든 테스트 시나리오 통과 (TC-201 ~ TC-208)
- [ ] 회귀테스트 100% 통과
- [ ] cookie-parser 의존성 추가 확인

---

*Phase 2 문서 끝*
