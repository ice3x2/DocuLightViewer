# Phase 1: 설정 확장 및 세션 서비스

| 항목 | 내용 |
|------|------|
| **Phase** | 1 |
| **예상 시간** | 7시간 |
| **선행 조건** | 없음 (첫 번째 Phase) |
| **관련 요구사항** | REQ-AUTH-001, REQ-AUTH-003, NFR-SEC-001, NFR-COMPAT-002 |

---

## 1. 목표 및 범위

### 1.1 목표

- config.json5에서 다중 API 키(apiKeys) 지원
- 기존 단일 apiKey와 하위 호환성 유지
- 세션 생성/관리 서비스 구현

### 1.2 범위

**포함:**
- config-loader.js 수정 (apiKeys 배열 파싱, 검증)
- session-service.js 신규 생성
- 관리자 설정(admin) 섹션 추가

**제외:**
- API 엔드포인트 (Phase 2)
- 클라이언트 UI (Phase 4)

---

## 2. 아키텍처 참조

> 참조: [00-1.architecture.md](00-1.architecture.md) - 3.2 설정 확장

### 2.1 관련 컴포넌트

```
src/utils/config-loader.js  ← 수정
src/services/session-service.js  ← 신규
```

### 2.2 데이터 흐름

```
config.json5 → config-loader.js → { apiKeys, admin } → session-service.js
```

---

## 3. 구현 항목 체크리스트

### 3.1 config-loader.js 수정

- [ ] **TASK-101**: apiKeys 배열 스키마 정의
  ```javascript
  apiKeys: [
    { key: string, name: string, permissions: string[] }
  ]
  ```

- [ ] **TASK-102**: normalizeApiKeys() 함수 구현
  - 기존 apiKey만 있으면 apiKeys 배열로 변환
  - 기본 권한: ["read", "write", "delete"]
  - 기본 이름: "Default Admin"

- [ ] **TASK-103**: apiKeys 검증 로직 추가
  - 빈 key 체크
  - permissions 값 검증 (read, write, delete만 허용)
  - 중복 key 체크

- [ ] **TASK-104**: admin 설정 섹션 추가
  ```javascript
  admin: {
    sessionTimeout: 3600000,  // 기본 1시간
    allowUpload: true,
    allowDelete: true,
    maxUploadSize: 10,  // MB
    editableExtensions: [".md", ".txt", ".json", ".json5", ".yaml", ".yml"],
    maxEditableSize: 1048576  // 1MB
  }
  ```

- [ ] **TASK-105**: admin 설정 기본값 적용

### 3.2 session-service.js 신규 생성

- [ ] **TASK-106**: Session 클래스/객체 정의
  ```javascript
  {
    token: string,      // 64자 hex
    name: string,       // API 키 이름
    permissions: [],    // 권한 배열
    createdAt: number,
    expiresAt: number,
    lastAccessedAt: number
  }
  ```

- [ ] **TASK-107**: generateToken() 함수 구현
  - crypto.randomBytes(32).toString('hex')
  - 64자 hex 문자열 반환

- [ ] **TASK-108**: createSession(apiKey, config) 함수 구현
  - apiKeys에서 일치하는 키 찾기
  - Session 객체 생성
  - sessions Map에 저장
  - Session 반환 (또는 null)

- [ ] **TASK-109**: validateSession(token) 함수 구현
  - sessions Map에서 토큰 조회
  - 만료 시간 체크
  - lastAccessedAt 갱신
  - Session 반환 (또는 null)

- [ ] **TASK-110**: invalidateSession(token) 함수 구현
  - sessions Map에서 삭제
  - boolean 반환

- [ ] **TASK-111**: cleanup() 함수 구현
  - 만료된 세션 모두 삭제
  - 삭제된 세션 수 반환

- [ ] **TASK-112**: startCleanupTimer(intervalMs) 함수 구현
  - setInterval로 cleanup() 주기 실행
  - 기본 1분 (60000ms)

- [ ] **TASK-113**: stopCleanupTimer() 함수 구현
  - clearInterval

### 3.3 config.example.json5 업데이트

- [ ] **TASK-114**: apiKeys 예시 추가
- [ ] **TASK-115**: admin 섹션 예시 추가
- [ ] **TASK-116**: 주석 설명 추가

---

## 4. 상세 구현 명세

### 4.1 config-loader.js 수정 사항

```javascript
// 기존 loadConfig() 함수 내부에 추가

// apiKeys 정규화
config = normalizeApiKeys(config);

// admin 기본값 설정
config.admin = {
  sessionTimeout: 3600000,
  allowUpload: true,
  allowDelete: true,
  maxUploadSize: 10,
  editableExtensions: ['.md', '.txt', '.json', '.json5', '.yaml', '.yml'],
  maxEditableSize: 1048576,
  ...config.admin
};

// apiKeys 검증
validateApiKeys(config.apiKeys);

// 신규 함수들
function normalizeApiKeys(config) {
  if (config.apiKey && !config.apiKeys) {
    config.apiKeys = [{
      key: config.apiKey,
      name: 'Default Admin',
      permissions: ['read', 'write', 'delete']
    }];
  }
  return config;
}

function validateApiKeys(apiKeys) {
  if (!apiKeys || !Array.isArray(apiKeys) || apiKeys.length === 0) {
    throw new Error('INVALID_CONFIG: At least one API key required');
  }

  const validPermissions = ['read', 'write', 'delete'];
  const seenKeys = new Set();

  for (const keyConfig of apiKeys) {
    if (!keyConfig.key || typeof keyConfig.key !== 'string') {
      throw new Error('INVALID_CONFIG: API key must be a non-empty string');
    }

    if (seenKeys.has(keyConfig.key)) {
      throw new Error('INVALID_CONFIG: Duplicate API key found');
    }
    seenKeys.add(keyConfig.key);

    if (keyConfig.permissions) {
      for (const perm of keyConfig.permissions) {
        if (!validPermissions.includes(perm)) {
          throw new Error(`INVALID_CONFIG: Invalid permission "${perm}"`);
        }
      }
    }
  }
}
```

### 4.2 session-service.js 전체 구현

```javascript
// src/services/session-service.js
const crypto = require('crypto');

const sessions = new Map();
let cleanupTimer = null;

function generateToken() {
  return crypto.randomBytes(32).toString('hex');
}

function findApiKeyConfig(apiKey, config) {
  if (!config.apiKeys) return null;
  return config.apiKeys.find(k => k.key === apiKey) || null;
}

function createSession(apiKey, config) {
  const keyConfig = findApiKeyConfig(apiKey, config);
  if (!keyConfig) return null;

  const now = Date.now();
  const timeout = config.admin?.sessionTimeout || 3600000;

  const session = {
    token: generateToken(),
    name: keyConfig.name || 'Unknown',
    permissions: keyConfig.permissions || ['read'],
    createdAt: now,
    expiresAt: now + timeout,
    lastAccessedAt: now
  };

  sessions.set(session.token, session);
  return session;
}

function validateSession(token) {
  if (!token) return null;

  const session = sessions.get(token);
  if (!session) return null;

  if (session.expiresAt < Date.now()) {
    sessions.delete(token);
    return null;
  }

  session.lastAccessedAt = Date.now();
  return session;
}

function invalidateSession(token) {
  return sessions.delete(token);
}

function getSession(token) {
  return sessions.get(token) || null;
}

function cleanup() {
  const now = Date.now();
  let count = 0;

  for (const [token, session] of sessions) {
    if (session.expiresAt < now) {
      sessions.delete(token);
      count++;
    }
  }

  return count;
}

function startCleanupTimer(intervalMs = 60000) {
  if (cleanupTimer) clearInterval(cleanupTimer);
  cleanupTimer = setInterval(cleanup, intervalMs);
}

function stopCleanupTimer() {
  if (cleanupTimer) {
    clearInterval(cleanupTimer);
    cleanupTimer = null;
  }
}

// 테스트용
function _getSessionCount() {
  return sessions.size;
}

function _clearAllSessions() {
  sessions.clear();
}

module.exports = {
  createSession,
  validateSession,
  invalidateSession,
  getSession,
  cleanup,
  startCleanupTimer,
  stopCleanupTimer,
  _getSessionCount,
  _clearAllSessions
};
```

---

## 5. 테스트 섹션

### 5.1 테스트 시나리오

#### TC-101: apiKeys 정규화 (하위 호환)

```
Given: config.json5에 apiKey만 설정됨 (기존 방식)
When: loadConfig() 호출
Then: config.apiKeys 배열이 생성됨
And: apiKeys[0].key === config.apiKey
And: apiKeys[0].permissions === ['read', 'write', 'delete']
```

#### TC-102: apiKeys 직접 설정

```
Given: config.json5에 apiKeys 배열 설정됨
When: loadConfig() 호출
Then: config.apiKeys가 그대로 유지됨
And: 각 key의 permissions가 검증됨
```

#### TC-103: 잘못된 apiKeys 검증

```
Given: config.json5에 빈 key 포함
When: loadConfig() 호출
Then: INVALID_CONFIG 에러 발생
```

#### TC-104: 세션 생성

```
Given: 유효한 API 키
When: createSession(apiKey, config) 호출
Then: Session 객체 반환
And: token이 64자 hex 문자열
And: sessions Map에 저장됨
```

#### TC-105: 잘못된 API 키로 세션 생성

```
Given: 잘못된 API 키
When: createSession(apiKey, config) 호출
Then: null 반환
```

#### TC-106: 세션 검증 (유효)

```
Given: 생성된 세션 토큰
When: validateSession(token) 호출
Then: Session 객체 반환
And: lastAccessedAt 갱신됨
```

#### TC-107: 세션 검증 (만료)

```
Given: 만료된 세션 토큰
When: validateSession(token) 호출
Then: null 반환
And: sessions Map에서 삭제됨
```

#### TC-108: 세션 무효화

```
Given: 유효한 세션 토큰
When: invalidateSession(token) 호출
Then: true 반환
And: sessions Map에서 삭제됨
```

#### TC-109: 세션 정리

```
Given: 만료된 세션 3개, 유효한 세션 2개
When: cleanup() 호출
Then: 3 반환 (삭제된 세션 수)
And: sessions.size === 2
```

### 5.2 테스트 코드 구조

```javascript
// test/test-session-service.js
const assert = require('assert');
const sessionService = require('../src/services/session-service');

describe('SessionService', () => {
  beforeEach(() => {
    sessionService._clearAllSessions();
  });

  describe('createSession', () => {
    it('should create session for valid API key', () => { /* TC-104 */ });
    it('should return null for invalid API key', () => { /* TC-105 */ });
  });

  describe('validateSession', () => {
    it('should return session for valid token', () => { /* TC-106 */ });
    it('should return null for expired token', () => { /* TC-107 */ });
  });

  describe('invalidateSession', () => {
    it('should delete session', () => { /* TC-108 */ });
  });

  describe('cleanup', () => {
    it('should remove expired sessions', () => { /* TC-109 */ });
  });
});
```

```javascript
// test/test-config-loader-apikeys.js
const assert = require('assert');

describe('Config Loader - apiKeys', () => {
  it('should normalize single apiKey to apiKeys array', () => { /* TC-101 */ });
  it('should keep apiKeys array as-is', () => { /* TC-102 */ });
  it('should throw for invalid apiKeys', () => { /* TC-103 */ });
});
```

### 5.3 테스트 실행 명령

```bash
# 단위 테스트
npm test -- --grep "SessionService"
npm test -- --grep "Config Loader - apiKeys"

# 전체 회귀테스트
npm test
```

---

## 6. 회귀테스트 실행 조건

Phase 1 완료 후 아래 테스트 모두 통과해야 함:

- [ ] 기존 config-loader 테스트 (config.example.json5 로드)
- [ ] 기존 API 테스트 (X-API-Key 인증)
- [ ] 신규 session-service 테스트 전체
- [ ] 신규 apiKeys 검증 테스트 전체

---

## 7. 완료 조건

- [ ] 모든 구현 항목 체크리스트 완료 (TASK-101 ~ TASK-116)
- [ ] 모든 테스트 시나리오 통과 (TC-101 ~ TC-109)
- [ ] 회귀테스트 100% 통과
- [ ] 코드 리뷰 완료

---

*Phase 1 문서 끝*
