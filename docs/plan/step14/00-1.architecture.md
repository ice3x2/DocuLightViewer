# Admin Mode 아키텍처 설계

| 항목 | 내용 |
|------|------|
| **문서 버전** | 1.0.0 |
| **작성일** | 2026-01-06 |
| **관련 스펙** | plan.step14.md |
| **상태** | 설계 완료 |

---

## 1. 시스템 컨텍스트

### 1.1 컨텍스트 다이어그램

```
┌─────────────────────────────────────────────────────────────────────┐
│                           브라우저                                   │
│  ┌───────────────────┐          ┌───────────────────────────────┐  │
│  │   일반 모드       │          │        관리자 모드             │  │
│  │   (읽기 전용)     │          │  (파일/폴더 CRUD, 편집)        │  │
│  │   /              │          │  /admin/*                      │  │
│  └─────────┬─────────┘          └──────────────┬────────────────┘  │
│            │                                    │                   │
└────────────┼────────────────────────────────────┼───────────────────┘
             │                                    │
             │ GET /api/tree, /api/raw            │ POST /api/admin/auth
             │                                    │ GET/PUT/DELETE /api/admin/*
             ▼                                    ▼
┌─────────────────────────────────────────────────────────────────────┐
│                        DocLight Server                              │
│  ┌─────────────────┐    ┌─────────────────┐    ┌─────────────────┐ │
│  │  Public API     │    │  Admin API      │    │  Static Files   │ │
│  │  (기존)         │    │  (신규)         │    │  (CSS/JS/EJS)   │ │
│  └────────┬────────┘    └────────┬────────┘    └─────────────────┘ │
│           │                      │                                  │
│           ▼                      ▼                                  │
│  ┌─────────────────────────────────────────────────────────────┐   │
│  │                      Services Layer                          │   │
│  │  tree-service │ file-service │ session-service (신규)        │   │
│  └──────────────────────────────┬──────────────────────────────┘   │
│                                 │                                   │
│                                 ▼                                   │
│  ┌─────────────────────────────────────────────────────────────┐   │
│  │                    File System (docsRoot)                    │   │
│  └─────────────────────────────────────────────────────────────┘   │
└─────────────────────────────────────────────────────────────────────┘
```

### 1.2 인증 흐름

```
사용자                    브라우저                     서버
  │                         │                          │
  │ /admin 접속             │                          │
  ├────────────────────────►│                          │
  │                         │ GET /admin               │
  │                         ├─────────────────────────►│
  │                         │                          │ 세션 확인
  │                         │ 401 + admin.ejs          │
  │                         │◄─────────────────────────┤
  │     인증 모달 표시       │                          │
  │◄────────────────────────┤                          │
  │                         │                          │
  │ API Key 입력            │                          │
  ├────────────────────────►│                          │
  │                         │ POST /api/admin/auth     │
  │                         │ {apiKey: "xxx"}          │
  │                         ├─────────────────────────►│
  │                         │                          │ 키 검증
  │                         │                          │ 세션 생성
  │                         │ 200 + Set-Cookie         │
  │                         │ {session: {...}}         │
  │                         │◄─────────────────────────┤
  │     세션 저장, UI 로드   │                          │
  │◄────────────────────────┤                          │
  │                         │                          │
  │ 파일 작업 요청           │                          │
  ├────────────────────────►│                          │
  │                         │ PUT /api/admin/content   │
  │                         │ Cookie: session=xxx      │
  │                         ├─────────────────────────►│
  │                         │                          │ 세션 검증
  │                         │                          │ 권한 확인
  │                         │                          │ 작업 수행
  │                         │ 200 {success: true}      │
  │                         │◄─────────────────────────┤
```

---

## 2. 컴포넌트 다이어그램

### 2.1 백엔드 컴포넌트

```
┌─────────────────────────────────────────────────────────────────────────┐
│                              Routes                                      │
│  ┌──────────────┐   ┌──────────────────┐   ┌──────────────────────────┐ │
│  │  api.js      │   │  admin-api.js    │   │  mcp.js, context-mcp.js  │ │
│  │  (기존 API)  │   │  (Admin API)     │   │  (기존 MCP)              │ │
│  └──────┬───────┘   └────────┬─────────┘   └──────────────────────────┘ │
│         │                    │                                           │
└─────────┼────────────────────┼───────────────────────────────────────────┘
          │                    │
          ▼                    ▼
┌─────────────────────────────────────────────────────────────────────────┐
│                            Middleware                                    │
│  ┌──────────────┐   ┌──────────────────┐   ┌──────────────────────────┐ │
│  │  auth.js     │   │  admin-auth.js   │   │  error-handler.js        │ │
│  │  (API Key)   │   │  (Session Auth)  │   │  (기존)                  │ │
│  └──────────────┘   └──────────────────┘   └──────────────────────────┘ │
└─────────────────────────────────────────────────────────────────────────┘
          │                    │
          ▼                    ▼
┌─────────────────────────────────────────────────────────────────────────┐
│                           Controllers                                    │
│  ┌──────────────────────────────────────────────────────────────────┐   │
│  │  admin-auth-controller.js   │ 인증/로그아웃/세션 확인              │   │
│  │  admin-tree-controller.js   │ 전체 파일 트리 (모든 확장자)         │   │
│  │  admin-file-controller.js   │ 파일 CRUD (읽기/쓰기/생성/삭제)      │   │
│  │  admin-move-controller.js   │ 파일/폴더 이동, 이름 변경            │   │
│  └──────────────────────────────────────────────────────────────────┘   │
└─────────────────────────────────────────────────────────────────────────┘
          │                    │
          ▼                    ▼
┌─────────────────────────────────────────────────────────────────────────┐
│                            Services                                      │
│  ┌──────────────────────────────────────────────────────────────────┐   │
│  │  session-service.js     │ 세션 생성/검증/만료/정리 (신규)         │   │
│  │  tree-service.js        │ 트리 생성 (기존, 확장)                  │   │
│  │  file-service.js        │ 파일 I/O (기존, 확장)                   │   │
│  └──────────────────────────────────────────────────────────────────┘   │
└─────────────────────────────────────────────────────────────────────────┘
          │
          ▼
┌─────────────────────────────────────────────────────────────────────────┐
│                             Utils                                        │
│  ┌──────────────────────────────────────────────────────────────────┐   │
│  │  config-loader.js   │ apiKeys 배열 지원 (수정)                    │   │
│  │  path-validator.js  │ 경로 검증 (기존)                            │   │
│  │  lock-manager.js    │ 동시성 제어 (기존)                          │   │
│  └──────────────────────────────────────────────────────────────────┘   │
└─────────────────────────────────────────────────────────────────────────┘
```

### 2.2 프론트엔드 컴포넌트

```
┌─────────────────────────────────────────────────────────────────────────┐
│                           admin.js (신규)                                │
│  ┌───────────────────────────────────────────────────────────────────┐  │
│  │                         AdminApp (메인)                            │  │
│  │  - 상태 관리 (AdminState)                                          │  │
│  │  - 라우팅 (/admin/*)                                               │  │
│  │  - 이벤트 바인딩                                                    │  │
│  └───────────────────────────────────────────────────────────────────┘  │
│                                    │                                     │
│         ┌──────────────────────────┼──────────────────────────┐         │
│         │                          │                          │         │
│         ▼                          ▼                          ▼         │
│  ┌──────────────┐   ┌──────────────────────┐   ┌──────────────────┐    │
│  │ AuthModule   │   │    TreeModule        │   │  EditorModule    │    │
│  │ - 인증 모달  │   │ - 파일 트리 렌더링   │   │ - 파일 편집기    │    │
│  │ - 로그인     │   │ - 선택 관리          │   │ - 저장/미리보기  │    │
│  │ - 로그아웃   │   │ - 드래그앤드롭       │   │ - Dirty 상태     │    │
│  └──────────────┘   │ - 컨텍스트 메뉴      │   └──────────────────┘    │
│                     └──────────────────────┘                            │
│                                    │                                     │
│         ┌──────────────────────────┼──────────────────────────┐         │
│         │                          │                          │         │
│         ▼                          ▼                          ▼         │
│  ┌──────────────┐   ┌──────────────────────┐   ┌──────────────────┐    │
│  │ ContextMenu  │   │    ModalManager      │   │  APIClient       │    │
│  │ - 메뉴 표시  │   │ - 모달 스택 관리     │   │ - 인증 API       │    │
│  │ - 작업 실행  │   │ - 확인/경고 다이얼로그│   │ - 파일 API       │    │
│  └──────────────┘   └──────────────────────┘   └──────────────────┘    │
└─────────────────────────────────────────────────────────────────────────┘
```

---

## 3. 클래스 다이어그램

### 3.1 세션 관리 (session-service.js)

```
┌─────────────────────────────────────────────────────────────────────┐
│                          SessionService                              │
├─────────────────────────────────────────────────────────────────────┤
│ - sessions: Map<token, Session>                                      │
│ - cleanupInterval: NodeJS.Timer                                      │
├─────────────────────────────────────────────────────────────────────┤
│ + createSession(apiKey, config): Session                             │
│ + validateSession(token): Session | null                             │
│ + invalidateSession(token): boolean                                  │
│ + getSession(token): Session | null                                  │
│ + cleanup(): void                                                    │
│ + startCleanupTimer(intervalMs): void                                │
│ + stopCleanupTimer(): void                                           │
│ - generateToken(): string                                            │
│ - findApiKeyConfig(apiKey, config): ApiKeyConfig | null              │
└─────────────────────────────────────────────────────────────────────┘
                              │
                              │ creates
                              ▼
┌─────────────────────────────────────────────────────────────────────┐
│                            Session                                   │
├─────────────────────────────────────────────────────────────────────┤
│ + token: string           // crypto.randomBytes(32).toString('hex')  │
│ + name: string            // API 키 이름 (config에서)                │
│ + permissions: string[]   // ['read', 'write', 'delete']             │
│ + createdAt: number       // Date.now()                              │
│ + expiresAt: number       // createdAt + timeout                     │
│ + lastAccessedAt: number  // 마지막 접근 시간                         │
├─────────────────────────────────────────────────────────────────────┤
│ + isExpired(): boolean                                               │
│ + hasPermission(perm: string): boolean                               │
│ + refresh(): void         // lastAccessedAt 갱신                     │
└─────────────────────────────────────────────────────────────────────┘
```

### 3.2 설정 확장 (config-loader.js 수정)

```
┌─────────────────────────────────────────────────────────────────────┐
│                           Config (기존)                              │
├─────────────────────────────────────────────────────────────────────┤
│ + docsRoot: string                                                   │
│ + apiKey: string            // 하위 호환 (단일 키)                   │
│ + apiKeys: ApiKeyConfig[]   // 신규 (다중 키)                        │
│ + port: number                                                       │
│ + maxUploadMB: number                                                │
│ + excludes: string[]                                                 │
│ + logDir: string                                                     │
│ + logLevel: string                                                   │
│ + ui: UIConfig                                                       │
│ + security: SecurityConfig                                           │
│ + ssl: SSLConfig                                                     │
│ + hotReload: HotReloadConfig                                         │
│ + cache: CacheConfig                                                 │
│ + admin: AdminConfig        // 신규                                  │
└─────────────────────────────────────────────────────────────────────┘
                              │
        ┌─────────────────────┴─────────────────────┐
        │                                           │
        ▼                                           ▼
┌─────────────────────────────┐   ┌─────────────────────────────────────┐
│      ApiKeyConfig (신규)    │   │         AdminConfig (신규)           │
├─────────────────────────────┤   ├─────────────────────────────────────┤
│ + key: string               │   │ + sessionTimeout: number            │
│ + name: string              │   │   (기본: 3600000, 1시간)             │
│ + permissions: string[]     │   │ + allowUpload: boolean              │
│   ['read','write','delete'] │   │ + allowDelete: boolean              │
└─────────────────────────────┘   │ + maxUploadSize: number (MB)        │
                                  │ + editableExtensions: string[]      │
                                  │ + maxEditableSize: number (bytes)   │
                                  └─────────────────────────────────────┘
```

### 3.3 클라이언트 상태 (admin.js)

```
┌─────────────────────────────────────────────────────────────────────┐
│                          AdminState                                  │
├─────────────────────────────────────────────────────────────────────┤
│ // 인증 상태                                                         │
│ + isAuthenticated: boolean                                           │
│ + session: Session | null                                            │
│                                                                      │
│ // 파일 트리                                                         │
│ + fileTree: TreeNode[]                                               │
│ + expandedPaths: Set<string>                                         │
│                                                                      │
│ // 선택 상태                                                         │
│ + selectedPaths: string[]                                            │
│ + lastSelectedPath: string | null                                    │
│ + lastSelectedIndex: number | null  // Shift 선택용                  │
│                                                                      │
│ // 편집 상태                                                         │
│ + editMode: boolean                                                  │
│ + editingFile: EditingFile | null                                    │
│ + isDirty: boolean                                                   │
│                                                                      │
│ // 클립보드                                                          │
│ + clipboard: Clipboard | null                                        │
│                                                                      │
│ // 드래그앤드롭                                                      │
│ + dragSource: string | null                                          │
│ + dropTarget: string | null                                          │
│ + isDragging: boolean                                                │
│                                                                      │
│ // UI 상태                                                           │
│ + contextMenu: ContextMenuState | null                               │
│ + activeModal: string | null                                         │
│ + isLoading: boolean                                                 │
└─────────────────────────────────────────────────────────────────────┘
                              │
        ┌─────────────────────┼─────────────────────┐
        │                     │                     │
        ▼                     ▼                     ▼
┌───────────────┐   ┌───────────────────┐   ┌─────────────────┐
│  TreeNode     │   │   EditingFile     │   │   Clipboard     │
├───────────────┤   ├───────────────────┤   ├─────────────────┤
│ name: string  │   │ path: string      │   │ operation: enum │
│ path: string  │   │ originalContent   │   │  'cut' | 'copy' │
│ type: enum    │   │ currentContent    │   │ paths: string[] │
│  'directory'  │   │ modifiedAt: Date  │   └─────────────────┘
│  'file'       │   └───────────────────┘
│ extension?    │
│ size?: number │
│ modifiedAt?   │
│ children?: [] │
└───────────────┘
```

---

## 4. 시퀀스 다이어그램

### 4.1 파일 편집 → 저장 플로우

```
사용자          admin.js         AdminAPI        SessionService    FileService
  │                │                │                 │                │
  │ 파일 클릭       │                │                 │                │
  ├───────────────►│                │                 │                │
  │                │ GET /admin/content?path=/doc.md  │                │
  │                ├───────────────►│                 │                │
  │                │                │ validateSession │                │
  │                │                ├────────────────►│                │
  │                │                │    Session      │                │
  │                │                │◄────────────────┤                │
  │                │                │ hasPermission('read')            │
  │                │                │                 │                │
  │                │                │ getRawContent   │                │
  │                │                ├────────────────────────────────►│
  │                │                │   content       │                │
  │                │                │◄────────────────────────────────┤
  │                │  {content, modifiedAt}           │                │
  │                │◄───────────────┤                 │                │
  │ 내용 표시      │                │                 │                │
  │◄───────────────┤                │                 │                │
  │                │                │                 │                │
  │ 텍스트 수정    │                │                 │                │
  ├───────────────►│                │                 │                │
  │                │ isDirty=true   │                 │                │
  │                │ [●] 표시       │                 │                │
  │◄───────────────┤                │                 │                │
  │                │                │                 │                │
  │ Ctrl+S / 저장  │                │                 │                │
  ├───────────────►│                │                 │                │
  │                │ PUT /admin/content               │                │
  │                │ {path, content, originalModifiedAt}               │
  │                ├───────────────►│                 │                │
  │                │                │ validateSession │                │
  │                │                ├────────────────►│                │
  │                │                │ hasPermission('write')           │
  │                │                │                 │                │
  │                │                │ checkModifiedAt │                │
  │                │                ├────────────────────────────────►│
  │                │                │                 │                │
  │                │                │ writeFile       │                │
  │                │                ├────────────────────────────────►│
  │                │                │   {modifiedAt}  │                │
  │                │                │◄────────────────────────────────┤
  │                │  200 {success, modifiedAt}       │                │
  │                │◄───────────────┤                 │                │
  │                │ isDirty=false  │                 │                │
  │ 저장 완료 표시 │                │                 │                │
  │◄───────────────┤                │                 │                │
```

### 4.2 드래그앤드롭 이동 플로우

```
사용자          admin.js         AdminAPI        FileService      FileSystem
  │                │                │                │                │
  │ 드래그 시작    │                │                │                │
  │ (file1.md)     │                │                │                │
  ├───────────────►│                │                │                │
  │                │ dragSource =   │                │                │
  │                │ '/folder1/file1.md'             │                │
  │                │ isDragging=true│                │                │
  │◄───────────────┤                │                │                │
  │                │                │                │                │
  │ 드래그 이동    │                │                │                │
  │ (folder2 위)   │                │                │                │
  ├───────────────►│                │                │                │
  │                │ dropTarget =   │                │                │
  │                │ '/folder2'     │                │                │
  │                │ 하이라이트 표시│                │                │
  │◄───────────────┤                │                │                │
  │                │                │                │                │
  │ 드롭           │                │                │                │
  ├───────────────►│                │                │                │
  │                │ 검증: 자기 하위로 이동 불가     │                │
  │                │                │                │                │
  │                │ PUT /admin/move                 │                │
  │                │ {sourcePaths:['/folder1/file1.md'],              │
  │                │  targetDirectory:'/folder2'}    │                │
  │                ├───────────────►│                │                │
  │                │                │ validatePaths  │                │
  │                │                ├───────────────►│                │
  │                │                │                │                │
  │                │                │ moveFile       │                │
  │                │                ├───────────────►│                │
  │                │                │                │ fs.rename()    │
  │                │                │                ├───────────────►│
  │                │                │                │◄───────────────┤
  │                │                │◄───────────────┤                │
  │                │ 200 {moved:[{from,to}]}         │                │
  │                │◄───────────────┤                │                │
  │                │ 트리 새로고침  │                │                │
  │                │ dragSource=null│                │                │
  │ 이동 완료 표시 │                │                │                │
  │◄───────────────┤                │                │                │
```

### 4.3 미저장 경고 플로우

```
사용자          admin.js         ModalManager
  │                │                │
  │ 파일 A 편집 중  │                │
  │ (isDirty=true) │                │
  │                │                │
  │ 파일 B 클릭    │                │
  ├───────────────►│                │
  │                │ isDirty 확인   │
  │                │ true → 모달 표시                │
  │                ├───────────────►│
  │   ┌─────────────────────────────┤
  │   │  ⚠️ Unsaved Changes        │
  │   │  You have unsaved changes  │
  │   │  in /path/to/fileA.md     │
  │   │                            │
  │   │ [Cancel] [Discard] [Save]  │
  │   └─────────────────────────────┤
  │◄───────────────────────────────│
  │                │                │
  │ [Save] 클릭    │                │
  ├───────────────►│                │
  │                │ closeModal     │
  │                ├───────────────►│
  │                │◄───────────────┤
  │                │                │
  │                │ saveFile(fileA)│
  │                │ ... (저장 플로우)
  │                │                │
  │                │ loadFile(fileB)│
  │                │ ... (로드 플로우)
  │◄───────────────┤                │
```

---

## 5. 데이터 모델

### 5.1 설정 파일 스키마 (config.json5)

```json5
{
  // 기존 설정 (하위 호환)
  "docsRoot": "/path/to/docs",
  "apiKey": "legacy-single-key",  // 단일 키 (하위 호환)
  "port": 3000,
  // ... 기존 설정들

  // 신규: 다중 API 키
  "apiKeys": [
    {
      "key": "admin-key-abc123",
      "name": "Super Admin",
      "permissions": ["read", "write", "delete"]
    },
    {
      "key": "editor-key-def456",
      "name": "Editor",
      "permissions": ["read", "write"]
    },
    {
      "key": "viewer-key-ghi789",
      "name": "Viewer",
      "permissions": ["read"]
    }
  ],

  // 신규: 관리자 모드 설정
  "admin": {
    "sessionTimeout": 3600000,  // 1시간 (ms)
    "allowUpload": true,
    "allowDelete": true,
    "maxUploadSize": 10,  // MB
    "editableExtensions": [".md", ".txt", ".json", ".json5", ".yaml", ".yml"],
    "maxEditableSize": 1048576  // 1MB
  }
}
```

### 5.2 API 요청/응답 스키마

#### POST /api/admin/auth

```typescript
// Request
interface AuthRequest {
  apiKey: string;
}

// Response (성공)
interface AuthResponse {
  success: true;
  session: {
    token: string;        // 64자 hex
    name: string;         // API 키 이름
    permissions: string[]; // ['read', 'write', 'delete']
    expiresAt: number;    // Unix timestamp (ms)
  };
}

// Response (실패)
interface AuthErrorResponse {
  success: false;
  error: {
    code: 'INVALID_KEY' | 'MISSING_KEY';
    message: string;
  };
}
```

#### GET /api/admin/tree

```typescript
// Response
interface TreeResponse {
  success: true;
  tree: TreeNode[];
}

interface TreeNode {
  name: string;
  path: string;
  type: 'directory' | 'file';
  extension?: string;     // 파일인 경우
  size?: number;          // 파일인 경우 (bytes)
  modifiedAt?: string;    // ISO 8601
  children?: TreeNode[];  // 디렉토리인 경우
}
```

#### PUT /api/admin/content

```typescript
// Request
interface SaveContentRequest {
  path: string;
  content: string;
  originalModifiedAt?: string;  // 동시 편집 충돌 감지
}

// Response (성공)
interface SaveContentResponse {
  success: true;
  path: string;
  size: number;
  modifiedAt: string;
}

// Response (충돌)
interface ConflictResponse {
  success: false;
  error: {
    code: 'CONFLICT';
    message: string;
    serverModifiedAt: string;
  };
}
```

#### PUT /api/admin/move

```typescript
// Request
interface MoveRequest {
  sourcePaths: string[];
  targetDirectory: string;
}

// Response
interface MoveResponse {
  success: true;
  moved: Array<{
    from: string;
    to: string;
  }>;
  errors?: Array<{
    path: string;
    error: string;
  }>;
}
```

### 5.3 세션 저장소 (메모리)

```javascript
// Map<token, Session>
const sessions = new Map();

// Session 구조
{
  token: "a1b2c3d4...",        // 64자 hex
  name: "Admin 1",
  permissions: ["read", "write", "delete"],
  createdAt: 1704520800000,
  expiresAt: 1704524400000,
  lastAccessedAt: 1704521000000
}
```

---

## 6. 패키지 구조

### 6.1 디렉토리 구조

```
src/
├── routes/
│   ├── api.js                    # 기존 API (수정 없음)
│   ├── admin-api.js              # 관리자 API (신규)
│   ├── mcp.js                    # 기존 MCP (수정 없음)
│   └── context-mcp.js            # 기존 Context MCP (수정 없음)
│
├── controllers/
│   ├── admin/                    # 관리자 컨트롤러 (신규 디렉토리)
│   │   ├── admin-auth-controller.js
│   │   ├── admin-tree-controller.js
│   │   ├── admin-file-controller.js
│   │   └── admin-move-controller.js
│   └── ... (기존 컨트롤러)
│
├── middleware/
│   ├── auth.js                   # 기존 API 키 인증 (수정 없음)
│   ├── admin-auth.js             # 관리자 세션 인증 (신규)
│   └── ... (기존 미들웨어)
│
├── services/
│   ├── session-service.js        # 세션 관리 (신규)
│   ├── tree-service.js           # 트리 서비스 (확장)
│   ├── file-service.js           # 파일 서비스 (확장)
│   └── ... (기존 서비스)
│
├── utils/
│   ├── config-loader.js          # 설정 로더 (수정 - apiKeys 지원)
│   └── ... (기존 유틸)
│
├── views/
│   ├── index.ejs                 # 기존 일반 모드 (수정 없음)
│   └── admin.ejs                 # 관리자 모드 (신규)
│
└── app.js                        # 진입점 (수정 - admin 라우트 추가)

public/
├── js/
│   ├── app.js                    # 기존 일반 모드 (수정 없음)
│   └── admin.js                  # 관리자 모드 (신규)
│
├── css/
│   ├── style.css                 # 기존 스타일 (수정 없음)
│   └── admin.css                 # 관리자 스타일 (신규)
│
└── ... (기존 정적 파일)
```

### 6.2 파일별 책임

| 파일 | 책임 | 의존성 |
|------|------|--------|
| `admin-api.js` | 라우트 정의, 미들웨어 연결 | admin-auth.js, controllers/* |
| `admin-auth.js` | 세션 검증, 권한 확인 | session-service.js |
| `admin-auth-controller.js` | 로그인/로그아웃 처리 | session-service.js |
| `admin-tree-controller.js` | 파일 트리 API | tree-service.js |
| `admin-file-controller.js` | 파일 CRUD API | file-service.js |
| `admin-move-controller.js` | 이동/이름변경 API | file-service.js |
| `session-service.js` | 세션 생성/관리 | crypto, config |
| `admin.js` (클라이언트) | UI 로직 전체 | admin.css |
| `admin.ejs` | HTML 템플릿 | admin.js, admin.css |

---

## 7. 보안 아키텍처

### 7.1 인증 레이어

```
┌─────────────────────────────────────────────────────────────────────┐
│                        요청 처리 흐름                                │
├─────────────────────────────────────────────────────────────────────┤
│                                                                      │
│  1. IP Whitelist (기존)                                              │
│     └─ config.security.allows 기반 IP 필터링                         │
│                                                                      │
│  2. API 키 인증 (기존 - /api/* 보호 경로)                            │
│     └─ X-API-Key 헤더 검증                                           │
│                                                                      │
│  3. 세션 인증 (신규 - /api/admin/* 경로)                             │
│     └─ Cookie 또는 Authorization Bearer 토큰                         │
│     └─ 세션 유효성 + 만료 확인                                       │
│     └─ 권한(permissions) 확인                                        │
│                                                                      │
│  4. 경로 검증 (기존)                                                 │
│     └─ path-validator.js로 디렉토리 탈출 방지                        │
│                                                                      │
└─────────────────────────────────────────────────────────────────────┘
```

### 7.2 권한 모델

```
┌───────────────┬───────────────┬───────────────┬───────────────┐
│   Permission  │     read      │     write     │    delete     │
├───────────────┼───────────────┼───────────────┼───────────────┤
│ GET /tree     │      ✓        │       -       │       -       │
│ GET /content  │      ✓        │       -       │       -       │
│ PUT /content  │      -        │       ✓       │       -       │
│ POST /create  │      -        │       ✓       │       -       │
│ PUT /rename   │      -        │       ✓       │       -       │
│ PUT /move     │      -        │       ✓       │       -       │
│ DELETE /entry │      -        │       -       │       ✓       │
│ POST /upload  │      -        │       ✓       │       -       │
└───────────────┴───────────────┴───────────────┴───────────────┘
```

### 7.3 세션 보안

```javascript
// 토큰 생성 - 256비트 엔트로피
const token = crypto.randomBytes(32).toString('hex');

// 세션 만료
const expiresAt = Date.now() + config.admin.sessionTimeout;

// 세션 정리 (1분마다)
setInterval(() => {
  for (const [token, session] of sessions) {
    if (session.expiresAt < Date.now()) {
      sessions.delete(token);
    }
  }
}, 60000);
```

---

## 8. 확장성 고려사항

### 8.1 세션 스토리지 확장

현재 설계는 메모리 기반이나, 추후 Redis 등으로 확장 가능:

```javascript
// session-service.js - 인터페이스
class SessionStore {
  async get(token) { /* ... */ }
  async set(token, session) { /* ... */ }
  async delete(token) { /* ... */ }
  async cleanup() { /* ... */ }
}

// 구현체
class MemorySessionStore extends SessionStore { /* 현재 구현 */ }
class RedisSessionStore extends SessionStore { /* 추후 확장 */ }
```

### 8.2 권한 모델 확장

현재는 단순 문자열 배열이나, 추후 리소스 기반 ACL로 확장 가능:

```javascript
// 현재
permissions: ['read', 'write', 'delete']

// 확장 가능
permissions: {
  '/docs/*': ['read', 'write'],
  '/private/*': ['read'],
  '/admin/*': ['read', 'write', 'delete']
}
```

---

*아키텍처 설계 문서 끝*
