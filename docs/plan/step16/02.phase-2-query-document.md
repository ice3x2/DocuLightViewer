# Phase 2: query_document 도구 구현

## 목표

단일 문서 내에서 쿼리와 관련된 섹션만 추출하여 반환하는 MCP 도구를 구현합니다.

## 선행 조건

- Phase 1 완료 (SectionExtractor)

## 아키텍처 참조

- [00-1.architecture.md](./00-1.architecture.md) Section 2.1, 3.4, 4.2

---

## 구현 체크리스트

### 2.1 QueryDocumentService 클래스 생성

- [x] `src/services/mcp/query-document-service.js` 파일 생성 `2026-01-29`
- [x] 생성자에서 config, logger, sectionExtractor 주입 `2026-01-29`
- [x] `queryDocument(path, query, options)` 메서드 구현 `2026-01-29`
  - path 검증 (path-validator 재활용)
  - 파일 읽기 (fs.readFile)
  - SectionExtractor.extractRelevantSections 호출
  - 결과 포맷팅

### 2.2 MCP Tool 등록

- [x] `src/routes/mcp.js`에 query_document 도구 정의 추가 `2026-01-29`
- [x] TOOLS 배열에 inputSchema 추가 `2026-01-29`
- [x] executeTool 함수에 케이스 추가 `2026-01-29`

### 2.3 출력 포맷 구현

- [x] QueryResult 타입에 맞는 출력 생성 `2026-01-29`
- [x] 마크다운 포맷으로 반환 `2026-01-29`
- [x] 토큰 사용량 정보 포함 `2026-01-29`

---

## Tool 정의

```javascript
{
  name: 'query_document',
  description: 'Search within a specific document and return only sections relevant to your query. Ideal when you know which document to search but need specific information. Returns sections sorted by relevance within the token budget.',
  inputSchema: {
    type: 'object',
    properties: {
      path: {
        type: 'string',
        description: 'Document path (e.g., guide/setup.md)'
      },
      query: {
        type: 'string',
        description: 'What information you need from this document'
      },
      maxTokens: {
        type: 'integer',
        description: 'Maximum tokens to return (default: 2000)',
        default: 2000
      }
    },
    required: ['path', 'query']
  }
}
```

---

## 테스트 시나리오

### 정상 케이스

**Given**: 5,000토큰 크기의 문서 `/guide/setup.md`
```markdown
# Setup Guide

## Prerequisites
Node.js 18+ required...

## Installation
npm install doclight...

## Configuration
Create config.json5 with...

## Running
npm start...

## Troubleshooting
If you encounter...
```

**When**: `query_document({ path: "guide/setup.md", query: "configuration", maxTokens: 500 })`

**Then**:
- Configuration 섹션이 포함됨
- 총 토큰 ≤500
- 관련성 점수 포함

---

**Given**: 쿼리와 관련 없는 문서

**When**: `query_document({ path: "other.md", query: "xyz", maxTokens: 500 })`

**Then**:
- 가장 관련성 높은 섹션 (점수가 낮더라도) 반환
- 또는 빈 결과 + 안내 메시지

---

### 예외 케이스

**Given**: 존재하지 않는 파일 경로

**When**: `query_document({ path: "nonexistent.md", query: "test" })`

**Then**: 에러 반환 (DOCUMENT_NOT_FOUND)

---

**Given**: 디렉토리 경로 (파일 아님)

**When**: `query_document({ path: "guide/", query: "test" })`

**Then**: 에러 반환 (INVALID_PATH)

---

**Given**: docsRoot 외부 경로 (path traversal)

**When**: `query_document({ path: "../../../etc/passwd", query: "test" })`

**Then**: 에러 반환 (PATH_TRAVERSAL)

---

### 경계값 테스트

**Given**: 빈 쿼리

**When**: `query_document({ path: "doc.md", query: "" })`

**Then**: 에러 반환 (INVALID_QUERY)

---

## 테스트 코드 템플릿

```javascript
// test/mcp/query-document.test.js

const { QueryDocumentService } = require('../../src/services/mcp/query-document-service');
const { SectionExtractor } = require('../../src/services/mcp/section-extractor');
const path = require('path');
const fs = require('fs').promises;

describe('QueryDocumentService', () => {
  let service;
  let mockConfig;
  let mockLogger;
  const testDocsRoot = path.join(__dirname, '../test-source');

  beforeEach(async () => {
    mockConfig = {
      docsRoot: testDocsRoot,
      excludes: []
    };
    mockLogger = {
      info: jest.fn(),
      warn: jest.fn(),
      error: jest.fn(),
      debug: jest.fn()
    };
    service = new QueryDocumentService(mockConfig, mockLogger);
  });

  describe('queryDocument', () => {
    beforeAll(async () => {
      // 테스트 문서 생성
      await fs.mkdir(testDocsRoot, { recursive: true });
      await fs.writeFile(
        path.join(testDocsRoot, 'test-doc.md'),
        `# Test Document

## Configuration
This section covers configuration options.

## Installation
This section covers installation steps.

## API Reference
This section covers API endpoints.
`
      );
    });

    afterAll(async () => {
      await fs.rm(testDocsRoot, { recursive: true, force: true });
    });

    it('should return relevant sections for query', async () => {
      const result = await service.queryDocument('test-doc.md', 'configuration', { maxTokens: 500 });

      expect(result.sections.length).toBeGreaterThan(0);
      expect(result.tokensUsed).toBeLessThanOrEqual(500);
      expect(result.sections.some(s => s.heading.toLowerCase().includes('configuration'))).toBe(true);
    });

    it('should throw error for non-existent file', async () => {
      await expect(
        service.queryDocument('nonexistent.md', 'test')
      ).rejects.toThrow(/not found/i);
    });

    it('should throw error for path traversal attempt', async () => {
      await expect(
        service.queryDocument('../../../etc/passwd', 'test')
      ).rejects.toThrow(/path/i);
    });

    it('should return within token budget', async () => {
      const result = await service.queryDocument('test-doc.md', 'test', { maxTokens: 100 });

      expect(result.tokensUsed).toBeLessThanOrEqual(100);
    });
  });
});
```

---

## 출력 포맷 예시

```markdown
# Query Results for "configuration"

**Document**: /guide/setup.md
**Query**: configuration
**Sections**: 2 of 5 (selected based on relevance)

---

## Configuration (score: 0.89)

Create config.json5 with the following settings:

```json5
{
  docsRoot: "/data/docs",
  port: 3000
}
```

---

## Advanced Options (score: 0.65)

For advanced configuration, you can also set...

---

**Tokens used**: 487 / 500
```

---

## 회귀 테스트 실행 조건

- [x] Phase 1 테스트 통과 `2026-01-29` (21/21)
- [x] 기존 MCP 도구 테스트 통과 `2026-01-29`
- [x] path-validator 테스트 통과 `2026-01-29`
- [x] 새 query-document 테스트 통과 `2026-01-29` (11/11)

---

## 구현 순서

1. QueryDocumentService 클래스 스켈레톤 생성
2. queryDocument 메서드 구현
3. MCP Tool 등록 (mcp.js)
4. 단위 테스트 작성 및 통과
5. 통합 테스트 (실제 MCP 호출)
6. 에러 케이스 처리

---

## 예상 파일 구조

```
src/services/mcp/
├── index.js                       # 모듈 exports (업데이트)
├── section-extractor.js           # Phase 1
└── query-document-service.js      # Phase 2 (새 파일)

src/routes/
└── mcp.js                         # Tool 등록 (수정)

test/mcp/
├── section-extractor.test.js      # Phase 1
└── query-document.test.js         # Phase 2 (새 파일)
```

---

## 완료 기준

- [x] 모든 체크리스트 항목 완료 `2026-01-29`
- [x] 테스트 커버리지 ≥80% `2026-01-29` (11개 테스트 케이스)
- [x] MCP 호출 테스트 통과 `2026-01-29`
- [x] 문서화 완료 (JSDoc) `2026-01-29`

**Phase 2 완료: 2026-01-29** ✅
