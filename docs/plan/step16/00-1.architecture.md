# Step 16: MCP 효율성 개선 - 아키텍처 설계

## 1. 시스템 컨텍스트

### 1.1 현재 MCP 아키텍처

```
┌─────────────────────────────────────────────────────────────────────────────┐
│                          현재 DocLight MCP                                   │
├─────────────────────────────────────────────────────────────────────────────┤
│                                                                              │
│  ┌────────────────────────────────────────────────────────────────────────┐ │
│  │                          MCP Tools (현재)                               │ │
│  ├────────────────────────────────────────────────────────────────────────┤ │
│  │  list_documents      → 전체 디렉토리 목록                               │ │
│  │  list_full_tree      → 전체 트리 구조                                   │ │
│  │  read_document       → 전체 문서 내용 반환 ← 비효율!                    │ │
│  │  create_document     → 문서 생성                                        │ │
│  │  delete_document     → 문서 삭제                                        │ │
│  │  DocuLight_get_config→ 설정 조회                                        │ │
│  │  DocuLight_search    → 키워드 검색 (전체 컨텍스트) ← 비효율!            │ │
│  └────────────────────────────────────────────────────────────────────────┘ │
│                                                                              │
│  문제점:                                                                     │
│  • read_document: 5,000자 문서 → 5,000 토큰 소비                            │
│  • DocuLight_search: 10개 매칭 → 전체 컨텍스트 반환                          │
│  • 쿼리 기반 섹션 추출 없음                                                  │
│  • 토큰 제한 옵션 없음                                                       │
│                                                                              │
└─────────────────────────────────────────────────────────────────────────────┘
```

### 1.2 개선된 MCP 아키텍처

```
┌─────────────────────────────────────────────────────────────────────────────┐
│                       개선된 DocLight MCP (Step 16)                          │
├─────────────────────────────────────────────────────────────────────────────┤
│                                                                              │
│  ┌────────────────────────────────────────────────────────────────────────┐ │
│  │                    MCP Tools (개선)                                     │ │
│  ├────────────────────────────────────────────────────────────────────────┤ │
│  │                                                                        │ │
│  │  [기존 도구 - 유지]                                                    │ │
│  │  list_documents, list_full_tree, read_document,                       │ │
│  │  create_document, delete_document, DocuLight_get_config               │ │
│  │                                                                        │ │
│  │  [개선된 도구]                                                         │ │
│  │  DocuLight_search     → mode 추가 (titles_only/snippets/full_context) │ │
│  │                                                                        │ │
│  │  [새로운 도구]                                                         │ │
│  │  DocuLight_smart_search → 하이브리드 검색 (시맨틱/키워드)             │ │
│  │  query_document         → 단일 문서 내 쿼리 기반 섹션 추출            │ │
│  │  summarize_document     → 문서 요약 및 목차                           │ │
│  │                                                                        │ │
│  └────────────────────────────────────────────────────────────────────────┘ │
│                                    │                                         │
│                                    ▼                                         │
│  ┌────────────────────────────────────────────────────────────────────────┐ │
│  │                     Search Strategy Layer                               │ │
│  ├────────────────────────────────────────────────────────────────────────┤ │
│  │                                                                        │ │
│  │   config.chatbot.embedding 설정 확인                                   │ │
│  │                     │                                                  │ │
│  │        ┌────────────┴────────────┐                                     │ │
│  │        │ 있음                    │ 없음                                │ │
│  │        ▼                         ▼                                     │ │
│  │   ┌──────────────┐        ┌──────────────┐                             │ │
│  │   │시맨틱 검색   │        │키워드 검색   │                             │ │
│  │   │(VectorStore) │        │(search-service)│                           │ │
│  │   └──────────────┘        └──────────────┘                             │ │
│  │                                                                        │ │
│  └────────────────────────────────────────────────────────────────────────┘ │
│                                    │                                         │
│                                    ▼                                         │
│  ┌────────────────────────────────────────────────────────────────────────┐ │
│  │                     Section Extractor                                   │ │
│  ├────────────────────────────────────────────────────────────────────────┤ │
│  │  • 마크다운 헤딩 기반 섹션 분할                                         │ │
│  │  • 쿼리 관련성 점수 계산                                                │ │
│  │  • maxTokens 내 섹션 선택                                               │ │
│  │  • 원본 순서 정렬                                                       │ │
│  └────────────────────────────────────────────────────────────────────────┘ │
│                                                                              │
└─────────────────────────────────────────────────────────────────────────────┘
```

---

## 2. 컴포넌트 다이어그램

### 2.1 MCP 서비스 계층

```
┌─────────────────────────────────────────────────────────────────────────────┐
│                           src/services/mcp/                                  │
├─────────────────────────────────────────────────────────────────────────────┤
│                                                                              │
│  ┌──────────────────────────────────────────────────────────────────────┐   │
│  │                      SmartSearchService (NEW)                         │   │
│  │  src/services/mcp/smart-search-service.js                            │   │
│  ├──────────────────────────────────────────────────────────────────────┤   │
│  │  + smartSearch(query, options): Promise<SearchResult>                │   │
│  │  + getSearchMode(config): 'semantic' | 'keyword'                     │   │
│  │  - hasEmbeddingConfig(config): boolean                               │   │
│  └───────────────────────────────┬──────────────────────────────────────┘   │
│                                  │                                          │
│          ┌───────────────────────┼───────────────────────┐                 │
│          │                       │                       │                 │
│          ▼                       ▼                       ▼                 │
│  ┌──────────────────┐   ┌──────────────────┐   ┌──────────────────┐       │
│  │ SemanticSearcher │   │ KeywordSearcher  │   │ SectionExtractor │       │
│  │                  │   │                  │   │                  │       │
│  │ - VectorStore    │   │ - searchService  │   │ - splitByHeadings│       │
│  │ - similarity()   │   │ - regex match    │   │ - scoreRelevance │       │
│  └──────────────────┘   └──────────────────┘   │ - selectSections │       │
│          │                       │             └──────────────────┘       │
│          │                       │                       │                 │
│          │   기존 서비스 재활용   │                       │                 │
│          ▼                       ▼                       │                 │
│  ┌──────────────────┐   ┌──────────────────┐             │                 │
│  │ VectorStoreManager│   │  searchDocuments │             │                 │
│  │ (chatbot module) │   │ (search-service) │             │                 │
│  └──────────────────┘   └──────────────────┘             │                 │
│                                                          │                 │
│  ┌──────────────────────────────────────────────────────┴─────────────┐   │
│  │                      QueryDocumentService (NEW)                     │   │
│  │  src/services/mcp/query-document-service.js                        │   │
│  ├────────────────────────────────────────────────────────────────────┤   │
│  │  + queryDocument(path, query, maxTokens): Promise<QueryResult>     │   │
│  │  - extractRelevantSections(content, query, maxTokens): Section[]   │   │
│  └────────────────────────────────────────────────────────────────────┘   │
│                                                                            │
│  ┌────────────────────────────────────────────────────────────────────┐   │
│  │                     SummarizeDocumentService (NEW)                  │   │
│  │  src/services/mcp/summarize-document-service.js                    │   │
│  ├────────────────────────────────────────────────────────────────────┤   │
│  │  + summarizeDocument(path): Promise<DocumentSummary>               │   │
│  │  - extractTOC(content): TOCItem[]                                  │   │
│  │  - extractKeyPoints(content): string[]                             │   │
│  │  - getStatistics(content): DocumentStats                           │   │
│  └────────────────────────────────────────────────────────────────────┘   │
│                                                                            │
└─────────────────────────────────────────────────────────────────────────────┘
```

### 2.2 Section Extractor 상세

```
┌─────────────────────────────────────────────────────────────────────────────┐
│                        SectionExtractor                                      │
│  src/services/mcp/section-extractor.js                                      │
├─────────────────────────────────────────────────────────────────────────────┤
│                                                                              │
│  입력: content (string), query (string), maxTokens (number)                 │
│                                                                              │
│  ┌───────────────────────────────────────────────────────────────────────┐  │
│  │  Step 1: splitByHeadings(content)                                     │  │
│  │                                                                       │  │
│  │  # Title           → Section 0: "# Title\n..."                        │  │
│  │  ## Section A      → Section 1: "## Section A\n..."                   │  │
│  │  ### Subsection    → Section 2: "### Subsection\n..."                 │  │
│  │  ## Section B      → Section 3: "## Section B\n..."                   │  │
│  └───────────────────────────────────────────────────────────────────────┘  │
│                                    │                                         │
│                                    ▼                                         │
│  ┌───────────────────────────────────────────────────────────────────────┐  │
│  │  Step 2: calculateRelevance(section, query)                           │  │
│  │                                                                       │  │
│  │  키워드 밀도: query 단어가 섹션에 몇 번 등장하는지                     │  │
│  │  헤딩 매칭: 헤딩에 query 단어가 포함되면 보너스                        │  │
│  │  코드블록: 코드 내 매칭 시 추가 점수                                   │  │
│  │                                                                       │  │
│  │  score = (keywordDensity * 0.5) + (headingMatch * 0.3) +              │  │
│  │          (codeMatch * 0.2)                                            │  │
│  └───────────────────────────────────────────────────────────────────────┘  │
│                                    │                                         │
│                                    ▼                                         │
│  ┌───────────────────────────────────────────────────────────────────────┐  │
│  │  Step 3: selectWithinTokenBudget(scoredSections, maxTokens)           │  │
│  │                                                                       │  │
│  │  1. 점수 높은 순 정렬                                                  │  │
│  │  2. 토큰 예산 내에서 섹션 선택                                         │  │
│  │  3. 선택된 섹션을 원본 순서로 재정렬                                   │  │
│  └───────────────────────────────────────────────────────────────────────┘  │
│                                    │                                         │
│                                    ▼                                         │
│  출력: Section[] (선택된 섹션 배열)                                         │
│                                                                              │
└─────────────────────────────────────────────────────────────────────────────┘
```

---

## 3. 클래스 다이어그램

### 3.1 MCP Tool 인터페이스

```
┌─────────────────────────────────────────────────────────────────────────┐
│                            <<interface>>                                 │
│                            MCPToolHandler                                │
├─────────────────────────────────────────────────────────────────────────┤
│  + name: string                                                         │
│  + description: string                                                  │
│  + inputSchema: JSONSchema                                              │
│  + execute(args: object, context: MCPContext): Promise<ToolResult>      │
└─────────────────────────────────────────────────────────────────────────┘
                                    △
                                    │ implements
          ┌─────────────────────────┼─────────────────────────┐
          │                         │                         │
┌─────────┴─────────┐   ┌──────────┴──────────┐   ┌─────────┴─────────┐
│SmartSearchHandler │   │QueryDocumentHandler │   │SummarizeHandler   │
├───────────────────┤   ├─────────────────────┤   ├───────────────────┤
│- smartSearchSvc   │   │- queryDocSvc        │   │- summarizeSvc     │
│- config           │   │- config             │   │- config           │
├───────────────────┤   ├─────────────────────┤   ├───────────────────┤
│+ execute()        │   │+ execute()          │   │+ execute()        │
└───────────────────┘   └─────────────────────┘   └───────────────────┘
```

### 3.2 SmartSearchService 클래스

```
┌─────────────────────────────────────────────────────────────────────────┐
│                         SmartSearchService                               │
│  src/services/mcp/smart-search-service.js                               │
├─────────────────────────────────────────────────────────────────────────┤
│ - config: AppConfig                                                     │
│ - logger: Logger                                                        │
│ - vectorStoreManager: VectorStoreManager | null                         │
│ - searchService: SearchDocuments                                        │
│ - sectionExtractor: SectionExtractor                                    │
│ - initialized: boolean                                                  │
├─────────────────────────────────────────────────────────────────────────┤
│ + constructor(config, logger)                                           │
│ + initialize(): Promise<void>                                           │
│ + smartSearch(query, options): Promise<SmartSearchResult>               │
│ + getAvailableMode(): 'semantic' | 'keyword'                            │
│ + getStatus(): ServiceStatus                                            │
│ + shutdown(): Promise<void>                                             │
├─────────────────────────────────────────────────────────────────────────┤
│ - hasEmbeddingConfig(): boolean                                         │
│ - initializeVectorStore(): Promise<void>                                │
│ - performSemanticSearch(query, options): Promise<Document[]>            │
│ - performKeywordSearch(query, options): Promise<SearchResult[]>         │
│ - formatResults(results, query, maxTokens): SmartSearchResult           │
└─────────────────────────────────────────────────────────────────────────┘
```

### 3.3 SectionExtractor 클래스

```
┌─────────────────────────────────────────────────────────────────────────┐
│                          SectionExtractor                                │
│  src/services/mcp/section-extractor.js                                  │
├─────────────────────────────────────────────────────────────────────────┤
│ - headingPattern: RegExp                                                │
│ - tokenEstimator: TokenEstimator                                        │
├─────────────────────────────────────────────────────────────────────────┤
│ + extractRelevantSections(content, query, maxTokens): Section[]         │
│ + splitByHeadings(content): Section[]                                   │
│ + calculateRelevance(section, query): number                            │
│ + estimateTokens(text): number                                          │
├─────────────────────────────────────────────────────────────────────────┤
│ - tokenizeQuery(query): string[]                                        │
│ - calculateKeywordDensity(content, keywords): number                    │
│ - calculateHeadingScore(heading, keywords): number                      │
│ - selectWithinBudget(sections, maxTokens): Section[]                    │
│ - sortByOriginalOrder(sections): Section[]                              │
└─────────────────────────────────────────────────────────────────────────┘

┌─────────────────────────────────────────────────────────────────────────┐
│                          Section (type)                                  │
├─────────────────────────────────────────────────────────────────────────┤
│  heading: string           // "## Configuration"                        │
│  level: number             // 2 (h2)                                    │
│  content: string           // 섹션 전체 내용                             │
│  position: number          // 원본 문서에서의 위치                       │
│  tokens: number            // 추정 토큰 수                               │
│  score?: number            // 관련성 점수 (0-1)                          │
└─────────────────────────────────────────────────────────────────────────┘
```

### 3.4 QueryDocumentService 클래스

```
┌─────────────────────────────────────────────────────────────────────────┐
│                       QueryDocumentService                               │
│  src/services/mcp/query-document-service.js                             │
├─────────────────────────────────────────────────────────────────────────┤
│ - config: AppConfig                                                     │
│ - logger: Logger                                                        │
│ - sectionExtractor: SectionExtractor                                    │
├─────────────────────────────────────────────────────────────────────────┤
│ + queryDocument(path, query, options): Promise<QueryResult>             │
├─────────────────────────────────────────────────────────────────────────┤
│ - loadDocument(path): Promise<string>                                   │
│ - validatePath(path): string                                            │
│ - formatOutput(sections, metadata): QueryResult                         │
└─────────────────────────────────────────────────────────────────────────┘

┌─────────────────────────────────────────────────────────────────────────┐
│                         QueryResult (type)                               │
├─────────────────────────────────────────────────────────────────────────┤
│  path: string              // 문서 경로                                  │
│  query: string             // 검색 쿼리                                  │
│  sections: Section[]       // 관련 섹션들                                │
│  totalSections: number     // 전체 섹션 수                               │
│  selectedSections: number  // 선택된 섹션 수                             │
│  tokensUsed: number        // 사용된 토큰 수                             │
│  maxTokens: number         // 최대 토큰 수                               │
└─────────────────────────────────────────────────────────────────────────┘
```

### 3.5 SummarizeDocumentService 클래스

```
┌─────────────────────────────────────────────────────────────────────────┐
│                     SummarizeDocumentService                             │
│  src/services/mcp/summarize-document-service.js                         │
├─────────────────────────────────────────────────────────────────────────┤
│ - config: AppConfig                                                     │
│ - logger: Logger                                                        │
├─────────────────────────────────────────────────────────────────────────┤
│ + summarizeDocument(path): Promise<DocumentSummary>                     │
├─────────────────────────────────────────────────────────────────────────┤
│ - loadDocument(path): Promise<string>                                   │
│ - extractTOC(content): TOCItem[]                                        │
│ - extractKeyPoints(content): string[]                                   │
│ - getStatistics(content): DocumentStats                                 │
│ - formatOutput(toc, keyPoints, stats): DocumentSummary                  │
└─────────────────────────────────────────────────────────────────────────┘

┌─────────────────────────────────────────────────────────────────────────┐
│                       DocumentSummary (type)                             │
├─────────────────────────────────────────────────────────────────────────┤
│  path: string              // 문서 경로                                  │
│  title: string             // 문서 제목 (H1)                             │
│  toc: TOCItem[]            // 목차                                       │
│  keyPoints: string[]       // 핵심 내용 요약                             │
│  stats: DocumentStats      // 통계                                       │
└─────────────────────────────────────────────────────────────────────────┘

┌─────────────────────────────────────────────────────────────────────────┐
│                          TOCItem (type)                                  │
├─────────────────────────────────────────────────────────────────────────┤
│  level: number             // 헤딩 레벨 (1-6)                            │
│  text: string              // 헤딩 텍스트                                │
│  anchor: string            // 앵커 ID                                    │
└─────────────────────────────────────────────────────────────────────────┘

┌─────────────────────────────────────────────────────────────────────────┐
│                        DocumentStats (type)                              │
├─────────────────────────────────────────────────────────────────────────┤
│  wordCount: number         // 단어 수                                    │
│  charCount: number         // 문자 수                                    │
│  sectionCount: number      // 섹션 수                                    │
│  codeBlockCount: number    // 코드 블록 수                               │
│  estimatedTokens: number   // 추정 토큰 수                               │
└─────────────────────────────────────────────────────────────────────────┘
```

---

## 4. 시퀀스 다이어그램

### 4.1 DocuLight_smart_search 플로우

```
┌────────┐    ┌──────────┐    ┌──────────────┐    ┌──────────┐    ┌─────────┐
│MCP Host│    │ MCP API  │    │SmartSearchSvc│    │SearchMode│    │Extractor│
└───┬────┘    └────┬─────┘    └──────┬───────┘    └────┬─────┘    └────┬────┘
    │              │                 │                 │               │
    │ tools/call   │                 │                 │               │
    │ smart_search │                 │                 │               │
    │─────────────>│                 │                 │               │
    │              │                 │                 │               │
    │              │ smartSearch()   │                 │               │
    │              │────────────────>│                 │               │
    │              │                 │                 │               │
    │              │                 │ getAvailableMode()              │
    │              │                 │────────────────>│               │
    │              │                 │                 │               │
    │              │                 │ mode='semantic' │               │
    │              │                 │ or 'keyword'    │               │
    │              │                 │<────────────────│               │
    │              │                 │                 │               │
    │              │                 │     ┌──────────────────────────┐│
    │              │                 │     │ IF mode == 'semantic'    ││
    │              │                 │     │   → VectorStore.search() ││
    │              │                 │     │ ELSE                     ││
    │              │                 │     │   → searchDocuments()    ││
    │              │                 │     └──────────────────────────┘│
    │              │                 │                 │               │
    │              │                 │ extractRelevantSections()       │
    │              │                 │────────────────────────────────>│
    │              │                 │                 │               │
    │              │                 │ Section[]       │               │
    │              │                 │<────────────────────────────────│
    │              │                 │                 │               │
    │              │ SmartSearchResult                 │               │
    │              │<────────────────│                 │               │
    │              │                 │                 │               │
    │ JSON-RPC     │                 │                 │               │
    │ response     │                 │                 │               │
    │<─────────────│                 │                 │               │
    │              │                 │                 │               │
```

### 4.2 query_document 플로우

```
┌────────┐    ┌──────────┐    ┌─────────────┐    ┌─────────┐
│MCP Host│    │ MCP API  │    │QueryDocSvc  │    │Extractor│
└───┬────┘    └────┬─────┘    └──────┬──────┘    └────┬────┘
    │              │                 │                │
    │ tools/call   │                 │                │
    │ query_doc    │                 │                │
    │─────────────>│                 │                │
    │              │                 │                │
    │              │ queryDocument() │                │
    │              │────────────────>│                │
    │              │                 │                │
    │              │                 │ loadDocument() │
    │              │                 │────────┐       │
    │              │                 │        │       │
    │              │                 │<───────┘       │
    │              │                 │                │
    │              │                 │ extractRelevantSections()
    │              │                 │───────────────>│
    │              │                 │                │
    │              │                 │  1. split      │
    │              │                 │  2. score      │
    │              │                 │  3. select     │
    │              │                 │                │
    │              │                 │ Section[]      │
    │              │                 │<───────────────│
    │              │                 │                │
    │              │ QueryResult     │                │
    │              │<────────────────│                │
    │              │                 │                │
    │ JSON-RPC     │                 │                │
    │<─────────────│                 │                │
    │              │                 │                │
```

### 4.3 summarize_document 플로우

```
┌────────┐    ┌──────────┐    ┌──────────────┐
│MCP Host│    │ MCP API  │    │SummarizeSvc  │
└───┬────┘    └────┬─────┘    └──────┬───────┘
    │              │                 │
    │ tools/call   │                 │
    │ summarize    │                 │
    │─────────────>│                 │
    │              │                 │
    │              │ summarize()     │
    │              │────────────────>│
    │              │                 │
    │              │                 │ loadDocument()
    │              │                 │────────┐
    │              │                 │        │
    │              │                 │<───────┘
    │              │                 │
    │              │                 │ extractTOC()
    │              │                 │────────┐
    │              │                 │        │
    │              │                 │<───────┘
    │              │                 │
    │              │                 │ extractKeyPoints()
    │              │                 │────────┐
    │              │                 │        │
    │              │                 │<───────┘
    │              │                 │
    │              │                 │ getStatistics()
    │              │                 │────────┐
    │              │                 │        │
    │              │                 │<───────┘
    │              │                 │
    │              │ DocumentSummary │
    │              │<────────────────│
    │              │                 │
    │ JSON-RPC     │                 │
    │<─────────────│                 │
    │              │                 │
```

---

## 5. 데이터 모델

### 5.1 MCP Tool Input Schemas

```typescript
// DocuLight_smart_search 입력
interface SmartSearchInput {
  query: string;           // 검색 쿼리 (필수)
  path?: string;           // 검색 경로 (기본: /)
  mode?: 'auto' | 'semantic' | 'keyword';  // 검색 모드 (기본: auto)
  maxTokens?: number;      // 최대 토큰 (기본: 2000)
  limit?: number;          // 최대 문서 수 (기본: 5)
}

// query_document 입력
interface QueryDocumentInput {
  path: string;            // 문서 경로 (필수)
  query: string;           // 검색 쿼리 (필수)
  maxTokens?: number;      // 최대 토큰 (기본: 2000)
}

// summarize_document 입력
interface SummarizeDocumentInput {
  path: string;            // 문서 경로 (필수)
}

// DocuLight_search 입력 (개선)
interface SearchInput {
  query: string;           // 검색 쿼리 (필수)
  limit?: number;          // 최대 결과 수 (기본: 10)
  path?: string;           // 검색 경로 (기본: /)
  mode?: 'titles_only' | 'snippets' | 'full_context';  // 새 옵션
}
```

### 5.2 MCP Tool Output Schemas

```typescript
// SmartSearchResult
interface SmartSearchResult {
  query: string;
  mode: 'semantic' | 'keyword';
  modelInfo?: string;      // 시맨틱 모드일 때 임베딩 모델명
  documentsFound: number;
  documents: DocumentMatch[];
  tokensUsed: number;
  maxTokens: number;
}

interface DocumentMatch {
  path: string;
  score: number;           // 관련성 점수 (0-1)
  sections: Section[];     // 관련 섹션들
}

// QueryResult
interface QueryResult {
  path: string;
  query: string;
  sections: Section[];
  totalSections: number;
  selectedSections: number;
  tokensUsed: number;
  maxTokens: number;
}

// DocumentSummary
interface DocumentSummary {
  path: string;
  title: string;
  toc: TOCItem[];
  keyPoints: string[];
  stats: DocumentStats;
}
```

### 5.3 Section 데이터 구조

```typescript
interface Section {
  heading: string;         // 헤딩 텍스트 (예: "## Configuration")
  level: number;           // 헤딩 레벨 (1-6)
  content: string;         // 섹션 전체 내용
  position: number;        // 원본 문서에서의 순서
  tokens: number;          // 추정 토큰 수
  score?: number;          // 관련성 점수 (0-1)
}
```

---

## 6. 패키지 구조

```
src/
├── services/
│   ├── mcp/                              # MCP 효율성 개선 (NEW)
│   │   ├── index.js                      # 모듈 exports
│   │   ├── smart-search-service.js       # 하이브리드 검색
│   │   ├── query-document-service.js     # 문서 쿼리
│   │   ├── summarize-document-service.js # 문서 요약
│   │   └── section-extractor.js          # 섹션 추출 유틸
│   │
│   ├── search-service.js                 # 기존 키워드 검색 (재활용)
│   │
│   └── chatbot/                          # 기존 챗봇 모듈 (재활용)
│       ├── vector-store.js               # 벡터 스토어
│       ├── embedding-factory.js          # 임베딩 팩토리
│       └── ...
│
├── routes/
│   └── mcp.js                            # MCP 라우트 (수정)
│
└── utils/
    └── token-estimator.js                # 토큰 추정 (재활용)

test/
├── mcp/
│   ├── smart-search.test.js              # 스마트 검색 테스트
│   ├── query-document.test.js            # 문서 쿼리 테스트
│   ├── summarize-document.test.js        # 문서 요약 테스트
│   └── section-extractor.test.js         # 섹션 추출 테스트
│
└── test-source/                          # 테스트용 문서
    ├── large-doc.md                      # 대용량 문서
    └── multi-section.md                  # 다중 섹션 문서
```

---

## 7. 외부 의존성

### 7.1 기존 패키지 (재활용)

| 패키지 | 용도 |
|--------|------|
| `@langchain/core` | 메시지 타입 (선택적) |
| `@langchain/openai` | OpenAI 임베딩 (선택적) |
| `@langchain/ollama` | Ollama 임베딩 (선택적) |
| `ignore` | 파일 제외 패턴 |

### 7.2 새 패키지 (추가 불필요)

Step 16은 기존 패키지만 재활용하여 구현 가능합니다.
별도의 새 패키지 설치가 필요하지 않습니다.

---

## 8. 성능 최적화 전략

### 8.1 토큰 예산 관리

```
┌─────────────────────────────────────────────────────────────────────────┐
│                        Token Budget Strategy                             │
├─────────────────────────────────────────────────────────────────────────┤
│                                                                          │
│  요청: query="configuration" maxTokens=2000                              │
│                                                                          │
│  문서 A (5000 토큰)                                                       │
│  ├─ Section 1 (500 토큰, score=0.9) ✓ 선택                              │
│  ├─ Section 2 (800 토큰, score=0.7) ✓ 선택                              │
│  ├─ Section 3 (600 토큰, score=0.8) ✓ 선택                              │
│  ├─ Section 4 (1200 토큰, score=0.5) ✗ 예산 초과                        │
│  └─ Section 5 (1900 토큰, score=0.3) ✗ 제외                             │
│                                                                          │
│  결과: 1900 / 2000 토큰 사용 (62% 절감)                                  │
│                                                                          │
└─────────────────────────────────────────────────────────────────────────┘
```

### 8.2 캐싱 전략

```
┌─────────────────────────────────────────────────────────────────────────┐
│                          Cache Strategy                                   │
├─────────────────────────────────────────────────────────────────────────┤
│                                                                          │
│  L1: 문서 파싱 캐시 (메모리, 5분 TTL)                                     │
│      key: filePath                                                       │
│      value: { sections: Section[], hash: string }                        │
│                                                                          │
│  L2: 검색 결과 캐시 (메모리, 1분 TTL)                                     │
│      key: `${query}:${mode}:${maxTokens}`                                │
│      value: SearchResult                                                 │
│                                                                          │
│  무효화 조건:                                                             │
│  • 파일 변경 시 L1 무효화                                                 │
│  • 검색 파라미터 변경 시 L2 무효화                                        │
│                                                                          │
└─────────────────────────────────────────────────────────────────────────┘
```

### 8.3 벡터 스토어 재활용

```
┌─────────────────────────────────────────────────────────────────────────┐
│                     Vector Store Reuse Strategy                          │
├─────────────────────────────────────────────────────────────────────────┤
│                                                                          │
│  Chatbot 모듈의 VectorStoreManager 재활용:                               │
│                                                                          │
│  IF chatbot.embedding 설정 있음:                                         │
│    1. ChatbotService 초기화 시 VectorStore 생성                          │
│    2. SmartSearchService에서 동일 VectorStore 참조                       │
│    3. 문서 변경 시 자동 재인덱싱 (기존 로직)                              │
│                                                                          │
│  ELSE:                                                                   │
│    VectorStore 생성하지 않음                                              │
│    키워드 검색만 사용                                                     │
│                                                                          │
└─────────────────────────────────────────────────────────────────────────┘
```

---

## 9. 에러 처리 전략

### 9.1 에러 코드 정의

```typescript
enum MCPErrorCode {
  // 입력 검증 (1xx)
  INVALID_QUERY = 'ERR_MCP_100',
  INVALID_PATH = 'ERR_MCP_101',
  QUERY_TOO_SHORT = 'ERR_MCP_102',

  // 검색 관련 (2xx)
  SEARCH_FAILED = 'ERR_MCP_200',
  NO_RESULTS = 'ERR_MCP_201',
  SEMANTIC_SEARCH_UNAVAILABLE = 'ERR_MCP_202',

  // 문서 관련 (3xx)
  DOCUMENT_NOT_FOUND = 'ERR_MCP_300',
  DOCUMENT_READ_FAILED = 'ERR_MCP_301',
  DOCUMENT_TOO_LARGE = 'ERR_MCP_302',

  // 시스템 (5xx)
  INTERNAL_ERROR = 'ERR_MCP_500',
  SERVICE_NOT_INITIALIZED = 'ERR_MCP_501',
}
```

### 9.2 폴백 전략

```
┌─────────────────────────────────────────────────────────────────────────┐
│                          Fallback Strategy                               │
├─────────────────────────────────────────────────────────────────────────┤
│                                                                          │
│  DocuLight_smart_search:                                                 │
│  ┌─────────────────────────────────────────────────────────────────┐    │
│  │  mode='auto' 요청                                                │    │
│  │       │                                                          │    │
│  │       ▼                                                          │    │
│  │  임베딩 설정 확인                                                 │    │
│  │       │                                                          │    │
│  │  ┌────┴────┐                                                     │    │
│  │  │ 있음    │ 없음                                                │    │
│  │  ▼         ▼                                                     │    │
│  │  시맨틱    키워드                                                 │    │
│  │  검색      검색                                                   │    │
│  │  │         │                                                     │    │
│  │  │ 실패    │                                                     │    │
│  │  └────┬────┘                                                     │    │
│  │       ▼                                                          │    │
│  │  키워드 검색 폴백                                                 │    │
│  └─────────────────────────────────────────────────────────────────┘    │
│                                                                          │
│  mode='semantic' 요청 + 임베딩 미설정:                                   │
│  → 에러 반환 (SEMANTIC_SEARCH_UNAVAILABLE)                              │
│                                                                          │
│  mode='keyword' 요청:                                                    │
│  → 항상 키워드 검색 사용                                                 │
│                                                                          │
└─────────────────────────────────────────────────────────────────────────┘
```

---

## 10. 도구 설명 개선

### 10.1 기존 도구 설명 개선

```javascript
// 기존
{
  name: 'read_document',
  description: 'Read a markdown document'
}

// 개선
{
  name: 'read_document',
  description: 'Read the complete content of a markdown document. Returns the full document. For specific information within a document, prefer query_document to reduce token usage. For searching across multiple documents, use DocuLight_smart_search.'
}
```

### 10.2 새 도구 설명

```javascript
{
  name: 'DocuLight_smart_search',
  description: 'Search documents using semantic search (if embedding configured) or keyword search (fallback). Returns only relevant sections to minimize token usage. Use mode="auto" (default) for automatic selection, "semantic" to force vector search, or "keyword" for text matching. Set maxTokens to control output size.'
}

{
  name: 'query_document',
  description: 'Search within a specific document and return only sections relevant to your query. Ideal when you know which document to search but need specific information. Returns sections sorted by relevance within the token budget.'
}

{
  name: 'summarize_document',
  description: 'Get a structured summary of a document including table of contents, key points, and statistics. Use this to understand document structure before deciding which sections to read in detail. Much more efficient than reading the full document.'
}
```

---

## 11. 기존 코드 재활용 매핑

```
┌─────────────────────────────────────────────────────────────────────────┐
│                      Reuse Mapping                                       │
├─────────────────────────────────────────────────────────────────────────┤
│                                                                          │
│  Step 16 기능           │  재활용 모듈                                   │
│  ─────────────────────────────────────────────────────────────────────  │
│  키워드 검색            │  src/services/search-service.js               │
│  벡터 검색              │  src/services/chatbot/vector-store.js         │
│  임베딩 생성            │  src/services/chatbot/embedding-factory.js    │
│  토큰 추정              │  src/services/chatbot/token-estimator.js      │
│  경로 검증              │  src/utils/path-validator.js                  │
│  파일 exclude 필터      │  ignore 패키지 (기존 사용)                     │
│                                                                          │
│  새로 구현 필요         │  위치                                         │
│  ─────────────────────────────────────────────────────────────────────  │
│  SectionExtractor       │  src/services/mcp/section-extractor.js       │
│  SmartSearchService     │  src/services/mcp/smart-search-service.js    │
│  QueryDocumentService   │  src/services/mcp/query-document-service.js  │
│  SummarizeDocService    │  src/services/mcp/summarize-document-svc.js  │
│  MCP Tool 등록          │  src/routes/mcp.js (수정)                     │
│                                                                          │
└─────────────────────────────────────────────────────────────────────────┘
```
