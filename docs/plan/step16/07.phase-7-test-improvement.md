# Phase 7: MCP 테스트 품질 개선

## 목표

Phase 1-6에서 작성된 테스트 코드의 품질 문제를 수정하여 테스트 신뢰성을 확보합니다.

## 선행 조건

- Phase 1-6 완료

---

## 발견된 문제점

### 7.1 구조적 문제

| 문제 | 심각도 | 영향 |
|------|--------|------|
| `describe()` 블록이 빈 함수로 호출됨 | 중간 | 논리적 그룹화 무의미 |
| 테스트가 describe 블록 외부에서 실행됨 | 중간 | 가독성 저하 |
| 전역 변수로 결과 추적 | 낮음 | 테스트 격리 약화 |

**현재 코드:**
```javascript
describe('mode: titles_only', () => {});  // 빈 함수!

if (await it('should return only file paths', async () => {
  // 테스트 코드가 describe 외부에서 실행
})) passed++; else failed++;
```

### 7.2 조건부 Assertion 문제 (심각)

| 파일 | 라인 | 문제 |
|------|------|------|
| smart-search.test.js | 267-272 | `if (result.documents.length > 0)` 조건부 검증 |
| smart-search.test.js | 274-279 | `if (result.documents.length > 0)` 조건부 검증 |
| search-mode.test.js | 238-242 | `if (contentMatches.length > 0)` 조건부 검증 |

**문제점:** 결과가 비어있으면 assertion이 실행되지 않아 **가짜 성공**이 됨

**현재 코드:**
```javascript
if (await it('should return documents with scores', async () => {
  const result = await serviceNoEmbed.smartSearch('SSL configuration');
  if (result.documents.length > 0) {  // 결과가 비면 검증 안 함!
    expect(result.documents[0].score).toBeGreaterThan(0);
  }
})) passed++; else failed++;
```

### 7.3 Cleanup 안정성 문제

| 파일 | 문제 |
|------|------|
| 모든 테스트 파일 | try-finally 없이 cleanup 코드가 마지막에 위치 |

**문제점:** 테스트 중간에 실패하면 임시 파일/디렉토리가 정리되지 않음

### 7.4 테스트 격리 문제

| 파일 | 문제 |
|------|------|
| smart-search.test.js | `serviceNoEmbed`, `serviceWithEmbed` 인스턴스를 여러 테스트에서 공유 |

**문제점:** 한 테스트가 서비스 상태를 변경하면 다른 테스트에 영향

### 7.5 누락된 테스트 케이스

| 카테고리 | 누락된 테스트 | 중요도 |
|----------|-------------|--------|
| 입력 검증 | 특수 문자 검색 (한글, 이모지) | 높음 |
| 입력 검증 | 잘못된 mode 값 처리 | 중간 |
| 경계값 | maxTokens = 0, 음수 | 중간 |
| 경계값 | limit = 0, 음수, 매우 큰 값 | 중간 |
| 대용량 | 1MB 이상 파일 처리 | 중간 |
| 인코딩 | UTF-8 BOM 파일 | 낮음 |

---

## 구현 체크리스트

### 7.1 조건부 Assertion 수정

- [x] smart-search.test.js - 결과 존재 먼저 검증 후 세부 assertion `2026-01-29`
- [x] search-mode.test.js - 결과 존재 먼저 검증 후 세부 assertion `2026-01-29`

### 7.2 Cleanup 안정성 개선

- [x] section-extractor.test.js - try-finally 추가 (파일 IO 없음, 생략) `2026-01-29`
- [x] query-document.test.js - try-finally 추가 `2026-01-29`
- [x] summarize-document.test.js - try-finally 추가 `2026-01-29`
- [x] smart-search.test.js - try-finally 추가 `2026-01-29`
- [x] search-mode.test.js - try-finally 추가 `2026-01-29`

### 7.3 누락된 테스트 추가

- [x] 한글 검색 테스트 `2026-01-29` (smart-search, search-mode)
- [ ] 잘못된 mode 값 테스트 (구현 검토 필요 - 현재 구현에서 기본값으로 폴백)
- [x] maxTokens 경계값 테스트 (0, 작은 값) `2026-01-29`
- [x] limit 경계값 테스트 (0, 큰 값) `2026-01-29`

### 7.4 describe 구조 개선

- [ ] describe 내부에 테스트 포함하도록 구조 변경 (Jest 전환 시 적용 예정)

---

## 수정 상세

### 7.1.1 조건부 Assertion 수정 패턴

**Before:**
```javascript
if (await it('should return documents with scores', async () => {
  const result = await serviceNoEmbed.smartSearch('SSL configuration');
  if (result.documents.length > 0) {
    expect(result.documents[0].score).toBeGreaterThan(0);
  }
})) passed++; else failed++;
```

**After:**
```javascript
if (await it('should return documents with scores', async () => {
  const result = await serviceNoEmbed.smartSearch('SSL configuration');
  // 먼저 결과가 있는지 검증
  expect(result.documents.length).toBeGreaterThan(0);
  // 그 다음 세부 검증
  expect(result.documents[0].score).toBeGreaterThan(0);
})) passed++; else failed++;
```

### 7.2.1 Cleanup 안정성 패턴

**Before:**
```javascript
async function runTests() {
  // 테스트 문서 준비
  await fs.mkdir(testDocsRoot, { recursive: true });
  // ... 테스트들 ...

  // 정리 (테스트 실패 시 실행 안 됨)
  await fs.rm(testDocsRoot, { recursive: true, force: true });
}
```

**After:**
```javascript
async function runTests() {
  // 테스트 문서 준비
  await fs.mkdir(testDocsRoot, { recursive: true });

  try {
    // ... 테스트들 ...
  } finally {
    // 항상 정리
    await fs.rm(testDocsRoot, { recursive: true, force: true });
  }
}
```

### 7.3.1 한글 검색 테스트

```javascript
if (await it('should search Korean text', async () => {
  // 한글 문서 생성
  await fs.writeFile(
    path.join(testDocsRoot, 'korean.md'),
    `# 설정 가이드\n\n한글 설정에 대한 설명입니다.`
  );

  const result = await searchDocuments(mockConfig, mockLogger, '설정', {
    mode: 'snippets'
  });

  expect(result.results.length).toBeGreaterThan(0);
  expect(result.results[0].path).toContain('korean.md');
})) passed++; else failed++;
```

### 7.3.2 잘못된 mode 값 테스트

```javascript
if (await it('should fallback to snippets for invalid mode', async () => {
  const result = await searchDocuments(mockConfig, mockLogger, 'test', {
    mode: 'invalid_mode'
  });

  // snippets로 폴백되거나 에러가 발생해야 함
  expect(result.mode === 'snippets' || result.mode === 'invalid_mode').toBe(true);
  // 또는 에러 처리 검증
})) passed++; else failed++;
```

### 7.3.3 경계값 테스트

```javascript
if (await it('should handle maxTokens = 0', async () => {
  const result = await serviceNoEmbed.smartSearch('SSL', { maxTokens: 0 });
  // 0 토큰 예산이면 결과가 비거나 최소 결과만
  expect(result.tokensUsed).toBeLessThanOrEqual(100); // 여유 허용
})) passed++; else failed++;

if (await it('should handle negative maxTokens as default', async () => {
  const result = await serviceNoEmbed.smartSearch('SSL', { maxTokens: -100 });
  // 음수는 기본값으로 처리되거나 에러
  expect(result.tokenBudget).toBeGreaterThan(0);
})) passed++; else failed++;
```

---

## 테스트 시나리오

### 수정 후 검증

**Given**: 모든 테스트 수정 완료

**When**: 테스트 실행

**Then**:
- 기존 74개 테스트 통과
- 새로 추가된 테스트 통과
- 테스트 실패 시에도 cleanup 정상 동작

---

## 영향받는 파일

| 파일 | 변경 유형 |
|------|----------|
| test/mcp/section-extractor.test.js | 구조 개선 |
| test/mcp/query-document.test.js | cleanup 개선, 구조 개선 |
| test/mcp/summarize-document.test.js | cleanup 개선, 구조 개선 |
| test/mcp/smart-search.test.js | 조건부 assertion 수정, cleanup 개선 |
| test/mcp/search-mode.test.js | 조건부 assertion 수정, cleanup 개선, 테스트 추가 |

---

## 완료 기준

- [x] 모든 조건부 assertion 수정 `2026-01-29`
- [x] 모든 테스트 파일에 try-finally cleanup 적용 `2026-01-29`
- [x] 한글 검색 테스트 추가 `2026-01-29`
- [x] 경계값 테스트 추가 `2026-01-29`
- [x] 기존 74개 + 신규 테스트 모두 통과 `2026-01-29` (82개 통과)

**Phase 7 완료: 2026-01-29** ✅

---

## 구현 순서

1. 조건부 assertion 수정 (가장 심각한 문제)
2. try-finally cleanup 적용
3. 누락된 테스트 추가
4. 전체 테스트 실행 및 검증

---

## 실제 결과

| 항목 | 수정 전 | 수정 후 |
|------|---------|---------|
| 총 테스트 수 | 74개 | **82개** |
| 조건부 assertion | 3개 | **0개** |
| Cleanup 안정성 | 없음 | **try-finally 적용** |
| 한글 검색 테스트 | 없음 | **2개 추가** |
| 경계값 테스트 | 없음 | **6개 추가** |

### 테스트 파일별 결과

| 파일 | 수정 전 | 수정 후 |
|------|---------|---------|
| section-extractor.test.js | 21개 | 21개 |
| query-document.test.js | 11개 | 11개 |
| summarize-document.test.js | 14개 | 14개 |
| smart-search.test.js | 15개 | **19개** (+4) |
| search-mode.test.js | 13개 | **17개** (+4) |
| **합계** | **74개** | **82개** |
