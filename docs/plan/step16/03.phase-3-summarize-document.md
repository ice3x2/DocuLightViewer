# Phase 3: summarize_document 도구 구현

## 목표

문서의 목차(TOC), 핵심 내용 요약, 통계 정보를 반환하는 MCP 도구를 구현합니다. 전체 문서를 읽지 않고도 구조를 파악할 수 있습니다.

## 선행 조건

- Phase 1 완료 (SectionExtractor - splitByHeadings 재활용)

## 아키텍처 참조

- [00-1.architecture.md](./00-1.architecture.md) Section 2.1, 3.5, 4.3

---

## 구현 체크리스트

### 3.1 SummarizeDocumentService 클래스 생성

- [x] `src/services/mcp/summarize-document-service.js` 파일 생성 `2026-01-29`
- [x] 생성자에서 config, logger 주입 `2026-01-29`
- [x] `summarizeDocument(path)` 메서드 구현 `2026-01-29`

### 3.2 TOC 추출

- [x] `extractTOC(content)` 메서드 구현 `2026-01-29`
  - 모든 헤딩(#, ##, ###, ...) 추출
  - 레벨, 텍스트, 앵커 ID 생성
  - 중첩 구조 표현

### 3.3 핵심 내용 추출

- [x] `extractKeyPoints(content)` 메서드 구현 `2026-01-29`
  - 첫 번째 단락 (문서 소개)
  - 각 주요 섹션의 첫 문장
  - 중요 키워드/용어 (굵은 글씨, 코드 블록 첫 줄 등)

### 3.4 통계 정보 생성

- [x] `getStatistics(content)` 메서드 구현 `2026-01-29`
  - 단어 수 (wordCount)
  - 문자 수 (charCount)
  - 섹션 수 (sectionCount)
  - 코드 블록 수 (codeBlockCount)
  - 추정 토큰 수 (estimatedTokens)

### 3.5 MCP Tool 등록

- [x] `src/routes/mcp.js`에 summarize_document 도구 정의 추가 `2026-01-29`
- [x] executeTool 함수에 케이스 추가 `2026-01-29`

---

## Tool 정의

```javascript
{
  name: 'summarize_document',
  description: 'Get a structured summary of a document including table of contents, key points, and statistics. Use this to understand document structure before deciding which sections to read in detail. Much more efficient than reading the full document.',
  inputSchema: {
    type: 'object',
    properties: {
      path: {
        type: 'string',
        description: 'Document path (e.g., guide/setup.md)'
      }
    },
    required: ['path']
  }
}
```

---

## 테스트 시나리오

### 정상 케이스

**Given**: 다중 섹션 문서 `/guide/complete-guide.md`
```markdown
# Complete Guide

This guide covers everything you need to know.

## Getting Started

First, install the dependencies...

### Prerequisites

- Node.js 18+
- npm 9+

### Installation

```bash
npm install doclight
```

## Configuration

Create `config.json5`:

```json5
{
  docsRoot: "/data"
}
```

## API Reference

### Endpoints

| Method | Path | Description |
|--------|------|-------------|
| GET | /api/tree | Get tree |

## Troubleshooting

If you encounter issues...
```

**When**: `summarize_document({ path: "guide/complete-guide.md" })`

**Then**:
```markdown
# Document Summary: /guide/complete-guide.md

## Title
Complete Guide

## Table of Contents
1. Getting Started
   1.1. Prerequisites
   1.2. Installation
2. Configuration
3. API Reference
   3.1. Endpoints
4. Troubleshooting

## Key Points
- This guide covers everything you need to know.
- Requires Node.js 18+ and npm 9+
- Configuration uses `config.json5` format
- API endpoints available at /api/*

## Statistics
- Words: ~250
- Characters: ~1,500
- Sections: 7
- Code blocks: 2
- Estimated tokens: ~400
```

---

### 예외 케이스

**Given**: 존재하지 않는 파일

**When**: `summarize_document({ path: "nonexistent.md" })`

**Then**: 에러 반환 (DOCUMENT_NOT_FOUND)

---

**Given**: 헤딩 없는 문서

**When**: `summarize_document({ path: "plain-text.md" })`

**Then**: TOC 비어있음, 첫 단락이 key point

---

### 경계값 테스트

**Given**: 빈 문서

**When**: `summarize_document({ path: "empty.md" })`

**Then**: 빈 TOC, 빈 key points, 모든 통계 0

---

## 테스트 코드 템플릿

```javascript
// test/mcp/summarize-document.test.js

const { SummarizeDocumentService } = require('../../src/services/mcp/summarize-document-service');
const path = require('path');
const fs = require('fs').promises;

describe('SummarizeDocumentService', () => {
  let service;
  let mockConfig;
  let mockLogger;
  const testDocsRoot = path.join(__dirname, '../test-source');

  beforeEach(() => {
    mockConfig = { docsRoot: testDocsRoot, excludes: [] };
    mockLogger = { info: jest.fn(), warn: jest.fn(), error: jest.fn(), debug: jest.fn() };
    service = new SummarizeDocumentService(mockConfig, mockLogger);
  });

  describe('extractTOC', () => {
    it('should extract headings as TOC', () => {
      const content = `# Title
## Section A
### Subsection A.1
## Section B`;

      const toc = service.extractTOC(content);

      expect(toc).toHaveLength(4);
      expect(toc[0]).toEqual({ level: 1, text: 'Title', anchor: 'title' });
      expect(toc[1]).toEqual({ level: 2, text: 'Section A', anchor: 'section-a' });
      expect(toc[2]).toEqual({ level: 3, text: 'Subsection A.1', anchor: 'subsection-a1' });
    });

    it('should return empty array for document without headings', () => {
      const content = 'Just plain text.';

      const toc = service.extractTOC(content);

      expect(toc).toHaveLength(0);
    });
  });

  describe('extractKeyPoints', () => {
    it('should extract first paragraph and section summaries', () => {
      const content = `# Guide
This is the introduction paragraph.

## Setup
First step is to install.

## Usage
Run the command to start.`;

      const keyPoints = service.extractKeyPoints(content);

      expect(keyPoints).toContain('This is the introduction paragraph.');
      expect(keyPoints.some(p => p.includes('install'))).toBe(true);
    });
  });

  describe('getStatistics', () => {
    it('should count words, chars, sections, and code blocks', () => {
      const content = `# Title
Some text here.

## Section
More text.

\`\`\`js
code
\`\`\``;

      const stats = service.getStatistics(content);

      expect(stats.wordCount).toBeGreaterThan(0);
      expect(stats.charCount).toBeGreaterThan(0);
      expect(stats.sectionCount).toBe(2);
      expect(stats.codeBlockCount).toBe(1);
    });
  });

  describe('summarizeDocument', () => {
    beforeAll(async () => {
      await fs.mkdir(testDocsRoot, { recursive: true });
      await fs.writeFile(
        path.join(testDocsRoot, 'summary-test.md'),
        `# Test Doc
Intro text.

## Section One
Content one.

## Section Two
Content two.`
      );
    });

    afterAll(async () => {
      await fs.rm(testDocsRoot, { recursive: true, force: true });
    });

    it('should return complete summary', async () => {
      const result = await service.summarizeDocument('summary-test.md');

      expect(result.title).toBe('Test Doc');
      expect(result.toc).toHaveLength(3);
      expect(result.keyPoints.length).toBeGreaterThan(0);
      expect(result.stats.sectionCount).toBe(3);
    });
  });
});
```

---

## 출력 포맷 예시

```markdown
# Document Summary: /guide/setup.md

## Title
Setup Guide

## Table of Contents
1. Prerequisites
2. Installation
3. Configuration
   3.1. Basic Settings
   3.2. Advanced Options
4. Running the Server
5. Troubleshooting

## Key Points
- Requires Node.js 18+ and npm 9+
- Configuration file: config.json5
- Default port: 3000
- Supports SSL/TLS

## Statistics
| Metric | Value |
|--------|-------|
| Words | 1,234 |
| Characters | 7,890 |
| Sections | 8 |
| Code blocks | 5 |
| Estimated tokens | 1,600 |
```

---

## 회귀 테스트 실행 조건

- [x] Phase 1 테스트 통과 `2026-01-29` (21/21)
- [x] Phase 2 테스트 통과 `2026-01-29` (11/11)
- [x] 기존 MCP 도구 테스트 통과 `2026-01-29`
- [x] 새 summarize-document 테스트 통과 `2026-01-29` (14/14)

---

## 구현 순서

1. SummarizeDocumentService 클래스 스켈레톤 생성
2. extractTOC 구현 및 테스트
3. extractKeyPoints 구현 및 테스트
4. getStatistics 구현 및 테스트
5. summarizeDocument 통합 및 포맷팅
6. MCP Tool 등록 (mcp.js)
7. 통합 테스트

---

## 예상 파일 구조

```
src/services/mcp/
├── index.js                          # 모듈 exports (업데이트)
├── section-extractor.js              # Phase 1
├── query-document-service.js         # Phase 2
└── summarize-document-service.js     # Phase 3 (새 파일)

test/mcp/
├── section-extractor.test.js         # Phase 1
├── query-document.test.js            # Phase 2
└── summarize-document.test.js        # Phase 3 (새 파일)
```

---

## 완료 기준

- [x] 모든 체크리스트 항목 완료 `2026-01-29`
- [x] 테스트 커버리지 ≥80% `2026-01-29` (14개 테스트 케이스)
- [x] MCP 호출 테스트 통과 `2026-01-29`
- [x] 문서화 완료 (JSDoc) `2026-01-29`

**Phase 3 완료: 2026-01-29** ✅
