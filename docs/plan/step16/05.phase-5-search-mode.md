# Phase 5: DocuLight_search 모드 개선

## 목표

기존 `DocuLight_search` 도구에 `mode` 파라미터를 추가하여 결과 상세도를 조절할 수 있게 합니다. 하위 호환성을 유지합니다.

## 선행 조건

- Phase 1 완료 (SectionExtractor)

## 아키텍처 참조

- [00-1.architecture.md](./00-1.architecture.md) Section 5.1

---

## 구현 체크리스트

### 5.1 모드 정의

- [x] `titles_only`: 파일명과 문서 제목만 반환 (최소 토큰) `2026-01-29`
- [x] `snippets`: 매칭된 줄 ±2줄 컨텍스트 (기본값, 기존 동작) `2026-01-29`
- [x] `full_context`: 매칭된 섹션 전체 (상세 분석 필요시) `2026-01-29`

### 5.2 search-service.js 수정

- [x] `searchDocuments` 함수에 `mode` 옵션 추가 `2026-01-29`
- [x] 모드별 반환 데이터 조절 `2026-01-29`
- [x] 기존 동작 유지 (mode 없으면 snippets) `2026-01-29`

### 5.3 mcp.js 수정

- [x] DocuLight_search inputSchema에 mode 추가 `2026-01-29`
- [x] executeTool에서 mode 전달 `2026-01-29`
- [x] 출력 포맷 모드별 조정 `2026-01-29`

---

## Tool 정의 (수정)

```javascript
{
  name: 'DocuLight_search',
  description: 'Search for documents containing specific text. Use mode="titles_only" for minimal output (file list only), "snippets" (default) for matched lines with context, or "full_context" for complete sections.',
  inputSchema: {
    type: 'object',
    properties: {
      query: {
        type: 'string',
        description: 'Search query (minimum 2 characters)'
      },
      limit: {
        type: 'integer',
        description: 'Maximum number of results to return (1-100)',
        default: 10
      },
      path: {
        type: 'string',
        description: 'Search within directory (default: /)',
        default: '/'
      },
      mode: {
        type: 'string',
        enum: ['titles_only', 'snippets', 'full_context'],
        description: 'Result detail level: titles_only (minimal), snippets (default), full_context (detailed)',
        default: 'snippets'
      }
    },
    required: ['query']
  }
}
```

---

## 모드별 출력 비교

### titles_only (최소 토큰)

```markdown
# Search Results for "configuration"

**Mode**: titles_only
**Matches**: 5 files

1. /guide/setup.md - "Setup Guide"
2. /guide/advanced.md - "Advanced Configuration"
3. /reference/config.md - "Configuration Reference"
4. /faq/common.md - "Common Questions"
5. /tutorial/first-app.md - "First App Tutorial"

**Tokens used**: ~50
```

### snippets (기본, 기존 동작)

```markdown
# Search Results for "configuration"

**Mode**: snippets
**Matches**: 5 files

## 1. /guide/setup.md

**Line 45**: ...create a `configuration` file...
```
// config.json5
{
  docsRoot: "/data"
}
```
...

## 2. /guide/advanced.md

**Line 12**: The **configuration** options include...

**Tokens used**: ~500
```

### full_context (전체 섹션)

```markdown
# Search Results for "configuration"

**Mode**: full_context
**Matches**: 3 files (limited for token budget)

## 1. /guide/setup.md

### Configuration

To configure DocLight, create a `config.json5` file in your project root.

#### Basic Settings

```json5
{
  docsRoot: "/data/docs",
  port: 3000,
  apiKey: "your-api-key"
}
```

#### Advanced Settings

For advanced users, additional options are available...

**Tokens used**: ~2000
```

---

## 테스트 시나리오

### 정상 케이스

**Given**: 문서에 "config" 포함

**When**: `DocuLight_search({ query: "config", mode: "titles_only" })`

**Then**: 파일명과 제목만 반환, 내용 없음

---

**Given**: 문서에 "config" 포함

**When**: `DocuLight_search({ query: "config", mode: "snippets" })` 또는 mode 없음

**Then**: 기존 동작 유지, 매칭 줄 + 컨텍스트

---

**Given**: 문서에 "config" 포함

**When**: `DocuLight_search({ query: "config", mode: "full_context" })`

**Then**: 매칭된 섹션 전체 반환

---

### 예외 케이스

**Given**: 잘못된 mode 값

**When**: `DocuLight_search({ query: "test", mode: "invalid" })`

**Then**: 에러 반환 또는 기본값(snippets) 사용

---

### 하위 호환성

**Given**: 기존 호출 (mode 없음)

**When**: `DocuLight_search({ query: "test" })`

**Then**: 기존과 동일한 결과 (snippets 모드)

---

## 테스트 코드 템플릿

```javascript
// test/mcp/search-mode.test.js

const { searchDocuments } = require('../../src/services/search-service');
const path = require('path');
const fs = require('fs').promises;

describe('DocuLight_search modes', () => {
  const testDocsRoot = path.join(__dirname, '../test-source');
  let mockConfig;
  let mockLogger;

  beforeAll(async () => {
    await fs.mkdir(testDocsRoot, { recursive: true });
    await fs.writeFile(
      path.join(testDocsRoot, 'config-guide.md'),
      `# Configuration Guide

## Basic Configuration

Create config.json5 with these options:

\`\`\`json5
{
  docsRoot: "/data"
}
\`\`\`

## Advanced Configuration

For power users, additional settings are available.
`
    );
  });

  afterAll(async () => {
    await fs.rm(testDocsRoot, { recursive: true, force: true });
  });

  beforeEach(() => {
    mockConfig = { docsRoot: testDocsRoot, excludes: [] };
    mockLogger = { info: jest.fn(), warn: jest.fn(), error: jest.fn(), debug: jest.fn() };
  });

  describe('mode: titles_only', () => {
    it('should return only file paths and titles', async () => {
      const result = await searchDocuments(mockConfig, mockLogger, 'configuration', {
        mode: 'titles_only'
      });

      expect(result.results[0].matches).toBeUndefined();
      // 또는 matches가 비어있음
      expect(result.results[0].path).toBeDefined();
      expect(result.results[0].title).toBeDefined();
    });
  });

  describe('mode: snippets (default)', () => {
    it('should return matched lines with context', async () => {
      const result = await searchDocuments(mockConfig, mockLogger, 'configuration', {
        mode: 'snippets'
      });

      expect(result.results[0].matches).toBeDefined();
      expect(result.results[0].matches.length).toBeGreaterThan(0);
      expect(result.results[0].matches[0].context).toBeDefined();
    });

    it('should be default when mode not specified', async () => {
      const withMode = await searchDocuments(mockConfig, mockLogger, 'configuration', {
        mode: 'snippets'
      });
      const withoutMode = await searchDocuments(mockConfig, mockLogger, 'configuration', {});

      expect(withMode.results[0].matches.length).toBe(withoutMode.results[0].matches.length);
    });
  });

  describe('mode: full_context', () => {
    it('should return full sections containing match', async () => {
      const result = await searchDocuments(mockConfig, mockLogger, 'configuration', {
        mode: 'full_context'
      });

      expect(result.results[0].sections).toBeDefined();
      // 섹션 전체 내용 포함
      expect(result.results[0].sections[0].content.length).toBeGreaterThan(100);
    });
  });
});
```

---

## 구현 상세

### search-service.js 수정

```javascript
// 기존 searchDocuments 함수 수정

async function searchDocuments(config, logger, query, options = {}) {
  const {
    limit = 10,
    path: searchPath = '/',
    highlight = true,
    includeContext = true,
    maxMatchesPerFile = 3,
    mode = 'snippets'  // 새 옵션
  } = options;

  // ... 기존 검색 로직 ...

  // 모드별 결과 포맷팅
  if (mode === 'titles_only') {
    return formatTitlesOnly(results);
  } else if (mode === 'full_context') {
    return formatFullContext(results, config, logger);
  } else {
    // snippets (기존 동작)
    return formatSnippets(results);
  }
}

function formatTitlesOnly(results) {
  return results.map(r => ({
    path: r.path,
    title: extractTitle(r.content) || r.name
  }));
}

function formatFullContext(results, config, logger) {
  // SectionExtractor 사용하여 매칭된 섹션 전체 추출
}

function formatSnippets(results) {
  // 기존 로직
}
```

---

## 회귀 테스트 실행 조건

- [x] 기존 DocuLight_search 테스트 통과 (하위 호환성) `2026-01-29`
- [x] 새 모드별 테스트 통과 `2026-01-29` (13/13)
- [x] MCP 호출 테스트 통과 `2026-01-29`

---

## 구현 순서

1. search-service.js에 mode 옵션 추가
2. formatTitlesOnly 구현
3. formatFullContext 구현 (SectionExtractor 연동)
4. 기존 동작을 formatSnippets로 분리
5. mcp.js에 mode 파라미터 추가
6. 테스트 작성 및 통과
7. 하위 호환성 검증

---

## 토큰 사용량 비교

| 모드 | 예상 토큰 | 용도 |
|------|----------|------|
| titles_only | 50-100 | 문서 목록 파악 |
| snippets | 300-500 | 일반 검색 |
| full_context | 1000-2000 | 상세 분석 |

---

## 완료 기준

- [x] 모든 체크리스트 항목 완료 `2026-01-29`
- [x] 하위 호환성 100% 유지 `2026-01-29`
- [x] 모드별 테스트 통과 `2026-01-29`
- [x] 기존 테스트 회귀 없음 `2026-01-29`

**Phase 5 완료: 2026-01-29** ✅
