# Step 16: MCP 효율성 개선 - 구현 계획

## 개요

**목적**: DocLight MCP의 토큰 효율성을 80-90% 개선하여 AI 에이전트의 컨텍스트 비용을 절감합니다.

**핵심 아이디어**: Context7 MCP처럼 쿼리 기반 선택적 정보 제공

**예상 효과**:
| 시나리오 | 현재 | 개선 후 | 절감률 |
|----------|------|---------|--------|
| 5,000자 문서에서 특정 정보 검색 | 5,000 토큰 | 500 토큰 | 90% |
| 10개 문서 검색 | 10,000 토큰 | 1,500 토큰 | 85% |
| 문서 구조 파악 | 5,000 토큰 | 300 토큰 | 94% |

---

## 문서 목록

### 아키텍처 문서

| 문서 | 설명 | 상태 |
|------|------|------|
| [00-1.architecture.md](./00-1.architecture.md) | 시스템 아키텍처, 컴포넌트, 클래스, 시퀀스 다이어그램 | 완료 |
| [00-2.tech-decisions.md](./00-2.tech-decisions.md) | 기술 결정 기록 (ADR) | 완료 |

### Phase 구현 문서

| Phase | 문서 | 설명 | 우선순위 | 상태 |
|-------|------|------|----------|------|
| 1 | [01.phase-1-section-extractor.md](./01.phase-1-section-extractor.md) | 섹션 추출기 구현 | P0 | ✅ 완료 |
| 2 | [02.phase-2-query-document.md](./02.phase-2-query-document.md) | query_document 도구 구현 | P0 | ✅ 완료 |
| 3 | [03.phase-3-summarize-document.md](./03.phase-3-summarize-document.md) | summarize_document 도구 구현 | P1 | ✅ 완료 |
| 4 | [04.phase-4-smart-search.md](./04.phase-4-smart-search.md) | 하이브리드 스마트 검색 구현 | P1 | ✅ 완료 |
| 5 | [05.phase-5-search-mode.md](./05.phase-5-search-mode.md) | 기존 DocuLight_search 개선 | P2 | ✅ 완료 |
| 6 | [06.phase-6-tool-descriptions.md](./06.phase-6-tool-descriptions.md) | 도구 설명 개선 | P2 | ✅ 완료 |
| 7 | [07.phase-7-test-improvement.md](./07.phase-7-test-improvement.md) | 테스트 품질 개선 | P2 | ✅ 완료 |

### 검증 문서

| 문서 | 설명 | 상태 |
|------|------|------|
| [integration-test-guide.md](./integration-test-guide.md) | 통합 테스트 가이드 | 대기 |
| [final-validation.md](./final-validation.md) | 최종 검증 보고서 | 대기 |
| [verification/](./verification/) | Phase별 검증 문서 | 대기 |

---

## Phase 의존성 그래프

```
┌─────────────────────────────────────────────────────────────────────────┐
│                        Phase Dependencies                                │
├─────────────────────────────────────────────────────────────────────────┤
│                                                                          │
│  Phase 1: Section Extractor (기반)                                       │
│      │                                                                   │
│      ├─────────────────────┬─────────────────────┐                      │
│      │                     │                     │                      │
│      ▼                     ▼                     ▼                      │
│  Phase 2              Phase 3              Phase 4                      │
│  query_document       summarize_doc        smart_search                 │
│      │                     │                     │                      │
│      └─────────────────────┴─────────────────────┘                      │
│                            │                                             │
│                            ▼                                             │
│                       Phase 5                                            │
│                   search mode 개선                                       │
│                            │                                             │
│                            ▼                                             │
│                       Phase 6                                            │
│                   도구 설명 개선                                          │
│                                                                          │
└─────────────────────────────────────────────────────────────────────────┘
```

---

## 새로운 MCP 도구 요약

### 1. DocuLight_smart_search (Phase 4)

```json
{
  "name": "DocuLight_smart_search",
  "description": "Search documents using semantic search (if embedding configured) or keyword search (fallback). Returns only relevant sections to minimize token usage.",
  "inputSchema": {
    "type": "object",
    "properties": {
      "query": { "type": "string", "description": "Search query" },
      "path": { "type": "string", "default": "/" },
      "mode": { "type": "string", "enum": ["auto", "semantic", "keyword"], "default": "auto" },
      "maxTokens": { "type": "integer", "default": 2000 },
      "limit": { "type": "integer", "default": 5 }
    },
    "required": ["query"]
  }
}
```

### 2. query_document (Phase 2)

```json
{
  "name": "query_document",
  "description": "Search within a specific document and return only relevant sections.",
  "inputSchema": {
    "type": "object",
    "properties": {
      "path": { "type": "string", "description": "Document path" },
      "query": { "type": "string", "description": "What information you need" },
      "maxTokens": { "type": "integer", "default": 2000 }
    },
    "required": ["path", "query"]
  }
}
```

### 3. summarize_document (Phase 3)

```json
{
  "name": "summarize_document",
  "description": "Get a structured summary of a document including TOC and key points.",
  "inputSchema": {
    "type": "object",
    "properties": {
      "path": { "type": "string", "description": "Document path" }
    },
    "required": ["path"]
  }
}
```

### 4. DocuLight_search 개선 (Phase 5)

```json
{
  "name": "DocuLight_search",
  "description": "Search for documents containing specific text",
  "inputSchema": {
    "type": "object",
    "properties": {
      "query": { "type": "string" },
      "limit": { "type": "integer", "default": 10 },
      "path": { "type": "string", "default": "/" },
      "mode": { "type": "string", "enum": ["titles_only", "snippets", "full_context"], "default": "snippets" }
    },
    "required": ["query"]
  }
}
```

---

## 기존 코드 재활용 계획

| Step 16 기능 | 재활용 모듈 | 설명 |
|--------------|------------|------|
| 키워드 검색 | `search-service.js` | 기존 텍스트 검색 로직 |
| 벡터 검색 | `vector-store.js` | chatbot 모듈의 VectorStoreManager |
| 임베딩 생성 | `embedding-factory.js` | OpenAI, Azure, Ollama 지원 |
| 토큰 추정 | `token-estimator.js` | 한글/영어 토큰 추정 |
| 경로 검증 | `path-validator.js` | 경로 보안 검증 |

---

## 성공 기준

### 정량적 목표

| 지표 | 목표 | 측정 방법 |
|------|------|----------|
| 토큰 절감률 | ≥80% | 동일 쿼리 대비 반환 토큰 비교 |
| 응답 시간 | ≤2초 | 평균 응답 시간 측정 |
| 하위 호환성 | 100% | 기존 MCP 도구 동작 확인 |

### 정성적 목표

- [x] AI가 적절한 도구를 선택하도록 설명 개선 `2026-01-29`
- [x] 임베딩 미설정 환경에서 정상 동작 `2026-01-29`
- [x] 에러 상황에서 graceful degradation `2026-01-29`

---

## 참고 문서

- [MCP 효율성 연구 보고서](../../research/mcp-efficiency-research.md)
- [Context7 MCP 아키텍처](https://github.com/upstash/context7)
- [MCP 공식 문서](https://modelcontextprotocol.io/)
- [Step 15 아키텍처](../step15/00-1.architecture.md)

---

## 변경 이력

| 버전 | 날짜 | 설명 |
|------|------|------|
| 1.0.0 | 2026-01-28 | 초기 작성 |
| 1.1.0 | 2026-01-29 | Phase 1-6 완료, 74개 테스트 통과 |
| 1.2.0 | 2026-01-29 | Phase 7 테스트 품질 개선, 82개 테스트 통과 |
