# Phase 1: i18n 인프라 구축

## 목표

문자열 국제화의 기반 시스템을 구축한다. Locale JSON 파일, 문자열 로더 모듈, Renderer 전달 IPC를 만든다.

## 선행 조건

- 없음 (첫 번째 Phase)

## 구현 체크리스트

### 1.1 Locale JSON 파일 생성

**파일**: `src/locales/en.json` (신규), `src/locales/ko.json` (신규)

모든 i18n 대상 문자열을 키-값 쌍으로 정의한다.

**키 네이밍 규칙**: `{영역}.{하위영역}.{항목}` (dot-notation)

```json
// en.json 예시 (일부)
{
  "tray.newViewer": "New Viewer",
  "tray.closeAll": "Close All Windows",
  "tray.settings": "Settings",
  "tray.quit": "Quit DocuLight",
  "tray.overflow": "{count} more...",
  "tray.windowFallback": "Window {windowId}",

  "settings.pageTitle": "DocuLight Settings",
  "settings.heading": "Settings",
  "settings.theme": "Theme",
  "settings.fontSize": "Font Size (px)",
  "settings.fontFamily": "Font Family",
  "settings.codeTheme": "Code Theme",
  "settings.mcpPort": "MCP Server Port",
  "settings.mcpPortHint": "Requires app restart after change",
  "settings.defaultWindowSize": "Default Window Size",
  "settings.windowSizeAuto": "Auto (remember last size)",
  "settings.windowSizeSmall": "Small",
  "settings.windowSizeMedium": "Medium",
  "settings.windowSizeLarge": "Large",
  "settings.windowSizeFull": "Full Screen",
  "settings.fileAssociation": "File Association",
  "settings.fileAssocCheckbox": "Register as default app for .md files",
  "settings.openDefaultApps": "Open system default apps settings",
  "settings.resetButton": "Reset to Defaults",
  "settings.saveButton": "Save",
  "settings.savedMessage": "Settings saved",
  "settings.resetConfirm": "Reset all settings to defaults?",
  "settings.processing": "Processing...",
  "settings.errorPrefix": "Error: {message}",
  "settings.unsupported": "Only available in built app",
  "settings.cannotCheckStatus": "Cannot check status",
  "settings.hintMac": "After registration, select default app in System Settings",
  "settings.hintWindows": "After registration, select DocuLight in 'Open with'",
  "settings.hintLinux": "Registered via XDG MIME",

  "viewer.tocHeader": "Table of Contents",
  "viewer.sidebarToggle": "File List (Ctrl+B)",
  "viewer.tocToggle": "Table of Contents",
  "viewer.pinToggle": "Always on Top",
  "viewer.navigation": "Navigation",
  "viewer.dropHint": "Drag a Markdown file here",
  "viewer.dropFileType": "Only .md files are supported",
  "viewer.mermaidError": "Mermaid rendering error: {message}",
  "viewer.largeDocWarning": "This document is very large ({sizeMB}MB). Rendering may take a while.",
  "viewer.untitled": "Untitled",

  "fileAssoc.registered": "File association registered",
  "fileAssoc.unregistered": "File association removed",
  "fileAssoc.unsupported": "Only available in built app",
  "fileAssoc.noPlist": "Only available in built app",
  "fileAssoc.moveToApps": "Move to Applications folder before registering",
  "fileAssoc.noLsregister": "lsregister not found",
  "fileAssoc.macSuccess": "Registration complete. Select default app in System Settings.",
  "fileAssoc.macUnregistered": "File association removed",
  "fileAssoc.linuxRegistered": "File association registered",
  "fileAssoc.linuxUnregistered": "File association removed",
  "fileAssoc.unsupportedPlatform": "Unsupported platform: {platform}",

  "error.maxWindows": "Maximum number of windows ({max}) reached",
  "error.contentRequired": "Either content or filePath must be provided",
  "error.mdOnly": "Only .md files are supported: {filePath}",
  "error.windowNotFound": "Window not found: {windowId}",
  "error.contentRequiredUpdate": "Either content or filePath must be provided for update"
}
```

`ko.json`은 동일 키에 한국어 값을 넣는다.

### 1.2 Strings 모듈 생성

**파일**: `src/main/strings.js` (신규)

```js
'use strict';

const { app } = require('electron');
const path = require('path');
const fs = require('fs');

const SUPPORTED_LOCALES = ['ko', 'en'];
const DEFAULT_LOCALE = 'en';

let strings = {};
let currentLocale = DEFAULT_LOCALE;

/**
 * 시스템 언어를 감지하고 locale 파일을 로드한다.
 * app.isReady() 이후에 호출해야 한다.
 */
function init() {
  const systemLocale = app.getLocale();  // e.g. "ko", "ko-KR", "en-US"
  const lang = systemLocale.split('-')[0].toLowerCase();

  currentLocale = SUPPORTED_LOCALES.includes(lang) ? lang : DEFAULT_LOCALE;

  const localePath = path.join(__dirname, '..', 'locales', `${currentLocale}.json`);
  const fallbackPath = path.join(__dirname, '..', 'locales', `${DEFAULT_LOCALE}.json`);

  try {
    strings = JSON.parse(fs.readFileSync(localePath, 'utf-8'));
  } catch {
    strings = JSON.parse(fs.readFileSync(fallbackPath, 'utf-8'));
    currentLocale = DEFAULT_LOCALE;
  }
}

/**
 * 키에 해당하는 문자열을 반환한다.
 * 변수 치환 지원: t('key', { name: 'value' }) → "{name}" → "value"
 *
 * @param {string} key
 * @param {Record<string, string|number>} [vars]
 * @returns {string}
 */
function t(key, vars) {
  let str = strings[key];
  if (str === undefined) return key;  // 키 없으면 키 자체 반환

  if (vars) {
    for (const [k, v] of Object.entries(vars)) {
      str = str.replace(new RegExp(`\\{${k}\\}`, 'g'), String(v));
    }
  }

  return str;
}

/**
 * 전체 문자열 객체를 반환한다 (Renderer 전달용).
 * @returns {{ locale: string, strings: Record<string, string> }}
 */
function getAll() {
  return { locale: currentLocale, strings };
}

module.exports = { init, t, getAll };
```

### 1.3 Main Process 초기화

**파일**: `src/main/index.js`

`app.on('ready')` 콜백 최상단에 strings 초기화 추가:

```js
const { init: initStrings, t, getAll: getAllStrings } = require('./strings');

app.on('ready', async () => {
  initStrings();  // 시스템 언어 감지 + locale 로드
  Menu.setApplicationMenu(null);
  // ... 기존 코드
});
```

### 1.4 IPC Handler 추가

**파일**: `src/main/index.js` — `registerIpcHandlers()` 내부

```js
ipcMain.handle('get-strings', () => {
  return getAllStrings();
});
```

### 1.5 Preload Bridge 추가

**파일**: `src/main/preload.js`

```js
getStrings: () => ipcRenderer.invoke('get-strings'),
```

## 테스트 시나리오

### 정상 케이스

**TC-1.1**: 한국어 시스템에서 앱 시작
- Given: OS 언어가 `ko-KR`
- When: 앱 시작
- Then: `currentLocale === 'ko'`, 한국어 문자열 로드됨

**TC-1.2**: 영어 시스템에서 앱 시작
- Given: OS 언어가 `en-US`
- When: 앱 시작
- Then: `currentLocale === 'en'`, 영어 문자열 로드됨

### 예외 케이스

**TC-1.3**: 미지원 언어 시스템
- Given: OS 언어가 `ja`
- When: 앱 시작
- Then: `currentLocale === 'en'` (기본값 폴백)

**TC-1.4**: locale 파일 손상
- Given: `ko.json` 파일이 유효하지 않은 JSON
- When: 앱 시작
- Then: `en.json`으로 폴백, 앱 정상 동작

### 경계값

**TC-1.5**: 변수 치환
- Given: `t('tray.overflow', { count: 5 })`
- When: 호출
- Then: "5 more..." (en) 또는 "외 5개..." (ko) 반환

## Phase 완료 기준

- [ ] `src/locales/en.json` 생성, 모든 i18n 대상 키 포함
- [ ] `src/locales/ko.json` 생성, 동일 키에 한국어 값
- [ ] `src/main/strings.js` 생성, `init()` / `t()` / `getAll()` 동작
- [ ] `src/main/index.js`에서 `initStrings()` 호출
- [ ] `ipcMain.handle('get-strings')` 등록
- [ ] `preload.js`에 `getStrings` bridge 추가
- [ ] `t('key')` 호출 시 올바른 문자열 반환 확인
