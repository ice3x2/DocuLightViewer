# 00-2. 기술 결정 기록 (ADR) — DocLight Pivot

## ADR-001: Express → Electron 전환

| 항목 | 내용 |
|------|------|
| **결정** | Express 웹 서버를 완전 폐기하고 Electron 데스크톱 앱으로 전환 |
| **근거** | AI 에이전트가 MCP 프로토콜로 직접 뷰어를 제어하는 네이티브 데스크톱 앱이 더 적합 |
| **대안** | Express + WebSocket (기각: 브라우저 의존, MCP stdio 비호환) |
| **영향** | 기존 모든 서버 코드 제거, 클라이언트 코드 전면 재작성 |

## ADR-002: MCP Bridge ↔ Electron 분리 아키텍처

| 항목 | 내용 |
|------|------|
| **결정** | MCP stdio 서버와 Electron GUI를 별도 프로세스로 분리, Named Pipe/Unix Socket으로 통신 |
| **근거** | MCP 클라이언트가 spawn+stdio로 서버를 실행하므로 Electron과 stdin/stdout 공유 불가 |
| **대안** | Electron 내부에 MCP 서버 임베드 (기각: stdio 파이프 충돌), HTTP 기반 로컬 서버 (기각: 불필요한 복잡성) |
| **영향** | IPC 소켓 서버/클라이언트 구현 필요, ndjson 프레이밍 프로토콜 설계 |

## ADR-003: IPC 통신 — Named Pipe / Unix Domain Socket

| 항목 | 내용 |
|------|------|
| **결정** | Windows는 Named Pipe (`\\.\pipe\doclight-ipc`), macOS/Linux는 Unix Domain Socket (`/tmp/doclight-ipc.sock`) |
| **근거** | 로컬 프로세스 간 가장 빠르고 안전한 IPC 방식. Node.js `net` 모듈로 통합 처리 가능 |
| **대안** | localhost HTTP (기각: 포트 충돌 위험, 방화벽), Electron IPC (기각: 별도 프로세스 불가) |
| **프레이밍** | ndjson (Newline-delimited JSON) — 각 메시지는 `JSON + \n`, JSON 내 개행 불가 |

## ADR-004: Markdown 렌더링 — 클라이언트 사이드

| 항목 | 내용 |
|------|------|
| **결정** | 렌더러 프로세스에서 `marked` → `DOMPurify` → DOM 삽입 → `mermaid.run()` → `hljs.highlightAll()` |
| **근거** | 기존 검증된 파이프라인 유지, sandbox 렌더러에서 보안 강화 |
| **라이브러리 로딩** | `<script src="./lib/*.min.js">` 태그 (sandbox: true로 require 불가) |
| **보안** | `contextIsolation: true`, `nodeIntegration: false`, `sandbox: true`, CSP 메타 태그 |

## ADR-005: 사이드바 — Root-Preserving 네비게이션 모델

| 항목 | 내용 |
|------|------|
| **결정** | 최초 열린 문서 기준 트리를 한 번 빌드, 문서 이동 시 트리 유지, 하이라이트만 변경 |
| **근거** | Docusaurus/GitBook과 유사한 UX, 컨텍스트 유지, 재빌드 비용 절감 |
| **대안** | 문서 이동 시 매번 트리 재빌드 (기각: 성능 저하, UX 혼란) |

## ADR-006: 설정 관리 — electron-store

| 항목 | 내용 |
|------|------|
| **결정** | `electron-store` 사용 (JSON 파일 기반, 플랫폼별 기본 경로) |
| **근거** | Electron 생태계 표준, 자동 경로 관리, 스키마 검증 지원 |
| **대안** | JSON5 파일 직접 관리 (기각: 경로 관리/마이그레이션 복잡), SQLite (기각: 과도함) |

## ADR-007: 링크 파싱 — Main Process에서 실행

| 항목 | 내용 |
|------|------|
| **결정** | `marked.lexer()`로 토큰화 후 링크 추출, `fs` 접근이 필요하므로 메인 프로세스에서 수행 |
| **근거** | sandbox 렌더러에서는 파일시스템 접근 불가, 파일 존재 확인/읽기가 필수 |
| **영향** | `link-parser.js`가 `marked` 패키지에 의존 (메인 프로세스에서도 설치 필요) |

## ADR-008: 창 ID — UUID v4

| 항목 | 내용 |
|------|------|
| **결정** | `uuid` 패키지로 UUID v4 생성 |
| **근거** | 글로벌 유일성 보장, MCP 도구 간 참조에 적합, Node.js 내장 `crypto.randomUUID()` 대안 가능 |

## 외부 라이브러리 목록

### 프로덕션 의존성

| 패키지 | 버전 | 용도 | 설치 대상 |
|--------|------|------|-----------|
| `@modelcontextprotocol/sdk` | latest | MCP 서버 SDK (stdio) | Bridge 프로세스 |
| `electron-store` | ^8.x | 사용자 설정 영구 저장 | Main Process |
| `uuid` | ^9.x | 창 ID 생성 | Main Process |
| `marked` | ^17.x | Markdown 파싱 | Main + Renderer |
| `dompurify` | ^3.x | HTML 새니타이징 | Renderer (lib/) |
| `highlight.js` | ^11.x | 코드 하이라이팅 | Renderer (lib/) |
| `mermaid` | latest | 다이어그램 렌더링 | Renderer (lib/) |

### 개발 의존성

| 패키지 | 버전 | 용도 |
|--------|------|------|
| `electron` | ^33.x | Electron 런타임 |
| `electron-builder` | latest | 앱 패키징/배포 |

### 제거 패키지 (24개)

express, ejs, multer, archiver, adm-zip, ignore, winston, winston-daily-rotate-file, json5, async-lock, puppeteer, cookie-parser, jsdom, chokidar, @langchain/community, @langchain/core, @langchain/langgraph, @langchain/ollama, @langchain/openai, @langchain/textsplitters, langchain, hnswlib-node, zod, nodemon, @playwright/test, playwright, cross-env

## 호환성 확인

| 런타임 | 최소 버전 | 비고 |
|--------|-----------|------|
| Electron | 33.x | Chromium 130+, Node 20 내장 |
| Node.js | 20.x LTS | Bridge 프로세스용 |
| Windows | 10 (64-bit) | Named Pipe 지원 |
| macOS | 12 (Monterey) | Unix Socket 지원 |
| Linux | Ubuntu 20.04 | Unix Socket 지원 |

## 중복 코드 방지 원칙

| 원칙 | 적용 |
|------|------|
| 단일 진입점 | `index.js` (Electron), `mcp-server.js` (Bridge) — 2개만 |
| 공유 상수 없음 | 각 프로세스가 독립적으로 상수 정의 (프로세스 간 import 불가) |
| 렌더러 로직 단일 파일 | `viewer.js` 하나에 모든 렌더링 로직 집중 |
| 유틸리티 추출 금지 | 한 번만 사용되는 로직은 인라인, 추상화 최소화 |
| lib/ 중복 금지 | 라이브러리는 `src/renderer/lib/`에만 배치, npm과 중복 설치하지 않음 |
