# 00-1. 아키텍처 설계 — DocLight Electron + MCP Pivot

## 1. 시스템 컨텍스트

```
┌─────────────────────────┐
│  AI Agent (MCP Client)  │  Claude Desktop, Claude Code 등
│  stdin/stdout JSON-RPC  │
└───────────┬─────────────┘
            │ spawn + stdio pipe
            ▼
┌─────────────────────────┐
│  MCP Bridge Process     │  경량 Node.js (Electron 미의존)
│  (mcp-server.js)        │  @modelcontextprotocol/sdk
│  4 Tools:               │
│   open_markdown          │
│   update_markdown        │
│   close_viewer           │
│   list_viewers           │
└───────────┬─────────────┘
            │ Named Pipe (Win) / Unix Socket (macOS/Linux)
            │ ndjson 프레이밍
            ▼
┌──────────────────────────────────────────────────────┐
│              Electron Main Process                    │
│                                                       │
│  ┌──────────────┐ ┌───────────────┐ ┌─────────────┐  │
│  │ IPC Socket   │ │ Window Manager│ │ System Tray │  │
│  │ Server       │→│ (Map<id,BW>)  │ │             │  │
│  │              │ │               │ │ [Context     │  │
│  │ ndjson parse │ │ create/close  │ │  Menu]       │  │
│  └──────────────┘ │ navigate      │ └─────────────┘  │
│                   └───────┬───────┘                   │
│  ┌──────────────┐         │                           │
│  │ Link Parser  │         │ IPC (contextBridge)       │
│  │ (tree build) │         │                           │
│  └──────────────┘         │                           │
└───────────────────────────┼───────────────────────────┘
                            │
          ┌─────────────────┼─────────────────┐
          ▼                 ▼                 ▼
┌──────────────┐  ┌──────────────┐  ┌──────────────┐
│ Renderer #1  │  │ Renderer #2  │  │ Renderer #N  │
│ (Viewer BW)  │  │ (Viewer BW)  │  │ (Settings)   │
│              │  │              │  │              │
│ Sidebar+Main │  │ Main Only    │  │ Forms UI     │
│ marked+purify│  │ (no links)   │  │              │
│ mermaid+hljs │  │              │  │              │
└──────────────┘  └──────────────┘  └──────────────┘
```

## 2. 컴포넌트 다이어그램

### 2.1 Main Process 컴포넌트

| 컴포넌트 | 파일 | 책임 |
|----------|------|------|
| **App Lifecycle** | `src/main/index.js` | app.ready, 싱글 인스턴스 락, 트레이 생성, IPC 소켓 서버, 종료 처리 |
| **IPC Socket Server** | `src/main/index.js` (내장) | Named Pipe/Unix Socket 리스닝, ndjson 파싱, 요청 라우팅, 응답 반환 |
| **Window Manager** | `src/main/window-manager.js` | BrowserWindow 생성/닫기, Map 관리, 캐스케이딩 위치, 네비게이션 히스토리 |
| **Link Parser** | `src/main/link-parser.js` | Markdown 로컬 링크 파싱, 재귀 트리 빌드 (buildLinkTree) |
| **MCP Bridge** | `src/main/mcp-server.js` | stdio MCP 서버 (별도 프로세스), 4개 도구 등록, IPC 소켓 클라이언트 |
| **Preload** | `src/main/preload.js` | contextBridge API 노출 (doclight 네임스페이스) |

### 2.2 Renderer Process 컴포넌트

| 컴포넌트 | 파일 | 책임 |
|----------|------|------|
| **Viewer HTML** | `src/renderer/viewer.html` | 뷰어 레이아웃 (사이드바 + 본문), lib 로딩 |
| **Viewer Logic** | `src/renderer/viewer.js` | 렌더링 파이프라인 (marked→purify→DOM→mermaid→hljs), 사이드바 UI, 이벤트 핸들링 |
| **Viewer Style** | `src/renderer/viewer.css` | GitHub-flavored MD 스타일, 사이드바 레이아웃, 리사이즈, 테마 |
| **Libraries** | `src/renderer/lib/*.min.js` | marked, mermaid, highlight.js, purify (로컬 번들) |

### 2.3 컴포넌트 의존성 그래프

```
index.js ──→ window-manager.js
    │                │
    │                └──→ link-parser.js
    │
    └──→ [IPC Socket Server] ←──→ mcp-server.js (별도 프로세스)
    │
    └──→ [System Tray]

preload.js ──→ (Electron ipcRenderer)

viewer.js ──→ window.doclight (preload API)
    │
    ├──→ marked.min.js
    ├──→ purify.min.js
    ├──→ mermaid.min.js
    └──→ highlight.min.js
```

## 3. 클래스/모듈 다이어그램

### 3.1 Window Manager (window-manager.js)

```
WindowManager
├── Properties
│   ├── windows: Map<string, { win: BrowserWindow, meta: WindowMeta }>
│   ├── lastPosition: { x: number, y: number }
│   └── store: ElectronStore
│
├── Methods
│   ├── createWindow(opts: CreateWindowOpts): Promise<{ windowId, title }>
│   ├── closeWindow(windowId?: string): { closed: number }
│   ├── updateWindow(windowId, opts): Promise<{ title }>
│   ├── listWindows(): WindowInfo[]
│   ├── navigateTo(windowId, filePath): Promise<void>
│   ├── navigateBack(windowId): void
│   ├── navigateForward(windowId): void
│   ├── getNextPosition(): { x, y }
│   └── resolveWindowSize(size?: string): { width, height }
│
├── Constants
│   └── SIZE_PRESETS: { s: {480,680}, m: {720,1024}, l: {1080,1440}, f: 'fullscreen' }
│
└── Types
    ├── CreateWindowOpts { content?, filePath?, foreground?, title?, size?: 's'|'m'|'l'|'f' }
    ├── WindowMeta { windowId, filePath?, title, alwaysOnTop, size, history }
    └── WindowInfo { windowId, title, alwaysOnTop, size }

NavigationHistory
├── stack: string[]  (filePath 배열)
├── index: number    (현재 위치)
├── MAX_SIZE: 50
├── push(filePath): void
├── back(): string | null
└── forward(): string | null
```

### 3.2 Link Parser (link-parser.js)

```
LinkParser
├── Methods
│   ├── buildLinkTree(filePath, visited?, depth?): Promise<TreeNode | null>
│   ├── parseLocalLinks(markdown, basePath): string[]
│   └── extractTitle(markdown): string
│
├── Internal
│   ├── resolveLink(href, basePath): string | null
│   ├── isLocalMarkdownLink(href): boolean
│   ├── isExcludedExtension(ext): boolean
│   └── isInCodeBlock(token): boolean
│
└── Types
    └── TreeNode { path, title, exists, children: TreeNode[] }

Constants
├── MAX_DEPTH: 10
├── MAX_TREE_FILES: 200
├── EXCLUDED_EXTENSIONS: Set<string>
└── EXCLUDED_PROTOCOLS: Set<string>
```

### 3.3 MCP Bridge (mcp-server.js)

```
MCPBridge
├── Properties
│   ├── server: McpServer
│   ├── transport: StdioServerTransport
│   ├── ipcSocket: net.Socket | null
│   ├── pendingRequests: Map<string, { resolve, reject, timer }>
│   └── buffer: string  (ndjson 파싱 버퍼)
│
├── Methods
│   ├── start(): Promise<void>
│   ├── connectToElectron(): Promise<void>
│   ├── sendIpcRequest(action, params): Promise<any>
│   ├── handleIpcResponse(line: string): void
│   └── shutdown(): void
│
└── MCP Tools (등록)
    ├── open_markdown(args): Promise<MCPResult>
    ├── update_markdown(args): Promise<MCPResult>
    ├── close_viewer(args): Promise<MCPResult>
    └── list_viewers(): Promise<MCPResult>

Constants
├── IPC_TIMEOUT: 10000 (ms)
├── PIPE_PATH: platform-dependent
├── MAX_CONTENT_SIZE: 10485760 (10MB)
├── MAX_WINDOWS: 20
└── RECONNECT_INTERVAL: 500 (ms), MAX_RETRIES: 10
```

## 4. 시퀀스 다이어그램

### 4.1 MCP open_markdown (filePath 모드)

```
AI Agent          MCP Bridge           IPC Socket          Electron Main       Window Manager       Link Parser          Renderer
   │                  │                    │                    │                    │                    │                    │
   │ tools/call       │                    │                    │                    │                    │                    │
   │ open_markdown    │                    │                    │                    │                    │                    │
   │ {filePath}       │                    │                    │                    │                    │                    │
   │─────────────────→│                    │                    │                    │                    │                    │
   │                  │ validate input     │                    │                    │                    │                    │
   │                  │ generate req-id    │                    │                    │                    │                    │
   │                  │ send ndjson        │                    │                    │                    │                    │
   │                  │───────────────────→│                    │                    │                    │                    │
   │                  │                    │ route to handler   │                    │                    │                    │
   │                  │                    │───────────────────→│                    │                    │                    │
   │                  │                    │                    │ fs.readFile        │                    │                    │
   │                  │                    │                    │ validate .md ext   │                    │                    │
   │                  │                    │                    │ check window count │                    │                    │
   │                  │                    │                    │                    │                    │                    │
   │                  │                    │                    │ createWindow()     │                    │                    │
   │                  │                    │                    │───────────────────→│                    │                    │
   │                  │                    │                    │                    │ new BrowserWindow  │                    │
   │                  │                    │                    │                    │ loadFile(viewer)   │                    │
   │                  │                    │                    │                    │                    │                    │
   │                  │                    │                    │                    │←───────────────────────────────────────│
   │                  │                    │                    │                    │  window-ready      │                    │
   │                  │                    │                    │                    │ send render-markdown│                   │
   │                  │                    │                    │                    │───────────────────────────────────────→│
   │                  │                    │                    │                    │                    │                    │ render pipeline
   │                  │                    │                    │                    │                    │                    │
   │                  │                    │                    │ buildLinkTree()    │                    │                    │
   │                  │                    │                    │───────────────────────────────────────→│                    │
   │                  │                    │                    │                    │                    │ parse + recurse    │
   │                  │                    │                    │←───────────────────────────────────────│ tree               │
   │                  │                    │                    │                    │ send sidebar-tree  │                    │
   │                  │                    │                    │                    │───────────────────────────────────────→│
   │                  │                    │                    │                    │                    │                    │ sidebar render
   │                  │                    │                    │←───────────────────│ {windowId, title}  │                    │
   │                  │                    │←───────────────────│ ndjson response    │                    │                    │
   │                  │←───────────────────│                    │                    │                    │                    │
   │←─────────────────│ MCP result         │                    │                    │                    │                    │
   │ {windowId,title} │                    │                    │                    │                    │                    │
```

### 4.2 사이드바 문서 네비게이션

```
User              Renderer            preload API          Main Process         Window Manager
 │                    │                    │                    │                    │
 │ click sidebar item │                    │                    │                    │
 │───────────────────→│                    │                    │                    │
 │                    │ navigateTo(path)   │                    │                    │
 │                    │───────────────────→│                    │                    │
 │                    │                    │ ipc: navigate-to   │                    │
 │                    │                    │───────────────────→│                    │
 │                    │                    │                    │ navigateTo(wId,path)│
 │                    │                    │                    │───────────────────→│
 │                    │                    │                    │                    │ fs.readFile
 │                    │                    │                    │                    │ history.push
 │                    │                    │                    │                    │ send render-markdown
 │                    │                    │                    │                    │───→ Renderer
 │                    │                    │                    │                    │ (update highlight)
 │                    │←────────────────────────────────────────────────────────────│
 │                    │ render new doc     │                    │                    │
 │ see new document   │                    │                    │                    │
 │←───────────────────│                    │                    │                    │
```

## 5. 데이터 모델

### 5.1 인메모리 데이터 (Main Process)

```
// Window 상태
Map<string, {
  win: BrowserWindow,
  meta: {
    windowId: string,       // UUID v4
    filePath: string | null,
    title: string,
    alwaysOnTop: boolean,
    rootFilePath: string | null,  // 트리 루트 파일 (사이드바용)
    tree: TreeNode | null,        // 빌드된 트리 캐시
    history: NavigationHistory
  }
}>
```

### 5.2 영구 데이터 (electron-store)

```json
{
  "theme": "light",
  "fontSize": 16,
  "fontFamily": "system-ui, -apple-system, sans-serif",
  "codeTheme": "github",
  "defaultWindowWidth": 1000,
  "defaultWindowHeight": 750,
  "sidebarWidth": 260,
  "maxRecursionDepth": 10
}
```

### 5.3 IPC Socket 메시지 (ndjson)

```
// Request (Bridge → Electron)
{ "id": "uuid", "action": "open_markdown", "params": { ... } }

// Success Response (Electron → Bridge)
{ "id": "uuid", "result": { "windowId": "...", "title": "..." } }

// Error Response (Electron → Bridge)
{ "id": "uuid", "error": { "message": "..." } }
```

### 5.4 TreeNode 구조

```
TreeNode {
  path: string,          // 절대 파일 경로
  title: string,         // 표시명 (frontmatter title > H1 > 파일명)
  exists: boolean,       // 파일 존재 여부
  children: TreeNode[]   // 링크된 하위 문서
}
```

## 6. 패키지 구조

```
DocLight/
├── src/
│   ├── main/                        # Electron Main Process
│   │   ├── index.js                 # 앱 진입점 (트레이, IPC 소켓 서버, 생명주기)
│   │   ├── mcp-server.js            # MCP Bridge (별도 프로세스 진입점)
│   │   ├── window-manager.js        # 뷰어 창 CRUD + 네비게이션
│   │   ├── link-parser.js           # Markdown 링크 파싱 + 재귀 트리
│   │   └── preload.js               # contextBridge (doclight API)
│   │
│   └── renderer/                    # Electron Renderer Process
│       ├── viewer.html              # 뷰어 페이지 (사이드바 + 본문)
│       ├── viewer.js                # 렌더링 로직 + 사이드바 UI
│       ├── viewer.css               # GitHub-flavored MD 스타일 + 테마
│       └── lib/                     # 클라이언트 라이브러리 (로컬 번들)
│           ├── marked.min.js
│           ├── mermaid.min.js
│           ├── highlight.min.js
│           ├── highlight-github.min.css
│           └── purify.min.js
│
├── assets/                          # 정적 리소스
│   ├── icon.png                     # 앱/트레이 아이콘 (256x256)
│   ├── icon.ico                     # Windows 아이콘
│   └── icon.icns                    # macOS 아이콘
│
├── docs/                            # 프로젝트 문서 (유지)
│   └── plan/
│       └── pivot/                   # 이 구현 계획
│
├── package.json                     # Electron + MCP SDK 의존성
├── electron-builder.yml             # 빌드/패키징 설정
├── CLAUDE.md                        # 프로젝트 가이드 (재작성)
└── README.md                        # 사용자 가이드 (재작성)
```

**핵심 원칙:**
- `src/main/` — 5개 파일, 각 파일은 단일 책임
- `src/renderer/` — 3개 파일 (HTML+JS+CSS) + 라이브러리
- `mcp-server.js`는 별도 프로세스 진입점 (Electron 의존 없음)
- 기존 Express 코드 전체 제거 (중복/죽은 코드 0)
