# Phase 5: ë§í¬ íŒŒì„œ ë° ì‚¬ì´ë“œë°” ë„¤ë¹„ê²Œì´ì…˜ êµ¬í˜„

## ëª©í‘œ

`link-parser.js`ë¥¼ êµ¬í˜„í•˜ì—¬ Markdown ë¬¸ì„œ ë‚´ ë¡œì»¬ ë§í¬ë¥¼ ì¬ê·€ì ìœ¼ë¡œ íŒŒì‹±í•˜ê³  íŠ¸ë¦¬ êµ¬ì¡°ë¥¼ ë¹Œë“œí•œë‹¤. ë¹Œë“œëœ íŠ¸ë¦¬ë¥¼ ê¸°ë°˜ìœ¼ë¡œ ë·°ì–´ì˜ ì‚¬ì´ë“œë°” UIë¥¼ êµ¬í˜„í•˜ì—¬ ë¬¸ì„œ ê°„ ë„¤ë¹„ê²Œì´ì…˜ì„ ì§€ì›í•œë‹¤. Root-Preserving ëª¨ë¸ì— ë”°ë¼ ìµœì´ˆ ì—´ë¦° ë¬¸ì„œ ê¸°ì¤€ìœ¼ë¡œ íŠ¸ë¦¬ë¥¼ ìœ ì§€í•˜ê³ , ë¬¸ì„œ ì´ë™ ì‹œ í•˜ì´ë¼ì´íŠ¸ë§Œ ë³€ê²½í•œë‹¤.

## ì„ í–‰ ì¡°ê±´

- Phase 4 ì™„ë£Œ (ë·°ì–´ ë Œë”ë§ íŒŒì´í”„ë¼ì¸ ë™ì‘ â€” viewer.html, viewer.js, viewer.css)
- Phase 2ì˜ window-manager.jsì— NavigationHistory í´ë˜ìŠ¤ êµ¬í˜„ ì™„ë£Œ

## ì•„í‚¤í…ì²˜ ì°¸ì¡°

- [00-1.architecture.md](./00-1.architecture.md) Section 3.2 (Link Parser í´ë˜ìŠ¤/ëª¨ë“ˆ ë‹¤ì´ì–´ê·¸ë¨)
- [00-1.architecture.md](./00-1.architecture.md) Section 4.2 (ì‚¬ì´ë“œë°” ë¬¸ì„œ ë„¤ë¹„ê²Œì´ì…˜ ì‹œí€€ìŠ¤)

## SRS ì°¸ì¡°

- **FR-P-004**: ë§í¬ ê¸°ë°˜ ì‚¬ì´ë“œë°” ë„¤ë¹„ê²Œì´ì…˜ â€” íŒŒì‹± ê·œì¹™, ì¬ê·€ íŠ¸ë¦¬ ë¹Œë“œ, ì‚¬ì´ë“œë°” UI
- **AC-P-004**: ì¸ìˆ˜ ì¡°ê±´ â€” íŠ¸ë¦¬ í‘œì‹œ, ìˆœí™˜ ì°¸ì¡°, í´ë¦­ ë„¤ë¹„ê²Œì´ì…˜, ì¡´ì¬í•˜ì§€ ì•ŠëŠ” íŒŒì¼

---

## êµ¬í˜„ ì²´í¬ë¦¬ìŠ¤íŠ¸

### 5.1 `src/main/link-parser.js` ìƒì„±

- [ ] íŒŒì¼ ìƒì„±
- [ ] **ìƒìˆ˜ ì •ì˜**:
  ```javascript
  const MAX_DEPTH = 10;
  const MAX_TREE_FILES = 200;
  const DEPTH_CUTOFF = 5; // MAX_TREE_FILES ë„ë‹¬ ì‹œ ì´ ê¹Šì´ì—ì„œ ì¤‘ë‹¨

  const EXCLUDED_PROTOCOLS = new Set([
    'http:', 'https:', 'mailto:', 'tel:', 'ftp:', 'data:', 'javascript:', 'vbscript:'
  ]);

  const EXCLUDED_EXTENSIONS = new Set([
    '.png', '.jpg', '.jpeg', '.gif', '.svg', '.webp', '.bmp', '.ico',
    '.pdf', '.doc', '.docx', '.xls', '.xlsx', '.ppt', '.pptx',
    '.zip', '.tar', '.gz', '.7z', '.rar',
    '.exe', '.dmg',
    '.mp3', '.mp4', '.wav', '.avi', '.mov'
  ]);
  ```

- [ ] **`parseLocalLinks(markdown, basePath)`** êµ¬í˜„:
  - `marked.lexer(markdown)` ë¡œ í† í°í™”
  - `type === 'code'` ë° `type === 'codespan'` í† í° ìŠ¤í‚µ (ì½”ë“œ ë¸”ë¡ ë‚´ ë§í¬ ë¬´ì‹œ)
  - ë‚˜ë¨¸ì§€ í† í°ì—ì„œ ë§í¬ ì¶”ì¶œ â€” ì¬ê·€ì ìœ¼ë¡œ tokens ë°°ì—´ê³¼ í•˜ìœ„ tokensë¥¼ ìˆœíšŒ:
    - `type === 'link'` â†’ `token.href` ì¶”ì¶œ
    - `type === 'image'` â†’ ìŠ¤í‚µ (ì´ë¯¸ì§€ëŠ” ë„¤ë¹„ê²Œì´ì…˜ ëŒ€ìƒ ì•„ë‹˜)
  - ì°¸ì¡° ë§í¬ ì²˜ë¦¬: `tokens.links` ê°ì²´ì—ì„œ ì°¸ì¡° ì •ì˜ lookup
  - Wiki ë§í¬ (`[[path/to/file]]`) ì²˜ë¦¬:
    - ì •ê·œì‹ìœ¼ë¡œ ì›ë³¸ markdownì—ì„œ `\[\[([^\]]+)\]\]` íŒ¨í„´ ì¶”ì¶œ
    - ì½”ë“œ ë¸”ë¡ ë‚´ wiki ë§í¬ ì œì™¸ (lexer í† í° ìœ„ì¹˜ ê¸°ë°˜)
    - `.md` í™•ì¥ì ì—†ìœ¼ë©´ ìë™ ì¶”ê°€
    - basePath ê¸°ì¤€ìœ¼ë¡œ resolve
  - ê° ì¶”ì¶œëœ hrefì— ëŒ€í•´ í•„í„°ë§:
    - í”„ë¡œí† ì½œ ì²´í¬: EXCLUDED_PROTOCOLSì— í•´ë‹¹í•˜ë©´ ì œì™¸
    - `#`ìœ¼ë¡œë§Œ ì‹œì‘í•˜ëŠ” ì•µì»¤ ì „ìš© ë§í¬ ì œì™¸
    - URL ë””ì½”ë”©: `decodeURIComponent(href)` (`%20` â†’ ê³µë°± ë“±)
    - ì•µì»¤ ì œê±°: `href.split('#')[0]`
    - ì¿¼ë¦¬ ì œê±°: `href.split('?')[0]`
    - í™•ì¥ì ì²´í¬: `path.extname(resolved)` â†’ EXCLUDED_EXTENSIONSì— í•´ë‹¹í•˜ë©´ ì œì™¸
    - í™•ì¥ì ì—†ëŠ” ë§í¬ ì²˜ë¦¬:
      1. `path + '.md'` ì¡´ì¬ í™•ì¸ â†’ ìˆìœ¼ë©´ ì‚¬ìš©
      2. ì›ë³¸ `path` ì¡´ì¬ í™•ì¸ â†’ ìˆìœ¼ë©´ ë¬´ì‹œ (ë¹„-md íŒŒì¼)
      3. ë‘˜ ë‹¤ ì—†ìœ¼ë©´ ë¬´ì‹œ
    - ê²½ë¡œ resolve: `path.resolve(basePath, href)` + `path.normalize()`
    - ì‹¬ë³¼ë¦­ ë§í¬ ì²´í¬: `fs.lstatSync()` â€” isSymbolicLink() â†’ trueë©´ ì œì™¸
  - ì¤‘ë³µ ì œê±°: resolveëœ ì ˆëŒ€ ê²½ë¡œ ê¸°ì¤€ Setìœ¼ë¡œ í•„í„°
  - ë°˜í™˜: `string[]` (resolveëœ ì ˆëŒ€ ê²½ë¡œ ë°°ì—´)

- [ ] **`buildLinkTree(filePath, visited?, depth?)`** êµ¬í˜„:
  - ë§¤ê°œë³€ìˆ˜ ê¸°ë³¸ê°’: `visited = new Set()`, `depth = 0`
  - ê¹Šì´ ì²´í¬: `depth > MAX_DEPTH` â†’ `return null`
  - ìˆœí™˜ ì°¸ì¡° ë°©ì§€: `visited.has(path.normalize(filePath))` â†’ `return null`
  - `visited.add(path.normalize(filePath))`
  - íŒŒì¼ ì½ê¸°: `fs.readFileSync(filePath, 'utf-8')` â€” ì—ëŸ¬ ì‹œ `{ path: filePath, title: path.basename(filePath, '.md'), exists: false, children: [] }`
  - íƒ€ì´í‹€ ì¶”ì¶œ: `extractTitle(content)` || `path.basename(filePath, '.md')`
  - ë§í¬ íŒŒì‹±: `parseLocalLinks(content, path.dirname(filePath))`
  - ì´ íŒŒì¼ ìˆ˜ ì¹´ìš´íŒ… (ì™¸ë¶€ ì¹´ìš´í„° ë˜ëŠ” ì¬ê·€ ê²°ê³¼ ì§‘ê³„):
    - ëˆ„ì  200ê°œ ì´ˆê³¼ ì‹œ depth 5 ì´ìƒì—ì„œ ì¤‘ë‹¨
    - ì¤‘ë‹¨ ì‹œ `{ path: '...', title: '... (Nê°œ ë”)', exists: true, children: [] }` ì¸ë””ì¼€ì´í„° ë…¸ë“œ ì¶”ê°€
  - ê° ìì‹ ë§í¬ì— ëŒ€í•´ ì¬ê·€: `buildLinkTree(linkPath, new Set(visited), depth + 1)`
    - **í•µì‹¬**: ìì‹ë§ˆë‹¤ `new Set(visited)` â€” ë…ë¦½ì ì¸ ë¸Œëœì¹˜ ì¶”ì 
    - `null` ë°˜í™˜ ì‹œ childrenì— ì¶”ê°€í•˜ì§€ ì•ŠìŒ
  - ë°˜í™˜: `TreeNode { path, title, exists: true, children }`

- [ ] **`extractTitle(markdown)`** êµ¬í˜„:
  - ìš°ì„ ìˆœìœ„ 1: YAML frontmatterì˜ `title` í•„ë“œ
    - `---\n ... title: ì œëª© ... \n---` íŒ¨í„´ì—ì„œ ì¶”ì¶œ
    - ì •ê·œì‹: `/^---\n([\s\S]*?)\n---/`ì—ì„œ `title:` ë¼ì¸ íŒŒì‹±
  - ìš°ì„ ìˆœìœ„ 2: ì²« ë²ˆì§¸ H1 í—¤ë”©
    - `marked.lexer()`ì˜ ì²« ë²ˆì§¸ `type === 'heading'` && `depth === 1` í† í°ì˜ `text`
  - ìš°ì„ ìˆœìœ„ 3: íŒŒì¼ëª… (í™•ì¥ì ì œì™¸)
    - ì´ í•¨ìˆ˜ì—ì„œëŠ” null ë°˜í™˜, í˜¸ì¶œìê°€ `path.basename()` ì‚¬ìš©

- [ ] **ë‚´ë¶€ í—¬í¼ í•¨ìˆ˜**:
  - `resolveLink(href, basePath)`: ê²½ë¡œ ìœ í˜• ê°ì§€(ìƒëŒ€/ì ˆëŒ€/ë“œë¼ì´ë¸Œë¬¸ì) + resolve + normalize
  - `isLocalMarkdownLink(href)`: í”„ë¡œí† ì½œ/ì•µì»¤/í™•ì¥ì í•„í„°ë§ ì¢…í•© íŒë‹¨
  - `isExcludedExtension(ext)`: EXCLUDED_EXTENSIONS Set ê²€ì‚¬

### 5.2 ì‚¬ì´ë“œë°” UI (viewer.js í™•ì¥)

- [ ] **`onSidebarTree` í•¸ë“¤ëŸ¬** ë“±ë¡:
  - `window.doclight.onSidebarTree(data)` ì½œë°±
  - `data.tree`ê°€ null ë˜ëŠ” children ë¹„ì–´ìˆìŒ â†’ ì‚¬ì´ë“œë°” ì™„ì „ ìˆ¨ê¹€
  - `data.tree`ì— children > 0 â†’ ì‚¬ì´ë“œë°” í‘œì‹œ + íŠ¸ë¦¬ ë Œë”ë§
  - cleanup í•¨ìˆ˜ë¥¼ cleanups ë°°ì—´ì— ì¶”ê°€

- [ ] **íŠ¸ë¦¬ ë Œë”ë§ í•¨ìˆ˜** `renderSidebarTree(tree, container)`:
  - ì¬ê·€ì  DOM ìƒì„±:
    ```
    <div class="tree-item" data-path="ì ˆëŒ€ê²½ë¡œ">
      <span class="tree-toggle">â–¶</span>  (children > 0ì¼ ë•Œë§Œ)
      <span class="tree-icon">ğŸ“„</span>    (exists=true: ğŸ“„, exists=false: ğŸ“„ + âŒ ì˜¤ë²„ë ˆì´)
      <span class="tree-label" title="ì „ì²´ê²½ë¡œ">ì œëª©</span>
    </div>
    <div class="tree-children"> (í•˜ìœ„ ì¬ê·€) </div>
    ```
  - `exists: false` í•­ëª©: `class="tree-item not-exists"` + `cursor: not-allowed` + í…ìŠ¤íŠ¸ íšŒìƒ‰
  - í˜„ì¬ ë¬¸ì„œ í•˜ì´ë¼ì´íŠ¸: `class="tree-item active"` + `background-color: var(--highlight-bg)` + `scrollIntoView({ block: 'nearest' })`
  - ë¶€ëª¨ ë…¸ë“œ ìë™ ì „ê°œ: í˜„ì¬ ë¬¸ì„œì˜ ì¡°ìƒ ë…¸ë“œë¥¼ ëª¨ë‘ `expanded` ìƒíƒœë¡œ ì„¤ì •

- [ ] **í† ê¸€ (í™•ì¥/ì ‘ê¸°) í•¸ë“¤ëŸ¬**:
  - `â–¶` í´ë¦­ â†’ `â–¼` ë³€ê²½ + children í‘œì‹œ
  - `â–¼` í´ë¦­ â†’ `â–¶` ë³€ê²½ + children ìˆ¨ê¹€
  - CSS transitionìœ¼ë¡œ ë¶€ë“œëŸ¬ìš´ ì „í™˜

- [ ] **í•­ëª© í´ë¦­ í•¸ë“¤ëŸ¬**:
  - `exists: true` í•­ëª© í´ë¦­ â†’ `window.doclight.navigateTo(path)`
  - `exists: false` í•­ëª© í´ë¦­ â†’ ë¬´ì‹œ (ì´ë²¤íŠ¸ ì „íŒŒ ì¤‘ë‹¨)

- [ ] **ê¸´ ì œëª© ì²˜ë¦¬**:
  - `.tree-label`: `overflow: hidden; text-overflow: ellipsis; white-space: nowrap`
  - `title` ì†ì„±ì— ì „ì²´ ê²½ë¡œ ì„¤ì • â†’ ë§ˆìš°ìŠ¤ í˜¸ë²„ ì‹œ íˆ´íŒ

- [ ] **ë¡œë”© ìŠ¤í”¼ë„ˆ**:
  - íŠ¸ë¦¬ ë¹Œë“œ 3ì´ˆ ì´ìƒ ì†Œìš” ì‹œ ì‚¬ì´ë“œë°” ì˜ì—­ì— ë¡œë”© ì¸ë””ì¼€ì´í„° í‘œì‹œ
  - window-managerì—ì„œ ë¹Œë“œ ì‹œì‘ ì „ `sidebar-loading` IPC ì „ì†¡, ë¹Œë“œ ì™„ë£Œ í›„ `sidebar-tree` ì „ì†¡
  - viewer.jsì—ì„œ `onSidebarLoading` í•¸ë“¤ëŸ¬: ìŠ¤í”¼ë„ˆ í‘œì‹œ/ìˆ¨ê¹€

- [ ] **`... (Nê°œ ë”)` ì¸ë””ì¼€ì´í„°**:
  - buildLinkTreeì—ì„œ depth 5 cutoff ì‹œ ìƒì„±ëœ ì¸ë””ì¼€ì´í„° ë…¸ë“œ ë Œë”ë§
  - ë¹„í™œì„± ìŠ¤íƒ€ì¼ (íšŒìƒ‰, ì´íƒ¤ë¦­)

### 5.3 ì‚¬ì´ë“œë°” CSS (viewer.css í™•ì¥)

- [ ] **ì‚¬ì´ë“œë°” íŒ¨ë„ ìŠ¤íƒ€ì¼**:
  ```css
  #sidebar-container {
    width: 260px;
    min-width: 150px;
    max-width: 50vw;
    background: var(--sidebar-bg);
    overflow-y: auto;
    border-right: 1px solid var(--border-color);
    flex-shrink: 0;
    transition: width 200ms ease;
  }
  ```

- [ ] **ë¦¬ì‚¬ì´ì¦ˆ í•¸ë“¤**:
  ```css
  #resize-handle {
    width: 4px;
    cursor: col-resize;
    background: transparent;
    flex-shrink: 0;
    transition: background 150ms;
  }
  #resize-handle:hover,
  #resize-handle.dragging {
    background: var(--link-color);
  }
  ```

- [ ] **ë¦¬ì‚¬ì´ì¦ˆ ë“œë˜ê·¸ ë¡œì§** (viewer.js):
  - `mousedown` on resize-handle â†’ ë“œë˜ê·¸ ì‹œì‘
  - `mousemove` â†’ `requestAnimationFrame`ìœ¼ë¡œ ì‚¬ì´ë“œë°” width ì—…ë°ì´íŠ¸ (ë¶€ë“œëŸ¬ìš´ ë¦¬ì‚¬ì´ì¦ˆ)
  - `mouseup` â†’ ë“œë˜ê·¸ ì¢…ë£Œ + `electron-store`ì— ë„ˆë¹„ ì €ì¥ (IPC í†µí•´ Mainì— ì „ë‹¬)
  - ìµœì†Œ 150px, ìµœëŒ€ 50% viewport width ì œí•œ

- [ ] **Ctrl+B í† ê¸€**:
  - ì‚¬ì´ë“œë°” ìˆ¨ê¹€: `width: 0; overflow: hidden; padding: 0; border: none`
  - ì‚¬ì´ë“œë°” í‘œì‹œ: ì €ì¥ëœ ë„ˆë¹„ ë³µì› (electron-storeì˜ `sidebarWidth`)
  - `transition: width 200ms ease` ì ìš©

- [ ] **íŠ¸ë¦¬ í•­ëª© ìŠ¤íƒ€ì¼**:
  ```css
  .tree-item {
    display: flex;
    align-items: center;
    padding: 4px 8px;
    cursor: pointer;
    border-radius: 4px;
    gap: 4px;
  }
  .tree-item:hover { background: var(--sidebar-hover); }
  .tree-item.active { background: var(--highlight-bg); font-weight: 600; }
  .tree-item.not-exists {
    opacity: 0.5;
    cursor: not-allowed;
  }
  .tree-label {
    overflow: hidden;
    text-overflow: ellipsis;
    white-space: nowrap;
    flex: 1;
  }
  .tree-children { padding-left: 16px; }
  .tree-toggle {
    width: 16px;
    text-align: center;
    font-size: 10px;
    flex-shrink: 0;
    user-select: none;
  }
  ```

- [ ] **ë¡œë”© ìŠ¤í”¼ë„ˆ ìŠ¤íƒ€ì¼**:
  ```css
  .sidebar-spinner {
    display: flex;
    justify-content: center;
    align-items: center;
    padding: 2rem;
  }
  ```

### 5.4 ë„¤ë¹„ê²Œì´ì…˜ íˆìŠ¤í† ë¦¬ ì—°ë™

- [ ] **`navigate-to` IPC í•¸ë“¤ëŸ¬** (window-manager.js):
  - `ipcMain.on('navigate-to', (event, { filePath }) => { ... })`
  - `BrowserWindow.fromWebContents(event.sender)`ë¡œ ì°½ ì‹ë³„
  - `fs.readFile(filePath)` â†’ íŒŒì¼ ì½ê¸°
  - `history.push(filePath)` â†’ íˆìŠ¤í† ë¦¬ ìŠ¤íƒì— ì¶”ê°€
  - `win.webContents.send('render-markdown', { markdown: content, filePath, windowId })`
  - ì‚¬ì´ë“œë°” íŠ¸ë¦¬ëŠ” ì¬ë¹Œë“œí•˜ì§€ ì•ŠìŒ (Root-Preserving ëª¨ë¸)
  - ì‚¬ì´ë“œë°” í•˜ì´ë¼ì´íŠ¸ë§Œ ì—…ë°ì´íŠ¸: `win.webContents.send('sidebar-highlight', { currentPath: filePath })`

- [ ] **`navigate-back` / `navigate-forward` IPC í•¸ë“¤ëŸ¬** (window-manager.js):
  - `history.back()` / `history.forward()` í˜¸ì¶œ
  - ë°˜í™˜ëœ filePathë¡œ íŒŒì¼ ì½ê¸° â†’ render-markdown IPC ì „ì†¡
  - sidebar-highlight ì—…ë°ì´íŠ¸

- [ ] **viewer.js í•˜ì´ë¼ì´íŠ¸ ì—…ë°ì´íŠ¸**:
  - `onSidebarHighlight(data)` í•¸ë“¤ëŸ¬ ì¶”ê°€
  - ê¸°ì¡´ `.active` í´ë˜ìŠ¤ ì œê±°
  - `data.currentPath`ì™€ ì¼ì¹˜í•˜ëŠ” tree-itemì— `.active` ì¶”ê°€
  - `scrollIntoView({ block: 'nearest' })` í˜¸ì¶œ
  - í•´ë‹¹ í•­ëª©ì˜ ì¡°ìƒ ë…¸ë“œ ìë™ ì „ê°œ

---

## ì œê±° ëŒ€ìƒ ì½”ë“œ (Dead/Unnecessary Code)

ì´ Phase êµ¬í˜„ ì‹œ ë‹¤ìŒ ê¸°ì¡´ íŒŒì¼ë“¤ì€ Electron ì „í™˜ìœ¼ë¡œ ì¸í•´ **ì™„ì „íˆ ë¶ˆí•„ìš”**í•˜ë©°, í”¼ë´‡ ì™„ë£Œ ì‹œ ì œê±°í•´ì•¼ í•œë‹¤:

| íŒŒì¼ ê²½ë¡œ | ì œê±° ì‚¬ìœ  |
|-----------|----------|
| `src/controllers/tree-controller.js` | Expressìš© ë””ë ‰í† ë¦¬ íŠ¸ë¦¬ ìƒì„±. link-parser.jsì˜ ë§í¬ ê¸°ë°˜ íŠ¸ë¦¬ë¡œ ì™„ì „ ëŒ€ì²´ |
| `src/services/tree-service.js` | Expressìš© íŠ¸ë¦¬ ì„œë¹„ìŠ¤. ë§í¬ ê¸°ë°˜ ë™ì  íŠ¸ë¦¬ë¡œ ëŒ€ì²´ |
| `src/controllers/raw-controller.js` | Expressìš© íŒŒì¼ ë‚´ìš© API. Electronì—ì„œ fs.readFile ì§ì ‘ ì‚¬ìš© |
| `src/controllers/doc-controller.js` | Express ë¼ìš°íŠ¸ ì»¨íŠ¸ë¡¤ëŸ¬. Electron IPCë¡œ ëŒ€ì²´ |
| `src/utils/path-validator.js` | Expressìš© ê²½ë¡œ ë³´ì•ˆ ê²€ì¦ (docsRoot ê¸°ë°˜). Electronì€ ë¡œì»¬ ì•±ì´ë¯€ë¡œ docsRoot ê°œë… ë¶ˆí•„ìš” |
| `src/services/frontmatter-service.js` | ë³„ë„ frontmatter ì„œë¹„ìŠ¤. link-parser.jsì˜ extractTitle()ì—ì„œ ì¸ë¼ì¸ìœ¼ë¡œ ì²˜ë¦¬ |
| `src/services/file-service.js` | Expressìš© íŒŒì¼ ê´€ë¦¬ ì„œë¹„ìŠ¤. í”¼ë´‡ì—ì„œ ì½ê¸° ì „ìš©ìœ¼ë¡œ ì „í™˜, ë³„ë„ ì„œë¹„ìŠ¤ ë¶ˆí•„ìš” |
| `src/services/file-scanner-service.js` | íŒŒì¼ ìŠ¤ìºë„ˆ. docsRoot ì „ì²´ ìŠ¤ìº” ëŒ€ì‹  ë§í¬ ê¸°ë°˜ ì¬ê·€ íƒìƒ‰ìœ¼ë¡œ ëŒ€ì²´ |

> **ì£¼ì˜**: link-parser.jsì—ì„œ `marked.lexer()`ë¥¼ ì‚¬ìš©í•˜ë¯€ë¡œ `marked` npm íŒ¨í‚¤ì§€ëŠ” í”„ë¡œë•ì…˜ ì˜ì¡´ì„±ìœ¼ë¡œ ìœ ì§€í•´ì•¼ í•œë‹¤. ê¸°ì¡´ `src/services/markdown-renderer.js`ì˜ marked ì‚¬ìš©ê³¼ëŠ” ë³„ê°œì´ë‹¤ (í•´ë‹¹ íŒŒì¼ì€ Phase 4ì—ì„œ ì œê±° ëŒ€ìƒìœ¼ë¡œ í‘œì‹œë¨).

---

## í…ŒìŠ¤íŠ¸ ì‹œë‚˜ë¦¬ì˜¤

### ì •ìƒ ì¼€ì´ìŠ¤

**TC-5-01: ì¬ê·€ íŠ¸ë¦¬ ë¹Œë“œ ë° ì‚¬ì´ë“œë°” í‘œì‹œ**

```
Given: README.md íŒŒì¼ì— [ê°€ì´ë“œ](./guide.md)ì™€ [API](./api/reference.md) ë§í¬ê°€ ìˆê³ ,
       guide.md íŒŒì¼ì— [FAQ](./faq.md) ë§í¬ê°€ ìˆìœ¼ë©°,
       ëª¨ë“  íŒŒì¼ì´ ì¡´ì¬í•˜ëŠ” ìƒíƒœ
When: buildLinkTree(README.md)ë¥¼ ì‹¤í–‰í•˜ê³  ê²°ê³¼ë¥¼ ì‚¬ì´ë“œë°”ì— ë Œë”ë§í•œë‹¤
Then: íŠ¸ë¦¬ì— 3ê°œì˜ í•˜ìœ„ ë¬¸ì„œê°€ ì¬ê·€ì ìœ¼ë¡œ í‘œì‹œëœë‹¤:
  - README (ë£¨íŠ¸, í•˜ì´ë¼ì´íŠ¸)
    - ê°€ì´ë“œ
      - FAQ
    - API Reference
  And: ì‚¬ì´ë“œë°” ë„ˆë¹„ëŠ” 260pxì´ë‹¤
  And: ë¦¬ì‚¬ì´ì¦ˆ í•¸ë“¤ì´ ì‚¬ì´ë“œë°” ìš°ì¸¡ì— í‘œì‹œëœë‹¤
```

**TC-5-02: ì‚¬ì´ë“œë°” í´ë¦­ ë„¤ë¹„ê²Œì´ì…˜**

```
Given: ì‚¬ì´ë“œë°” íŠ¸ë¦¬ì— guide.md í•­ëª©ì´ í‘œì‹œë˜ì–´ ìˆê³  í˜„ì¬ README.mdë¥¼ ë³´ê³  ìˆëŠ” ìƒíƒœ
When: ì‚¬ì´ë“œë°”ì—ì„œ guide.md í•­ëª©ì„ í´ë¦­í•œë‹¤
Then: ë·°ì–´ ì˜ì—­ì— guide.mdì˜ ë Œë”ë§ëœ ë‚´ìš©ì´ í‘œì‹œëœë‹¤
  And: ì‚¬ì´ë“œë°” íŠ¸ë¦¬ êµ¬ì¡°ëŠ” ë³€ê²½ë˜ì§€ ì•ŠëŠ”ë‹¤ (Root-Preserving)
  And: guide.md í•­ëª©ì´ í•˜ì´ë¼ì´íŠ¸ë˜ê³  README í•­ëª©ì˜ í•˜ì´ë¼ì´íŠ¸ê°€ í•´ì œëœë‹¤
  And: ë„¤ë¹„ê²Œì´ì…˜ íˆìŠ¤í† ë¦¬ì— guide.mdê°€ ì¶”ê°€ëœë‹¤
```

### ì˜ˆì™¸ ì¼€ì´ìŠ¤

**TC-5-03: ìˆœí™˜ ì°¸ì¡° ë°©ì§€**

```
Given: a.md íŒŒì¼ì— [B](./b.md) ë§í¬ê°€ ìˆê³ ,
       b.md íŒŒì¼ì— [A](./a.md) ë§í¬ê°€ ìˆëŠ” ìˆœí™˜ ì°¸ì¡° ìƒíƒœ
When: buildLinkTree(a.md)ë¥¼ ì‹¤í–‰í•œë‹¤
Then: íŠ¸ë¦¬ëŠ” a â†’ b êµ¬ì¡°ë¡œ ë¹Œë“œë˜ê³  bì˜ childrenì— aê°€ ë‹¤ì‹œ ë‚˜íƒ€ë‚˜ì§€ ì•ŠëŠ”ë‹¤
  And: ë¬´í•œ ë£¨í”„ ì—†ì´ í•¨ìˆ˜ê°€ ì •ìƒ ë°˜í™˜ëœë‹¤
  And: visited Setì— ì˜í•´ ìˆœí™˜ì´ ê°ì§€ëœë‹¤
```

**TC-5-04: ì¡´ì¬í•˜ì§€ ì•ŠëŠ” íŒŒì¼ ë§í¬**

```
Given: README.md íŒŒì¼ì— [ì—†ëŠ”ë¬¸ì„œ](./nonexistent.md) ë§í¬ê°€ ìˆê³ ,
       nonexistent.md íŒŒì¼ì´ ì¡´ì¬í•˜ì§€ ì•ŠëŠ” ìƒíƒœ
When: buildLinkTree(README.md)ë¥¼ ì‹¤í–‰í•˜ê³  ì‚¬ì´ë“œë°”ì— ë Œë”ë§í•œë‹¤
Then: ì‚¬ì´ë“œë°” íŠ¸ë¦¬ì— "ì—†ëŠ”ë¬¸ì„œ" í•­ëª©ì´ íšŒìƒ‰(opacity: 0.5)ìœ¼ë¡œ í‘œì‹œëœë‹¤
  And: í•´ë‹¹ í•­ëª©ì˜ cursorê°€ not-allowedì´ë‹¤
  And: í•´ë‹¹ í•­ëª©ì„ í´ë¦­í•´ë„ navigateToê°€ í˜¸ì¶œë˜ì§€ ì•ŠëŠ”ë‹¤
  And: exists: false ì†ì„±ì´ TreeNodeì— ì„¤ì •ëœë‹¤
```

### ê²½ê³„ê°’ í…ŒìŠ¤íŠ¸

**TC-5-05: ëŒ€ê·œëª¨ ë§í¬ íŠ¸ë¦¬ (MAX_TREE_FILES ì´ˆê³¼)**

```
Given: 250ê°œì˜ .md íŒŒì¼ì´ ì„œë¡œ ì—°ê²°ë˜ì–´ ìˆê³  ì „ì²´ íŠ¸ë¦¬ ê¹Šì´ê°€ 8ì¸ ìƒíƒœ
When: buildLinkTree(root.md)ë¥¼ ì‹¤í–‰í•œë‹¤
Then: depth 5ì—ì„œ íƒìƒ‰ì´ ì¤‘ë‹¨ë˜ê³  "... (Nê°œ ë”)" ì¸ë””ì¼€ì´í„° ë…¸ë“œê°€ ì¶”ê°€ëœë‹¤
  And: ë¹Œë“œëœ íŠ¸ë¦¬ì˜ ì´ ë…¸ë“œ ìˆ˜ëŠ” 200ê°œë¥¼ ì´ˆê³¼í•˜ì§€ ì•ŠëŠ”ë‹¤
  And: depth 5 ë¯¸ë§Œì˜ ë…¸ë“œëŠ” ëª¨ë‘ ì •ìƒì ìœ¼ë¡œ í¬í•¨ëœë‹¤
```

---

## íšŒê·€ í…ŒìŠ¤íŠ¸ ì²´í¬ë¦¬ìŠ¤íŠ¸

- [ ] Phase 4 í™•ì¸: viewer.jsì˜ ë Œë”ë§ íŒŒì´í”„ë¼ì¸(marked â†’ DOMPurify â†’ mermaid â†’ hljs)ì´ ì‚¬ì´ë“œë°” ì½”ë“œ ì¶”ê°€ í›„ì—ë„ ì •ìƒ ë™ì‘
- [ ] Phase 4 í™•ì¸: ì™¸ë¶€ ë§í¬ í´ë¦­ ì‹œ shell.openExternal ì •ìƒ í˜¸ì¶œ (ì‚¬ì´ë“œë°” í´ë¦­ í•¸ë“¤ëŸ¬ì™€ ì¶©ëŒ ì—†ìŒ)
- [ ] Phase 2 í™•ì¸: window-manager.jsì˜ createWindow/closeWindowê°€ ìƒˆë¡œìš´ navigate-to IPC í•¸ë“¤ëŸ¬ ì¶”ê°€ í›„ì—ë„ ì •ìƒ ë™ì‘
- [ ] Phase 3 í™•ì¸: MCP open_markdown(content ëª¨ë“œ)ìœ¼ë¡œ ì—´ì—ˆì„ ë•Œ ì‚¬ì´ë“œë°”ê°€ ìˆ¨ê²¨ì§€ê³  ë·°ì–´ê°€ 100% ë„ˆë¹„ ì°¨ì§€

---

## í…ŒìŠ¤íŠ¸ ì½”ë“œ í…œí”Œë¦¿

```javascript
// test/main/link-parser.test.js (pseudocode â€” Jest ë˜ëŠ” Node.js ë‚´ì¥ test)

const path = require('path');
const fs = require('fs');
const { buildLinkTree, parseLocalLinks, extractTitle } = require('../../src/main/link-parser');

// í…ŒìŠ¤íŠ¸ìš© ì„ì‹œ ë””ë ‰í† ë¦¬ ìƒì„± í—¬í¼
function createTestFiles(dir, files) {
  fs.mkdirSync(dir, { recursive: true });
  for (const [name, content] of Object.entries(files)) {
    const filePath = path.join(dir, name);
    fs.mkdirSync(path.dirname(filePath), { recursive: true });
    fs.writeFileSync(filePath, content, 'utf-8');
  }
}

describe('LinkParser', () => {
  const testDir = path.join(__dirname, '..', 'fixtures', 'link-parser');

  beforeAll(() => {
    createTestFiles(testDir, {
      'README.md': '# README\n[ê°€ì´ë“œ](./guide.md)\n[API](./api/reference.md)',
      'guide.md': '# Guide\n[FAQ](./faq.md)',
      'faq.md': '# FAQ\nNo links here.',
      'api/reference.md': '# API Reference\nEndpoint docs.',
    });
  });

  afterAll(() => {
    fs.rmSync(testDir, { recursive: true, force: true });
  });

  describe('TC-5-01: ì¬ê·€ íŠ¸ë¦¬ ë¹Œë“œ', () => {
    it('should build recursive tree from linked documents', async () => {
      const tree = await buildLinkTree(path.join(testDir, 'README.md'));

      expect(tree).not.toBeNull();
      expect(tree.title).toBe('README');
      expect(tree.exists).toBe(true);
      expect(tree.children).toHaveLength(2);

      const guide = tree.children.find(c => c.title === 'Guide');
      expect(guide).toBeDefined();
      expect(guide.children).toHaveLength(1);
      expect(guide.children[0].title).toBe('FAQ');
    });
  });

  describe('TC-5-03: ìˆœí™˜ ì°¸ì¡° ë°©ì§€', () => {
    it('should prevent infinite loop on circular references', async () => {
      const circularDir = path.join(testDir, 'circular');
      createTestFiles(circularDir, {
        'a.md': '# A\n[B](./b.md)',
        'b.md': '# B\n[A](./a.md)',
      });

      const tree = await buildLinkTree(path.join(circularDir, 'a.md'));

      expect(tree.title).toBe('A');
      expect(tree.children).toHaveLength(1);
      expect(tree.children[0].title).toBe('B');
      // Bì˜ childrenì— Aê°€ ì—†ì–´ì•¼ í•¨ (ìˆœí™˜ ë°©ì§€)
      expect(tree.children[0].children).toHaveLength(0);
    });
  });

  describe('TC-5-04: ì¡´ì¬í•˜ì§€ ì•ŠëŠ” íŒŒì¼', () => {
    it('should mark non-existent files with exists: false', async () => {
      const missingDir = path.join(testDir, 'missing');
      createTestFiles(missingDir, {
        'root.md': '# Root\n[ì—†ëŠ”ë¬¸ì„œ](./nonexistent.md)',
      });

      const tree = await buildLinkTree(path.join(missingDir, 'root.md'));

      expect(tree.children).toHaveLength(1);
      expect(tree.children[0].exists).toBe(false);
      expect(tree.children[0].children).toHaveLength(0);
    });
  });

  describe('parseLocalLinks', () => {
    it('should exclude code block links', () => {
      const md = '# Title\n[link1](./a.md)\n```\n[link2](./b.md)\n```\n[link3](./c.md)';
      const basePath = testDir;
      const links = parseLocalLinks(md, basePath);

      // link2ëŠ” ì½”ë“œ ë¸”ë¡ ë‚´ì´ë¯€ë¡œ ì œì™¸
      expect(links).toHaveLength(2);
      expect(links.some(l => l.includes('b.md'))).toBe(false);
    });

    it('should exclude external URLs and anchors', () => {
      const md = '[ext](https://example.com)\n[anchor](#heading)\n[local](./file.md)';
      const links = parseLocalLinks(md, testDir);

      expect(links).toHaveLength(1);
      expect(links[0]).toContain('file.md');
    });

    it('should handle URL-encoded paths', () => {
      const md = '[spaced](./my%20file.md)';
      const links = parseLocalLinks(md, testDir);

      expect(links).toHaveLength(1);
      expect(links[0]).toContain('my file.md');
    });
  });

  describe('extractTitle', () => {
    it('should prefer frontmatter title over H1', () => {
      const md = '---\ntitle: Frontmatter Title\n---\n# H1 Title\nContent';
      const title = extractTitle(md);
      expect(title).toBe('Frontmatter Title');
    });

    it('should fall back to first H1', () => {
      const md = '# My Document\n## Section\nContent';
      const title = extractTitle(md);
      expect(title).toBe('My Document');
    });

    it('should return null when no title found', () => {
      const md = 'Just plain text without headings.';
      const title = extractTitle(md);
      expect(title).toBeNull();
    });
  });
});
```

---

## êµ¬í˜„ ìˆœì„œ

1. `link-parser.js` â€” ìƒìˆ˜, `isExcludedExtension`, `resolveLink` í—¬í¼ (5.1)
2. `link-parser.js` â€” `parseLocalLinks()` êµ¬í˜„ + ë‹¨ìœ„ í…ŒìŠ¤íŠ¸ (5.1)
3. `link-parser.js` â€” `extractTitle()` êµ¬í˜„ + ë‹¨ìœ„ í…ŒìŠ¤íŠ¸ (5.1)
4. `link-parser.js` â€” `buildLinkTree()` êµ¬í˜„ + ìˆœí™˜ì°¸ì¡°/ê¹Šì´ì œí•œ í…ŒìŠ¤íŠ¸ (5.1)
5. `window-manager.js` â€” íŠ¸ë¦¬ ë¹Œë“œ í˜¸ì¶œ + `sidebar-tree` IPC ì „ì†¡ (5.4 ì—°ê´€)
6. `viewer.js` â€” `onSidebarTree` í•¸ë“¤ëŸ¬ + íŠ¸ë¦¬ ë Œë”ë§ (5.2)
7. `viewer.css` â€” ì‚¬ì´ë“œë°” ìŠ¤íƒ€ì¼ + ë¦¬ì‚¬ì´ì¦ˆ í•¸ë“¤ (5.3)
8. `viewer.js` â€” ë¦¬ì‚¬ì´ì¦ˆ ë“œë˜ê·¸ ë¡œì§ + Ctrl+B í† ê¸€ (5.3)
9. `viewer.js` / `window-manager.js` â€” navigate-to, back, forward IPC + í•˜ì´ë¼ì´íŠ¸ (5.4)
10. í†µí•© í…ŒìŠ¤íŠ¸ (MCP open_markdown(filePath) â†’ ì‚¬ì´ë“œë°” í‘œì‹œ â†’ í´ë¦­ ë„¤ë¹„ê²Œì´ì…˜ E2E)

---

## ì˜ˆìƒ íŒŒì¼ êµ¬ì¡° (ì‹ ê·œ/ìˆ˜ì •)

```
src/main/
â”œâ”€â”€ link-parser.js           # [ì‹ ê·œ] ë§í¬ íŒŒì‹± + ì¬ê·€ íŠ¸ë¦¬ ë¹Œë“œ
â””â”€â”€ window-manager.js        # [ìˆ˜ì •] navigate-to/back/forward IPC, sidebar-tree ì „ì†¡

src/renderer/
â”œâ”€â”€ viewer.js                # [ìˆ˜ì •] onSidebarTree, íŠ¸ë¦¬ ë Œë”ë§, ë¦¬ì‚¬ì´ì¦ˆ, Ctrl+B
â””â”€â”€ viewer.css               # [ìˆ˜ì •] ì‚¬ì´ë“œë°” ìŠ¤íƒ€ì¼, íŠ¸ë¦¬ í•­ëª© ìŠ¤íƒ€ì¼

test/main/
â””â”€â”€ link-parser.test.js      # [ì‹ ê·œ] link-parser ë‹¨ìœ„ í…ŒìŠ¤íŠ¸
```

---

## ì™„ë£Œ ê¸°ì¤€

- [ ] parseLocalLinksê°€ ì½”ë“œ ë¸”ë¡/ì™¸ë¶€ URL/ì•µì»¤/ë¹„-md í™•ì¥ìë¥¼ ì •í™•íˆ í•„í„°ë§
- [ ] buildLinkTreeê°€ ìˆœí™˜ ì°¸ì¡° ì—†ì´ ì¬ê·€ íŠ¸ë¦¬ë¥¼ ì˜¬ë°”ë¥´ê²Œ ë¹Œë“œ
- [ ] ì‚¬ì´ë“œë°”ì— íŠ¸ë¦¬ê°€ ë Œë”ë§ë˜ê³  í•­ëª© í´ë¦­ ì‹œ ë¬¸ì„œ ë„¤ë¹„ê²Œì´ì…˜ ë™ì‘
- [ ] ì¡´ì¬í•˜ì§€ ì•ŠëŠ” íŒŒì¼ì´ íšŒìƒ‰ìœ¼ë¡œ í‘œì‹œë˜ê³  í´ë¦­ ë¶ˆê°€
- [ ] Ctrl+Bë¡œ ì‚¬ì´ë“œë°” í† ê¸€ ë™ì‘ (transition ì• ë‹ˆë©”ì´ì…˜ í¬í•¨)
- [ ] ë¦¬ì‚¬ì´ì¦ˆ í•¸ë“¤ë¡œ ì‚¬ì´ë“œë°” ë„ˆë¹„ ì¡°ì ˆ ê°€ëŠ¥í•˜ê³  ì„¤ì •ì— ì €ì¥ë¨
- [ ] content ëª¨ë“œë¡œ ì—´ì—ˆì„ ë•Œ ì‚¬ì´ë“œë°” ì™„ì „ ìˆ¨ê¹€
- [ ] ë„¤ë¹„ê²Œì´ì…˜ íˆìŠ¤í† ë¦¬(back/forward)ê°€ ì •ìƒ ë™ì‘
