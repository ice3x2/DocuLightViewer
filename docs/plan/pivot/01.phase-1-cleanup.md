# Phase 1: 기존 코드 정리 및 프로젝트 초기화

작성일: 2026-02-14
최종 업데이트: 2026-02-14

## 한 줄 요약

Express 웹 서버, 챗봇, 기존 MCP 서비스 등 모든 레거시 코드를 완전히 제거하고, Electron + MCP Bridge 아키텍처를 위한 깨끗한 프로젝트 기반을 만든다.

---

## 1. 목표

기존 Express/웹 서버 코드 **전량 제거**, 불필요한 의존성 정리, Electron + MCP SDK 전용 프로젝트 구조 수립.

Phase 1 완료 후 프로젝트에는 다음만 남아야 한다:
- `src/main/` (빈 디렉토리 — Phase 2에서 구현)
- `src/renderer/` (빈 디렉토리 + `lib/` 라이브러리)
- `assets/icon.png`
- `docs/`, `CLAUDE.md`, `README.md`, `package.json`

## 2. 선행 조건

- 없음 (첫 번째 Phase)

## 3. 아키텍처 참조

- `docs/plan/pivot/00-1.architecture.md` Section 6 (패키지 구조)
- `docs/plan/pivot/00-2.tech-decisions.md` (제거 패키지 24개 목록, 신규 패키지 목록)

---

## 4. 죽은 코드 / 불필요 코드 감사

Phase 1에서 제거 대상인 모든 파일은 Electron pivot 이후 **완전히 불필요**하다. 아래는 카테고리별 분석이다.

### 4.1 Express 서버 인프라 (Dead Code)

| 파일/디렉토리 | 파일 수 | 제거 사유 |
|---------------|---------|-----------|
| `src/app.js` | 1 | Express 진입점 — Electron `index.js`로 대체 |
| `src/routes/` | 5 | Express 라우팅 — IPC 소켓으로 대체 |
| `src/middleware/` | 5 | Express 미들웨어 — Electron에 불필요 |
| `src/controllers/` (루트) | 10 | Express 컨트롤러 — 전량 제거 |
| `src/controllers/admin/` | 5 | 관리자 API — Electron에 불필요 |

### 4.2 서비스 레이어 (Dead Code)

| 파일/디렉토리 | 파일 수 | 제거 사유 |
|---------------|---------|-----------|
| `src/services/chatbot/` | 33 | LangChain 챗봇 — 완전 폐기 |
| `src/services/mcp/` | 5 | 기존 MCP JSON-RPC — 새 MCP SDK로 재작성 |
| `src/services/*.js` (루트) | 11 | Express 서비스 — 전량 제거 |

### 4.3 유틸리티 (Dead Code)

| 파일 | 제거 사유 |
|------|-----------|
| `config-loader.js` | JSON5 파싱 — `electron-store`로 대체 |
| `config-watcher.js` | 파일 감시 핫리로드 — 불필요 |
| `path-validator.js` | Express 경로 검증 — Electron에 불필요 |
| `backup-utils.js` | 설정 백업/롤백 — 불필요 |
| `lock-manager.js` | async-lock 래퍼 — 불필요 |
| `logger.js` | Winston 로거 — Electron console로 대체 |
| `embedding-notifier.js` | 챗봇 임베딩 — 불필요 |
| `ip-matcher.js` | IP 화이트리스트 — 불필요 |
| `ssl-validator.js` | SSL 인증서 검증 — 불필요 |
| `jsonrpc-utils.js` | JSON-RPC 유틸 — 새 MCP SDK 사용 |

### 4.4 뷰/템플릿 (Dead Code)

| 파일/디렉토리 | 파일 수 | 제거 사유 |
|---------------|---------|-----------|
| `src/views/` | 6 | EJS 템플릿 — Electron HTML로 대체 |

### 4.5 클라이언트 코드 (Dead Code)

| 파일/디렉토리 | 제거 사유 |
|---------------|-----------|
| `public/js/app.js` | Express 프론트엔드 — `viewer.js`로 재작성 |
| `public/js/admin.js` | 관리자 UI — 불필요 |
| `public/js/chatbot.js` | 챗봇 UI — 불필요 |
| `public/js/doclight-utils.js` | Express 유틸 — 불필요 |
| `public/css/style.css` | Express 스타일 — `viewer.css`로 재작성 |
| `public/css/admin.css` | 관리자 스타일 — 불필요 |
| `public/css/chatbot.css` | 챗봇 스타일 — 불필요 |
| `public/api-doc.md` | REST API 문서 — 불필요 |
| `public/mcp-doc.md` | 기존 MCP 문서 — 불필요 |

### 4.6 설정/스크립트 (Dead Code)

| 파일 | 제거 사유 |
|------|-----------|
| `config.json5` | JSON5 설정 — `electron-store`로 대체 |
| `config.json5.bak` | 설정 백업 — 불필요 |
| `config.example.json5` | 예제 설정 — 불필요 |
| `start.bat`, `stop.bat` | Express PM2 스크립트 — 불필요 |
| `start.sh`, `stop.sh` | Express PM2 스크립트 — 불필요 |
| `scripts/audit-config-capture.js` | 설정 감사 — 불필요 |

### 4.7 테스트 (부분 Dead Code)

| 파일/디렉토리 | 제거 사유 |
|---------------|-----------|
| `test/chatbot/` | 챗봇 테스트 — 불필요 |
| `test/mcp/` | 기존 MCP 테스트 — 불필요 |
| `test/phase*.test.js` | Express SSR/캐시 테스트 — 불필요 |
| `test/test-*.js` | Express 서버 테스트 — 불필요 |
| `test/test-*.spec.js` | Playwright 브라우저 테스트 — 불필요 |

### 4.8 데이터 (Dead Code)

| 파일/디렉토리 | 제거 사유 |
|---------------|-----------|
| `data/vector/` | HNSWlib 벡터 인덱스 — 챗봇 폐기와 함께 제거 |

### 4.9 보존 대상 (재활용)

| 파일/디렉토리 | 보존 사유 | 조치 |
|---------------|-----------|------|
| `public/lib/marked.min.js` | Renderer에서 사용 | `src/renderer/lib/`로 이동 |
| `public/lib/mermaid.min.js` | Renderer에서 사용 | `src/renderer/lib/`로 이동 |
| `public/lib/highlight.min.js` | Renderer에서 사용 | `src/renderer/lib/`로 이동 |
| `public/lib/highlight-github.min.css` | Renderer에서 사용 | `src/renderer/lib/`로 이동 |
| `public/lib/purify.min.js` | Renderer에서 사용 | `src/renderer/lib/`로 이동 |
| `public/images/icon.png` | 트레이/앱 아이콘 | `assets/icon.png`으로 이동 |
| `docs/` | 프로젝트 문서 | 유지 |
| `CLAUDE.md` | 프로젝트 가이드 | 유지 (Phase 완료 후 재작성) |
| `README.md` | 사용자 가이드 | 유지 (Phase 완료 후 재작성) |
| `package.json` | 프로젝트 메타데이터 | 의존성 정리 후 유지 |

---

## 5. 구현 체크리스트

### 5.1 디렉토리 단위 삭제

- [ ] `src/controllers/` 전체 삭제 (15개 파일: config, doc, raw, tree, search, html, chatbot, upload, delete, download + admin/ 5개)
- [ ] `src/middleware/` 전체 삭제 (5개 파일: auth, admin-auth, error-handler, ip-whitelist, request-logger)
- [ ] `src/routes/` 전체 삭제 (5개 파일: api, chatbot, mcp, context-mcp, admin-api)
- [ ] `src/services/chatbot/` 전체 삭제 (33개 파일: workflow/, nodes/, sllm/, verify/ 포함)
- [ ] `src/services/mcp/` 전체 삭제 (5개 파일: section-extractor, query-document-service, summarize-document-service, smart-search-service, index)
- [ ] `src/views/` 전체 삭제 (6개 파일: index, doc-viewer, chatbot, admin + partials/toc-sidebar, head-libs)
- [ ] `data/vector/` 전체 삭제 (5개 파일: metadata.json, metadata.json.bak, args.json, hnswlib.index, docstore.json)
- [ ] `scripts/` 전체 삭제 (1개 파일: audit-config-capture.js)
- [ ] `test/chatbot/` 전체 삭제 (8개 파일)
- [ ] `test/mcp/` 전체 삭제 (5개 파일)

### 5.2 서비스 파일 개별 삭제

- [ ] `src/services/cache-manager.js` 삭제
- [ ] `src/services/cache-storage.js` 삭제
- [ ] `src/services/config-service.js` 삭제
- [ ] `src/services/context-service.js` 삭제
- [ ] `src/services/file-scanner-service.js` 삭제
- [ ] `src/services/file-service.js` 삭제
- [ ] `src/services/frontmatter-service.js` 삭제
- [ ] `src/services/markdown-renderer.js` 삭제
- [ ] `src/services/search-service.js` 삭제
- [ ] `src/services/session-service.js` 삭제
- [ ] `src/services/tree-service.js` 삭제

### 5.3 유틸리티 파일 개별 삭제

- [ ] `src/utils/config-loader.js` 삭제
- [ ] `src/utils/config-watcher.js` 삭제
- [ ] `src/utils/path-validator.js` 삭제
- [ ] `src/utils/backup-utils.js` 삭제
- [ ] `src/utils/lock-manager.js` 삭제
- [ ] `src/utils/logger.js` 삭제
- [ ] `src/utils/embedding-notifier.js` 삭제
- [ ] `src/utils/ip-matcher.js` 삭제
- [ ] `src/utils/ssl-validator.js` 삭제
- [ ] `src/utils/jsonrpc-utils.js` 삭제

### 5.4 진입점 삭제

- [ ] `src/app.js` 삭제 (Express 진입점)

### 5.5 클라이언트 코드 삭제

- [ ] `public/js/app.js` 삭제
- [ ] `public/js/admin.js` 삭제
- [ ] `public/js/chatbot.js` 삭제
- [ ] `public/js/doclight-utils.js` 삭제
- [ ] `public/css/style.css` 삭제
- [ ] `public/css/admin.css` 삭제
- [ ] `public/css/chatbot.css` 삭제
- [ ] `public/api-doc.md` 삭제
- [ ] `public/mcp-doc.md` 삭제

### 5.6 설정/스크립트 삭제

- [ ] `config.json5` 삭제
- [ ] `config.json5.bak` 삭제
- [ ] `config.example.json5` 삭제
- [ ] `start.bat` 삭제
- [ ] `stop.bat` 삭제
- [ ] `start.sh` 삭제
- [ ] `stop.sh` 삭제

### 5.7 테스트 파일 삭제

- [ ] `test/` 디렉토리 내 Express/서버 관련 테스트 전체 삭제 (40+ 파일)
- [ ] `test/README.md`는 유지하되 내용을 Electron 테스트 가이드로 대체

### 5.8 보존 파일 이동

- [ ] `public/lib/marked.min.js` → `src/renderer/lib/marked.min.js`
- [ ] `public/lib/mermaid.min.js` → `src/renderer/lib/mermaid.min.js`
- [ ] `public/lib/highlight.min.js` → `src/renderer/lib/highlight.min.js`
- [ ] `public/lib/highlight-github.min.css` → `src/renderer/lib/highlight-github.min.css`
- [ ] `public/lib/purify.min.js` → `src/renderer/lib/purify.min.js`
- [ ] `public/images/icon.png` → `assets/icon.png`

### 5.9 잔여 디렉토리 삭제

- [ ] `public/` 전체 삭제 (이동 완료 후 빈 디렉토리)
- [ ] `src/services/` 전체 삭제 (빈 디렉토리)
- [ ] `src/utils/` 전체 삭제 (빈 디렉토리)

### 5.10 package.json 정리

- [ ] `dependencies`에서 제거 (17개): express, ejs, multer, archiver, adm-zip, ignore, winston, winston-daily-rotate-file, json5, async-lock, puppeteer, cookie-parser, jsdom, @langchain/community, @langchain/core, @langchain/langgraph, @langchain/ollama, @langchain/openai, @langchain/textsplitters, langchain, hnswlib-node, zod
- [ ] `optionalDependencies`에서 제거 (1개): chokidar
- [ ] `devDependencies`에서 제거 (4개): nodemon, @playwright/test, playwright, cross-env
- [ ] `dependencies`에 추가: `@modelcontextprotocol/sdk`, `electron-store`, `uuid`
- [ ] `devDependencies`에 추가: `electron`, `electron-builder`
- [ ] `dependencies` 유지 확인: `marked`, `dompurify`, `highlight.js`
- [ ] `main` 필드 변경: `"src/app.js"` → `"src/main/index.js"`
- [ ] `scripts` 섹션 재작성:
  ```json
  {
    "start": "electron .",
    "mcp": "node src/main/mcp-server.js"
  }
  ```
- [ ] `engines` 필드 업데이트: `"node": ">=20.0.0"`

### 5.11 신규 디렉토리 생성

- [ ] `src/main/` 디렉토리 생성
- [ ] `src/renderer/` 디렉토리 생성
- [ ] `src/renderer/lib/` 디렉토리 생성 (lib 파일 이동 전에 생성)
- [ ] `assets/` 디렉토리 생성

### 5.12 클린 설치

- [ ] `node_modules/` 삭제
- [ ] `package-lock.json` 삭제
- [ ] `npm install` 실행
- [ ] 설치 결과 확인: electron, @modelcontextprotocol/sdk, electron-store, uuid, marked, dompurify, highlight.js만 존재

### 5.13 최종 검증

- [ ] 남은 파일에서 `require('express')` 또는 `import express` 검색 → 0건
- [ ] 남은 파일에서 삭제된 모듈 참조 검색 → 0건
- [ ] `npx electron .` 실행 시 에러 없이 앱 시작 (빈 앱이므로 즉시 종료 가능)
- [ ] 디렉토리 구조가 아키텍처 문서 Section 6과 일치하는지 확인

---

## 6. 최종 디렉토리 구조 (Phase 1 완료 후)

```
DocLight/
├── src/
│   ├── main/                      # (빈 디렉토리 — Phase 2에서 구현)
│   └── renderer/
│       └── lib/
│           ├── marked.min.js
│           ├── mermaid.min.js
│           ├── highlight.min.js
│           ├── highlight-github.min.css
│           └── purify.min.js
│
├── assets/
│   └── icon.png                   # 앱/트레이 아이콘
│
├── docs/                          # 프로젝트 문서 (유지)
│   └── plan/
│       └── pivot/
│           ├── 00-1.architecture.md
│           ├── 00-2.tech-decisions.md
│           └── 01.phase-1-cleanup.md
│
├── test/                          # (빈 디렉토리 — 추후 Electron 테스트 추가)
│   └── README.md
│
├── package.json                   # Electron + MCP SDK 의존성
├── CLAUDE.md
└── README.md
```

---

## 7. 테스트 시나리오

### 7.1 정상 케이스

#### TC-1: 클린 상태에서 전체 삭제 및 npm install

```
Given: Phase 1 체크리스트의 모든 삭제/이동 작업이 완료된 상태
When: npm install을 실행한다
Then:
  - 설치가 에러 없이 완료된다
  - node_modules에 electron, @modelcontextprotocol/sdk, electron-store, uuid, marked, dompurify, highlight.js가 존재한다
  - node_modules에 express, ejs, multer, winston, langchain 관련 패키지가 존재하지 않는다
```

#### TC-2: Electron 앱 시작 확인

```
Given: npm install이 완료되고 package.json의 main이 "src/main/index.js"인 상태
When: npx electron .을 실행한다 (src/main/index.js가 아직 없으므로)
Then:
  - Electron이 시작되지만 진입점 파일이 없어 에러 메시지를 출력한다
  - 에러가 "Cannot find module './src/main/index.js'" 형태이다
  - express, ejs 등 제거된 모듈 관련 에러는 발생하지 않는다
```

#### TC-3: 라이브러리 파일 이동 확인

```
Given: Phase 1의 파일 이동 작업이 완료된 상태
When: src/renderer/lib/ 디렉토리 내용을 확인한다
Then:
  - marked.min.js, mermaid.min.js, highlight.min.js, highlight-github.min.css, purify.min.js가 존재한다
  - 각 파일의 크기가 원본(public/lib/)과 동일하다
  - public/ 디렉토리는 완전히 삭제되었다
```

### 7.2 예외 케이스

#### TC-4: 부분 삭제로 인한 댕글링 임포트

```
Given: src/controllers/만 삭제하고 src/routes/는 남겨둔 상태
When: 남은 파일에서 require/import 문을 검색한다
Then:
  - src/routes/api.js에서 ../controllers/* 참조가 발견된다
  - 이는 불완전한 삭제임을 의미하므로 routes/도 반드시 삭제해야 한다
```

#### TC-5: package.json main 필드 오류

```
Given: package.json의 main이 "src/app.js"(기존값)인 상태
When: npx electron .을 실행한다
Then:
  - src/app.js가 삭제되었으므로 "Cannot find module" 에러 발생
  - main을 "src/main/index.js"로 수정해야 함을 확인
```

### 7.3 경계 케이스

#### TC-6: 보존 파일만 남은 상태 확인

```
Given: 모든 삭제 및 이동 작업 완료
When: 프로젝트 루트에서 src/ 하위 파일 목록을 생성한다
Then:
  - src/ 하위에는 main/ (빈), renderer/lib/ (5개 파일)만 존재한다
  - src/controllers/, src/middleware/, src/routes/, src/services/, src/utils/, src/views/는 존재하지 않는다
  - src/app.js는 존재하지 않는다
```

#### TC-7: 아이콘 파일 보존

```
Given: public/images/icon.png를 assets/icon.png로 이동 완료
When: assets/icon.png 파일을 확인한다
Then:
  - 파일이 존재하고 유효한 PNG 이미지이다
  - public/images/ 디렉토리는 존재하지 않는다
```

---

## 8. 회귀 테스트 체크리스트

- [ ] 남은 모든 파일에서 `express`, `ejs`, `multer` 문자열 검색 → 0건 (docs/ 제외)
- [ ] 남은 모든 `.js` 파일에서 삭제된 파일의 `require()` 또는 `import` → 0건
- [ ] `package.json`에 제거 대상 24개 패키지가 하나도 남아있지 않음
- [ ] 디렉토리 구조가 Section 6 (최종 디렉토리 구조)과 정확히 일치

---

## 9. 테스트 코드 템플릿

```javascript
// test/phase1-cleanup.test.js (pseudocode)
const fs = require('fs');
const path = require('path');

describe('Phase 1: 프로젝트 정리 검증', () => {

  const ROOT = path.resolve(__dirname, '..');

  describe('삭제 대상 디렉토리 검증', () => {
    const deletedDirs = [
      'src/controllers', 'src/middleware', 'src/routes',
      'src/services', 'src/utils', 'src/views',
      'data/vector', 'scripts', 'public'
    ];

    for (const dir of deletedDirs) {
      it(`${dir}/ 디렉토리가 존재하지 않아야 한다`, () => {
        const fullPath = path.join(ROOT, dir);
        expect(fs.existsSync(fullPath)).toBe(false);
      });
    }
  });

  describe('삭제 대상 파일 검증', () => {
    const deletedFiles = [
      'src/app.js', 'config.json5', 'config.json5.bak',
      'config.example.json5', 'start.bat', 'stop.bat',
      'start.sh', 'stop.sh'
    ];

    for (const file of deletedFiles) {
      it(`${file}이 존재하지 않아야 한다`, () => {
        expect(fs.existsSync(path.join(ROOT, file))).toBe(false);
      });
    }
  });

  describe('보존 파일 이동 검증', () => {
    const movedFiles = [
      'src/renderer/lib/marked.min.js',
      'src/renderer/lib/mermaid.min.js',
      'src/renderer/lib/highlight.min.js',
      'src/renderer/lib/highlight-github.min.css',
      'src/renderer/lib/purify.min.js',
      'assets/icon.png'
    ];

    for (const file of movedFiles) {
      it(`${file}이 존재해야 한다`, () => {
        expect(fs.existsSync(path.join(ROOT, file))).toBe(true);
      });
    }
  });

  describe('package.json 검증', () => {
    let pkg;
    beforeAll(() => {
      pkg = JSON.parse(fs.readFileSync(path.join(ROOT, 'package.json'), 'utf8'));
    });

    it('main 필드가 src/main/index.js여야 한다', () => {
      expect(pkg.main).toBe('src/main/index.js');
    });

    it('제거 대상 패키지가 dependencies에 없어야 한다', () => {
      const removed = [
        'express', 'ejs', 'multer', 'archiver', 'adm-zip',
        'ignore', 'winston', 'winston-daily-rotate-file', 'json5',
        'async-lock', 'puppeteer', 'cookie-parser', 'jsdom'
      ];
      for (const pkg_name of removed) {
        expect(pkg.dependencies[pkg_name]).toBeUndefined();
      }
    });

    it('필수 패키지가 dependencies에 있어야 한다', () => {
      expect(pkg.dependencies['@modelcontextprotocol/sdk']).toBeDefined();
      expect(pkg.dependencies['electron-store']).toBeDefined();
      expect(pkg.dependencies['uuid']).toBeDefined();
      expect(pkg.dependencies['marked']).toBeDefined();
    });

    it('electron이 devDependencies에 있어야 한다', () => {
      expect(pkg.devDependencies['electron']).toBeDefined();
      expect(pkg.devDependencies['electron-builder']).toBeDefined();
    });
  });

  describe('댕글링 참조 검증', () => {
    it('남은 JS 파일에서 express 참조가 없어야 한다', () => {
      // src/ 하위 모든 .js 파일을 재귀 탐색
      // 각 파일 내용에서 require('express') 또는 import.*express 검색
      // 발견 시 fail
    });
  });
});
```

---

## 10. 작업 순서 권장

1. **신규 디렉토리 생성** (5.11) — 이동 대상 디렉토리 먼저 준비
2. **보존 파일 이동** (5.8) — 삭제 전에 필요한 파일 안전하게 이동
3. **디렉토리 단위 삭제** (5.1) — 큰 덩어리부터 삭제
4. **개별 파일 삭제** (5.2 ~ 5.6) — 나머지 파일 정리
5. **테스트 파일 삭제** (5.7)
6. **잔여 디렉토리 삭제** (5.9) — 빈 디렉토리 정리
7. **package.json 정리** (5.10) — 의존성 재구성
8. **클린 설치** (5.12) — node_modules 재생성
9. **최종 검증** (5.13) — 모든 것이 깨끗한지 확인

---

## 11. 예상 소요 시간

| 작업 | 소요 시간 |
|------|-----------|
| 파일/디렉토리 삭제 | 15분 |
| 파일 이동 및 디렉토리 생성 | 5분 |
| package.json 정리 | 10분 |
| npm install + 검증 | 10분 |
| 회귀 테스트 확인 | 10분 |
| **합계** | **~50분** |
