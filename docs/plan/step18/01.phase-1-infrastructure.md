# Phase 1: 모듈 인프라 + 이미지 경로 해석 + 포트 디스커버리

## 목표

렌더러 모듈 시스템(window.DocuLight 네임스페이스)을 구축하고, 가장 의존성이 적은 두 기능(이미지 경로 해석 FR-18-007, 포트 디스커버리 FR-18-002)을 구현한다. 동시에 Step 18 전체에서 필요한 설정 스키마와 i18n 키를 선행 추가한다.

## 선행 조건

- 없음 (첫 번째 Phase)

## 아키텍처 참조

- [00-1.architecture.md](./00-1.architecture.md) §2.1 렌더러 모듈 시스템
- [00-2.tech-decisions.md](./00-2.tech-decisions.md) ADR-001, ADR-002, ADR-007

## 구현 체크리스트

### 1.1 electron-store 스키마 확장 (index.js)

**파일**: `src/main/index.js` — `new Store({ schema })` 부분

- [ ] `autoRefresh` 키 추가: `{ type: 'boolean', default: true }`
- [ ] `enableTabs` 키 추가: `{ type: 'boolean', default: false }`
- [ ] `recentFiles` 키 추가: `{ type: 'array', items: { type: 'string' }, default: [] }`

### 1.2 i18n 키 추가 (4개 로케일 파일)

**파일**: `src/locales/en.json`, `ko.json`, `ja.json`, `es.json`

- [ ] `settings.autoRefresh`: "Auto Refresh" / "자동 새로고침" / "自動更新" / "Actualización automática"
- [ ] `settings.autoRefreshHint`: 힌트 텍스트
- [ ] `settings.enableTabs`: "Enable Tabs" / "탭 기능 사용" / ...
- [ ] `settings.enableTabsHint`: 힌트 텍스트
- [ ] `viewer.exportPdf` ~ `viewer.exportError`: PDF 관련 10개 키
- [ ] `viewer.sidebarSearch`, `viewer.sidebarSearchAriaLabel`, `viewer.searchNoResults`
- [ ] `viewer.tabClose`, `viewer.newTab`, `viewer.maxTabsReached`
- [ ] `tray.recentDocs`, `tray.clearRecent`, `tray.recentEmpty`

### 1.3 Settings UI에 체크박스 추가 (settings.html, settings.js)

**파일**: `src/renderer/settings.html`
- [ ] "File Association" 섹션 아래에 새 섹션 구분선 추가
- [ ] `autoRefresh` 체크박스 + 힌트 텍스트 (`data-i18n` 속성)
- [ ] `enableTabs` 체크박스 + 힌트 텍스트 (`data-i18n` 속성)

**파일**: `src/renderer/settings.js`
- [ ] DEFAULTS에 `autoRefresh: true`, `enableTabs: false` 추가
- [ ] `loadSettings()`, `populateForm()`, `collectFormValues()`에 두 키 반영

### 1.4 viewer.js 모듈 시스템 초기화

**파일**: `src/renderer/viewer.js`

- [ ] DOMContentLoaded 핸들러 시작 부분에 `window.DocuLight = { state: {}, dom: {}, fn: {}, modules: {} }` 생성
- [ ] `dom.content`, `dom.sidebarTree`, `dom.viewerContainer` 등 DOM 참조 등록
- [ ] `fn.renderMarkdown` 함수 등록 (기존 `renderMarkdown` 함수 래핑)
- [ ] `fn.navigateTo` 등록 (기존 `window.doclight.navigateTo` 래퍼)
- [ ] `window.__docuLightModules` 배열 순회하며 모듈 등록 + init() 순차 호출
- [ ] `state.platform` 저장 (render-markdown IPC의 platform 필드 사용)

### 1.5 viewer.html에 모듈 script 태그 추가

**파일**: `src/renderer/viewer.html`

- [ ] mermaid.min.js 다음에 순서대로 추가:
  ```html
  <script src="image-resolver.js"></script>
  <script src="sidebar-search.js"></script>
  <script src="pdf-export-ui.js"></script>
  <script src="tab-manager.js"></script>
  ```
  (Phase 1에서는 image-resolver.js만 실제 구현. 나머지는 빈 IIFE 스텁)

### 1.6 image-resolver.js 생성 (신규 — FR-18-007)

**파일**: `src/renderer/image-resolver.js`

- [ ] IIFE로 감싸고 `window.__docuLightModules`에 push
- [ ] `init()` 함수에서 `marked.use()` 호출:
  - 기존 `marked.setOptions({ gfm: true, breaks: true })` 대체
  - `renderer.image({ href, title, text })` 오버라이드
- [ ] `resolveImagePath(href)` 함수 구현:
  - data:, http://, https:// → 그대로 반환
  - file:// → 그대로 반환
  - 상대 경로 → `resolveRelativePath()` + `isPathWithin()` + `pathToFileUrl()`
- [ ] `resolveRelativePath(basePath, relativePath)` 구현 (SRS §6.3 레퍼런스)
- [ ] `isPathWithin(absPath, basePath)` 구현 (Windows 대소문자 무시)
- [ ] `pathToFileUrl(absPath)` 구현 (Windows/Unix 겸용)
- [ ] `escapeHtml(str)` 유틸리티 함수

### 1.7 window-manager.js에 imageBasePath 추가 (FR-18-007)

**파일**: `src/main/window-manager.js`

- [ ] `render-markdown` IPC 전송 시 `imageBasePath` 필드 추가
  - 값: `entry.meta.tree ? path.dirname(entry.meta.tree.path) : path.dirname(filePath)`
  - 백슬래시 → 슬래시 변환: `.replace(/\\/g, '/')`
- [ ] 적용 지점: `onWindowReady`, `navigateTo`, `navigateBack`, `navigateForward`
- [ ] filePath도 슬래시 변환하여 전달

### 1.8 viewer.js에서 imageBasePath 수신 (FR-18-007)

**파일**: `src/renderer/viewer.js`

- [ ] `onRenderMarkdown` 핸들러에서 `data.imageBasePath` → `window.DocuLight.state.imageBasePath` 저장
- [ ] `data.platform` → `window.DocuLight.state.platform` 저장
- [ ] 기존 `marked.setOptions({ gfm: true, breaks: true })` 호출 제거 (image-resolver.js의 marked.use()로 대체)

### 1.9 MCP 포트 디스커버리 파일 (FR-18-002)

**파일**: `src/main/mcp-http.mjs`
- [ ] `startMcpHttpServer` 시그니처 변경: `(windowManager, store, userDataPath)` — 세 번째 파라미터 추가
- [ ] 포트 바인딩 성공 콜백에서 `path.join(userDataPath, 'mcp-port')` 파일에 포트 번호 기록
- [ ] try/catch로 감싸고, 실패 시 console.error + 앱 계속 실행

**파일**: `src/main/index.js`
- [ ] `startMcpHttpServer(windowManager, store, app.getPath('userData'))` 호출부 수정
- [ ] `app.on('before-quit')` 핸들러에서 포트 파일 삭제 (best-effort)

### 1.10 빈 모듈 스텁 생성

- [ ] `src/renderer/sidebar-search.js` — 빈 IIFE + init() 스텁
- [ ] `src/renderer/pdf-export-ui.js` — 빈 IIFE + init() 스텁
- [ ] `src/renderer/tab-manager.js` — 빈 IIFE + init() 스텁

## 테스트

### 정상 케이스

```
Given: C:\docs\README.md에 ![logo](./images/logo.png) 포함
When: 뷰어에서 README.md를 filePath로 열기
Then: 렌더링된 HTML에 <img src="file:///C:/docs/images/logo.png"> 포함
```

```
Given: 문서에 ![](https://example.com/img.jpg) 포함
When: 뷰어에서 렌더링
Then: src가 https URL 그대로 유지
```

```
Given: DocLight 앱 시작, MCP HTTP 서버가 포트 52580에 바인딩
When: 바인딩 완료
Then: {userData}/mcp-port 파일 내용이 "52580"
```

### 예외 케이스

```
Given: 문서에 ![](../../secret/data.png) 포함, basePath = "C:/docs/project"
When: 렌더링
Then: isPathWithin 검증 실패, img src가 빈 문자열
```

```
Given: content-only 모드 (filePath 없음)에 상대 경로 이미지
When: 렌더링
Then: 이미지 미표시 (basePath 없음), 에러 없음
```

### 경계값 테스트

```
Given: Windows 경로 "C:\docs\한글 폴더\image.png"
When: pathToFileUrl() 호출
Then: 한글이 encodeURIComponent 처리된 file:// URL 생성
```

### 회귀테스트 조건

- [ ] 기존 마크다운 렌더링이 정상 동작 (marked.use() 마이그레이션 후)
- [ ] 기존 Mermaid 다이어그램 렌더링 정상
- [ ] 기존 코드 신택스 하이라이팅 정상
- [ ] MCP 4개 도구 (open/update/close/list) 정상 동작
