# Phase 6: 탭 기반 다중 문서 뷰

## 목표

단일 뷰어 창 내에서 여러 문서를 탭으로 관리한다 (FR-18-006). 각 탭은 독립적인 콘텐츠, 스크롤 위치, 사이드바 트리를 유지. 탭 1개일 때는 탭 바 숨김.

## 선행 조건

- Phase 1 완료 (모듈 시스템, enableTabs 설정)
- Phase 4 완료 (사이드바 검색과 탭 연동)
- Phase 5 완료 (PDF 내보내기와 탭 연동)

## 아키텍처 참조

- [00-1.architecture.md](./00-1.architecture.md) §2.1 모듈 시스템, §2.2 인터페이스
- [00-2.tech-decisions.md](./00-2.tech-decisions.md) ADR-005, ADR-006, ADR-008
- SRS §2.6 FR-18-006, §5.5 탭 바 UI, §5.8.1 접근성

## 구현 체크리스트

### 6.1 preload.js에 탭 API 추가

**파일**: `src/main/preload.js`

- [ ] `readFileForTab: (filePath) => ipcRenderer.invoke('read-file-for-tab', filePath)` 추가
- [ ] `checkFileMtime: (filePath) => ipcRenderer.invoke('check-file-mtime', filePath)` 추가
- [ ] `openFileDialog: () => ipcRenderer.invoke('open-file-dialog')` 추가

### 6.2 index.js에 탭 IPC 핸들러 추가

**파일**: `src/main/index.js`

- [ ] `ipcMain.handle('read-file-for-tab', async (event, filePath) => { ... })`:
  - 입력 검증: typeof string, 절대 경로, .md/.markdown 확장자, 파일 존재
  - 검증 실패 시: `{ error: "Invalid file path" }` 반환
  - `fs.promises.readFile(filePath, 'utf-8')` → markdown
  - `link-parser.buildDirectoryTree()` → sidebarTree
  - title 추출 (H1 헤더)
  - 반환: `{ markdown, filePath, title, sidebarTree }`

- [ ] `ipcMain.handle('check-file-mtime', async (event, filePath) => { ... })`:
  - 입력 검증: typeof string, 절대 경로, .md/.markdown 확장자
  - 검증 실패 시: `{ mtime: 0, exists: false }` (graceful)
  - `fs.stat(filePath)` → `{ mtime: stat.mtimeMs, exists: true }`
  - 파일 미존재: `{ mtime: 0, exists: false }`

- [ ] `ipcMain.handle('open-file-dialog', async () => { ... })`:
  - `dialog.showOpenDialog({ filters: [{ name: 'Markdown', extensions: ['md', 'markdown'] }], properties: ['openFile'] })`
  - 취소 시: `{ filePath: null }`
  - 선택 시: `{ filePath: result.filePaths[0] }`

### 6.3 tab-manager.js 구현 (신규)

**파일**: `src/renderer/tab-manager.js`

- [ ] IIFE + `window.__docuLightModules` 등록

- [ ] **데이터 모델**:
  ```javascript
  const tabs = [];
  let activeTabIndex = 0;
  const MAX_TABS = 20;
  ```

- [ ] `init()` 함수:
  - settings에서 `enableTabs` 확인 → false이면 탭 바 숨기고 return
  - `window.DocuLight.state.tabs = tabs` 연결
  - navigateTo 래핑:
    ```javascript
    const originalNavigateTo = window.doclight?.navigateTo;
    window.DocuLight.fn.navigateToForTab = async function(href) {
      if (!enableTabs) { originalNavigateTo(href); return; }
      const existing = tabs.findIndex(t => t.filePath === href);
      if (existing >= 0) { switchTab(existing); return; }
      if (tabs.length >= MAX_TABS) { showMaxTabsToast(); return; }
      const data = await window.doclight.readFileForTab(href);
      if (data.error) { console.error(data.error); return; }
      createTab(data);
    };
    ```
  - 탭 바 DOM 이벤트 리스너 등록
  - 초기 탭 생성 (현재 문서 기반)

- [ ] `createTab(data)` 함수:
  - Tab 객체 생성 (id: crypto.randomUUID(), title, filePath, markdown, renderedHtml, scrollTop: 0, sidebarTree, currentSidebarPath, cachedAt: Date.now())
  - tabs 배열에 push
  - 탭 바 UI에 탭 요소 추가
  - switchTab(tabs.length - 1)
  - 탭 2개 이상이면 탭 바 표시, 1개면 숨김

- [ ] `switchTab(index)` 함수:
  - 현재 탭 상태 저장: scrollTop, renderedHtml (contentEl.innerHTML)
  - 새 탭 활성화:
    - filePath !== null이면 checkFileMtime → mtime > cachedAt이면 readFileForTab + 재렌더링
    - filePath === null (content-only)이면 캐시 그대로 복원
  - contentEl.innerHTML = newTab.renderedHtml
  - viewerContainer.scrollTop = newTab.scrollTop
  - 사이드바 트리 교체
  - 사이드바 하이라이트 업데이트
  - currentFilePath 업데이트
  - 탭 바 active 클래스 갱신

- [ ] `closeTab(index)` 함수:
  - tabs 배열에서 splice
  - 남은 탭 0개 → window.close()
  - 남은 탭 1개 → 탭 바 숨김
  - 닫힌 탭이 활성이었으면: index > 0이면 index-1로 전환, index === 0이면 0으로 전환

- [ ] `showMaxTabsToast()` 함수:
  - 탭 바 하단 우측 토스트 메시지 3초 표시
  - i18n 키: `viewer.maxTabsReached`
  - 애니메이션: opacity 0→1 (150ms) → 2700ms 유지 → 1→0 (150ms)

- [ ] 탭 바 UI 렌더링:
  - 각 탭: `role="tab"`, `aria-selected`, `aria-controls`, `tabindex`
  - x 닫기 버튼: hover 시만 표시 (active 탭은 항상)
  - 중클릭: 탭 닫기
  - [+] 버튼: `window.doclight.openFileDialog()` → 파일 선택 시 새 탭

- [ ] 탭 바 오버플로우:
  - `overflow-x: auto`, `::-webkit-scrollbar` thin 스타일
  - 활성 탭 `scrollIntoView({ inline: 'nearest' })`
  - [+] 버튼 우측 sticky

- [ ] 키보드 단축키:
  - `Ctrl+T` / `Cmd+T`: `openFileDialog()` → 새 탭
  - `Ctrl+W` / `Cmd+W`: closeTab(activeTabIndex)
  - `ArrowLeft/Right` on tablist: 탭 포커스 이동 (circular)
  - `Enter/Space`: 포커스된 탭 활성화

### 6.4 viewer.html에 탭 바 추가

**파일**: `src/renderer/viewer.html`

- [ ] `#app-container` 상단에:
  ```html
  <div id="tab-bar" class="tab-bar hidden" role="tablist" aria-label="Open document tabs">
    <!-- 동적 탭 요소 삽입 위치 -->
    <button class="tab-add" aria-label="New tab (Ctrl+T)">+</button>
  </div>
  ```

- [ ] `#viewer-container`에 `role="tabpanel"` 추가

### 6.5 viewer.css에 탭 스타일 추가

**파일**: `src/renderer/viewer.css`

- [ ] `.tab-bar`: flex, 가로 배치, 배경, border-bottom, overflow-x: auto
- [ ] `.tab-item`: 인라인 패딩, 커서 pointer, 파일 아이콘
- [ ] `.tab-item.active`: 하단 border 강조, 밝은 배경
- [ ] `.tab-close`: opacity 제어 (hover/active 규칙 — SRS §5.6.1)
- [ ] `.tab-add`: 우측 sticky, + 아이콘
- [ ] `.tab-toast`: position absolute, z-index: 200, 애니메이션
- [ ] 다크 테마 CSS 변수 (SRS §5.6.1 전체 변수 목록)
- [ ] `::-webkit-scrollbar` thin 스타일 (탭 바 전용)

### 6.6 viewer.js 분기 조건 추가

**파일**: `src/renderer/viewer.js`

- [ ] `Ctrl+W` 핸들러: `enableTabs`이면 `tabManager.closeTab()`, 아니면 기존 `window.close()`
- [ ] `render-markdown` IPC 수신 시: 탭 활성 상태면 활성 탭의 상태 업데이트
- [ ] `sidebar-tree` IPC 수신 시: 활성 탭의 sidebarTree 업데이트

### 6.7 파일 감시와 탭 연동

**파일**: `src/main/window-manager.js` (Phase 2에서 구현한 watcher 확장)

- [ ] `switchTab` 시 활성 watcher를 새 탭의 filePath로 교체:
  - 렌더러에서 `switchTab` 후 IPC로 활성 filePath 알림
  - 또는: 탭 전환 시 watcher 교체 불필요 — 탭 전환 시 checkFileMtime로 stale 검사, watcher는 창 단위 유지

## 테스트

### 정상 케이스

```
Given: enableTabs: true, README.md 열려 있음
When: 사이드바에서 guide.md 클릭
Then: 새 탭 생성, 탭 바에 2개 탭, guide.md 표시
```

```
Given: 탭 1(scrollTop=300), 탭 2(scrollTop=100)
When: 탭 1 → 탭 2 → 탭 1
Then: 탭 1의 scrollTop이 300 ±5px
```

```
Given: enableTabs: true, Ctrl+T
When: .md 파일 선택
Then: 새 탭에서 선택한 파일 열림
```

### 예외 케이스

```
Given: 20개 탭 열려 있음
When: 새 파일 클릭
Then: 새 탭 미생성, 토스트 메시지 표시
```

```
Given: enableTabs: false
When: 사이드바 파일 클릭
Then: 기존 동작 (navigateTo), 탭 바 미표시
```

```
Given: 1개 탭만 열림
When: Ctrl+W
Then: 뷰어 창 닫힘
```

### 경계값 테스트

```
Given: 탭0 활성 중 외부에서 비활성 탭1의 파일 수정
When: 탭1로 전환
Then: checkFileMtime → mtime > cachedAt → 재렌더링
```

### 회귀테스트 조건

- [ ] enableTabs: false일 때 기존 동작 완전 보존
- [ ] 탭과 사이드바 검색 연동 정상
- [ ] 탭과 PDF 내보내기 연동 (활성 탭 기준)
- [ ] MCP open_markdown → 새 창 (탭이 아님)
