# Phase 5: PDF 내보내기

## 목표

현재 문서 또는 사이드바의 모든 파일을 PDF로 내보내는 기능을 구현한다 (FR-18-003). 뷰어 FAB 버튼 + 모달 다이얼로그 + 숨겨진 BrowserWindow 기반 printToPDF.

## 선행 조건

- Phase 1 완료 (모듈 시스템)
- Phase 4 완료 (Escape 키 우선순위 체인)

## 아키텍처 참조

- [00-1.architecture.md](./00-1.architecture.md) §3.2 PDF 내보내기 흐름
- [00-2.tech-decisions.md](./00-2.tech-decisions.md) ADR-004, ADR-009
- SRS §2.3 FR-18-003, §5.3 모달 목업, §5.8.2 접근성

## 구현 체크리스트

### 5.1 preload.js에 PDF API 추가

**파일**: `src/main/preload.js`

- [ ] `exportPdf: (opts) => ipcRenderer.invoke('export-pdf', opts)` 추가
- [ ] `cancelExport: () => ipcRenderer.send('cancel-export')` 추가
- [ ] `pdfRenderComplete: () => ipcRenderer.send('pdf-render-complete')` 추가
- [ ] `onExportProgress` 리스너 추가 (cleanup 함수 반환)

### 5.2 pdf-export-ui.js 구현 (신규)

**파일**: `src/renderer/pdf-export-ui.js`

- [ ] IIFE + `window.__docuLightModules` 등록
- [ ] `init()` 함수:
  - FAB 버튼 (`#btn-export-pdf`) 클릭 → 모달 열기
  - 모달 DOM 참조 획득
  - Save 버튼 클릭 핸들러
  - Cancel 버튼 클릭 핸들러
  - Escape 키 → 모달 닫기
  - `pdfMode: true` 수신 시 렌더러 동작:
    - FAB 버튼, 사이드바, TOC, 리사이즈 핸들, 탭 바 숨김
    - Mermaid 렌더링 완료 감지 (MutationObserver + mermaid.run() Promise)
    - 200ms idle 후 `window.doclight.pdfRenderComplete()` 호출
  - export-progress 리스너 등록 → 프로그레스 바 업데이트

- [ ] 모달 열기/닫기:
  - Focus trap 구현 (SRS §5.8.2)
  - 열 때: previousFocus 저장, 첫 라디오로 포커스 이동
  - 닫을 때: previousFocus.focus() 복원
  - content-only 모드: "사이드바 전체 파일" 라디오 비활성화

- [ ] Save 핸들러:
  - `window.doclight.exportPdf({ scope, pageSize })` invoke
  - 응답 처리: success/cancelled/error
  - 배치 완료 시: "내보내기 완료" 2초 표시 후 모달 자동 닫기

- [ ] 진행률 표시:
  - `onExportProgress({ current, total, fileName })` → 프로그레스 바 + 텍스트 업데이트
  - i18n 키: `viewer.exportProgress` (파라미터 치환)

- [ ] Cancel 핸들러 (배치 진행 중):
  - `window.doclight.cancelExport()` send

### 5.3 viewer.html에 PDF UI 추가

**파일**: `src/renderer/viewer.html`

- [ ] 플로팅 버튼 영역에 PDF 버튼 추가:
  ```html
  <button class="fab btn-export-pdf" id="btn-export-pdf"
          data-i18n-title="viewer.exportPdf" title="PDF Export">📄</button>
  ```

- [ ] PDF 모달 HTML (body 끝 부분):
  ```html
  <div class="pdf-modal-overlay hidden" id="pdf-modal"
       role="dialog" aria-modal="true" aria-labelledby="pdf-modal-title">
    <div class="pdf-modal">
      <h2 id="pdf-modal-title" data-i18n="viewer.exportTitle">PDF Export</h2>
      <!-- 라디오: 현재 파일 / 사이드바 전체 -->
      <!-- 드롭다운: A4 / Letter -->
      <!-- 프로그레스 바 (hidden) -->
      <!-- Cancel / Save 버튼 -->
    </div>
  </div>
  ```

### 5.4 index.js에 export-pdf IPC 핸들러

**파일**: `src/main/index.js`

- [ ] `let isExporting = false` 플래그
- [ ] `ipcMain.handle('export-pdf', async (event, opts) => { ... })`:
  - isExporting 확인 → 이미 진행 중이면 에러 반환
  - 입력 검증: scope (current/all), pageSize (A4/Letter)
  - scope: 'current':
    a. `dialog.showSaveDialog()` → 기본 파일명: .md → .pdf
    b. savePath 검증 (취소, 확장자)
    c. 숨겨진 BrowserWindow 생성 (`show: false`, preload, sandbox)
    d. viewer.html 로드 → did-finish-load 대기
    e. render-markdown IPC 전송 (`{ pdfMode: true }`)
    f. `pdfWin.webContents.ipc.once('pdf-render-complete')` + 30초 타임아웃
    g. `pdfWin.webContents.printToPDF({ pageSize, printBackground: true, margins: { marginType: 'default' } })`
    h. `fs.promises.writeFile(savePath, buffer)` → pdfWin 닫기
    i. `finally { isExporting = false }`
  - scope: 'all':
    a. `dialog.showOpenDialog({ properties: ['openDirectory'] })`
    b. `collectMdPaths(tree)` 로 파일 목록 수집
    c. `ipcMain.once('cancel-export')` 핸들러 등록
    d. 각 파일 순차 처리: 숨겨진 BW 생성 → 렌더 → printToPDF → 저장
    e. `win.webContents.send('export-progress', { current, total, fileName })`
    f. 루프 내 `if (cancelled) break`
    g. 핸들러 해제 + `finally { isExporting = false }`

### 5.5 window-manager.js에 collectMdPaths 추가

**파일**: `src/main/window-manager.js`

- [ ] `collectMdPaths(tree, depth = 0)` static 함수:
  - tree.children 재귀 순회
  - `.md`/`.markdown` 확장자 파일의 절대 경로 수집
  - depth > 20이면 console.warn + 순회 중단
  - 반환: string[]

### 5.6 viewer.css에 PDF 스타일 추가

**파일**: `src/renderer/viewer.css`

- [ ] `.pdf-modal-overlay`: 전체 화면, z-index: 1000, 배경: `var(--pdf-modal-overlay-bg)`
- [ ] `.pdf-modal`: 중앙 정렬, 최대 너비 400px, 패딩, 라운딩
- [ ] `.pdf-progress-bar`: 프로그레스 바 컨테이너 + 채워진 부분
- [ ] `.pdf-progress-text`: 파일명 + 카운터
- [ ] `.fab.btn-export-pdf`: 기존 FAB 스타일 상속
- [ ] 다크 테마 변수 오버라이드

### 5.7 Escape 키 우선순위 업데이트

**파일**: `src/renderer/viewer.js`

- [ ] Escape 체인 1순위 추가: PDF 모달 열림 → 모달 닫기

## 테스트

### 정상 케이스

```
Given: README.md가 뷰어에 열려 있음
When: PDF FAB → "현재 파일" → A4 → Save → 저장 위치 선택
Then: README.pdf 생성, 파일 크기 > 0, PDF 헤더(%PDF-) 존재
```

```
Given: 사이드바에 5개 .md 파일
When: PDF FAB → "사이드바 전체" → Letter → Save → 디렉토리 선택
Then: 5개 .pdf 파일 생성, 진행률 표시
```

### 예외 케이스

```
Given: content-only 모드
When: PDF FAB 클릭
Then: "사이드바 전체" 라디오 비활성화
```

```
Given: isExporting = true
When: 다른 창에서 PDF FAB 클릭
Then: "Export already in progress" 에러 반환
```

### 경계값 테스트

```
Given: 3개 Mermaid 다이어그램 포함 문서
When: PDF 내보내기
Then: Mermaid SVG 렌더링 완료 후 PDF 생성 (타임아웃 30초 이내)
```

### 회귀테스트 조건

- [ ] 기존 FAB 버튼 (사이드바, TOC, Pin) 정상
- [ ] PDF 내보내기 후 숨겨진 BrowserWindow 완전 정리
- [ ] MCP list_viewers에 PDF 창 비노출
- [ ] Escape 키 체인 (모달 → 검색 → always-on-top) 정상
