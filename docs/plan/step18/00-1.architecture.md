# Architecture: DocLight Step 18 — 7개 기능 확장

## 1. System Context

DocLight는 Electron 기반 Markdown 뷰어로 Main Process(CJS)와 Renderer Process(Vanilla JS)로 구성된다.
Step 18은 기존 아키텍처 위에 7개 기능을 레이어링하며, 렌더러 측 모듈 분리가 핵심 아키텍처 변경이다.

```
┌──────────────────────────────────────────────────────────────────┐
│                        Main Process (CJS)                         │
│                                                                    │
│  ┌──────────┐  ┌──────────────┐  ┌──────────────┐  ┌──────────┐ │
│  │ index.js  │  │ window-mgr.js│  │ mcp-http.mjs │  │strings.js│ │
│  │ (IPC hub) │  │ (watcher,    │  │ (port disc.) │  │ (i18n)   │ │
│  │ (tray)    │  │  PDF export) │  │              │  │          │ │
│  │ (recent)  │  │              │  │              │  │          │ │
│  └─────┬─────┘  └──────┬──────┘  └──────────────┘  └──────────┘ │
│        │               │                                          │
│        │  IPC channels │                                          │
│        ▼               ▼                                          │
│  ┌──────────────────────────────────────┐                        │
│  │            preload.js                 │                        │
│  │  (contextBridge: window.doclight)     │                        │
│  └──────────────┬───────────────────────┘                        │
├─────────────────┼────────────────────────────────────────────────┤
│                 ▼          Renderer Process (sandbox)             │
│                                                                    │
│  ┌────────────────────────────────────────────────────────────┐  │
│  │                   window.DocuLight 네임스페이스              │  │
│  │  { state, dom, fn, modules }                                │  │
│  └───────┬────────┬────────┬──────────┬───────────────────────┘  │
│          │        │        │          │                           │
│  ┌───────┴──┐ ┌──┴──────┐ ┌┴────────┐ ┌┴──────────┐            │
│  │ image-   │ │sidebar- │ │pdf-     │ │tab-       │            │
│  │resolver  │ │search   │ │export-ui│ │manager    │            │
│  │ .js      │ │ .js     │ │ .js     │ │ .js       │            │
│  └──────────┘ └─────────┘ └─────────┘ └───────────┘            │
│          │        │        │          │                           │
│  ┌───────┴────────┴────────┴──────────┴───────────────────────┐  │
│  │                     viewer.js (코어)                         │  │
│  │  DOMContentLoaded → 네임스페이스 생성 → 모듈 init() 순차호출 │  │
│  └────────────────────────────────────────────────────────────┘  │
│                                                                    │
│  vendored: marked.min.js → purify.min.js → highlight.min.js      │
│            → mermaid.min.js                                       │
└──────────────────────────────────────────────────────────────────┘
```

## 2. Component Design

### 2.1 렌더러 모듈 시스템 (신규 — 핵심 아키텍처 변경)

**패턴**: IIFE + `window.__docuLightModules` 배열 + `window.DocuLight` 네임스페이스

```javascript
// 각 모듈 파일 (예: image-resolver.js)
(function() {
  'use strict';
  window.__docuLightModules = window.__docuLightModules || [];
  window.__docuLightModules.push({
    name: 'imageResolver',
    init: function() { /* 초기화 로직 */ }
  });
})();
```

```javascript
// viewer.js — DOMContentLoaded 핸들러
window.DocuLight = { state: {}, dom: {}, fn: {}, modules: {} };
// DOM 참조 등록
// 공유 함수 등록
// 모듈 등록 및 순차 초기화
for (const mod of window.__docuLightModules) {
  window.DocuLight.modules[mod.name] = mod;
  mod.init();
}
```

**스크립트 로드 순서** (`viewer.html`):
1. `marked.min.js` (vendored)
2. `purify.min.js` (vendored)
3. `highlight.min.js` (vendored)
4. `mermaid.min.js` (vendored)
5. `image-resolver.js` (신규 — marked.use() 호출)
6. `sidebar-search.js` (신규)
7. `pdf-export-ui.js` (신규)
8. `tab-manager.js` (신규)
9. `viewer.js` (코어 — 초기화 실행)

### 2.2 window.DocuLight 인터페이스

```javascript
window.DocuLight = {
  state: {
    currentFilePath: null,    // 현재 문서 파일 경로
    imageBasePath: null,      // 이미지 basePath
    sidebarTree: null,        // 사이드바 트리 데이터
    tabs: [],                 // 탭 배열 (FR-18-006)
    activeTabIndex: 0,        // 활성 탭 인덱스
    settings: {},             // 설정 캐시
    platform: null            // 'win32' | 'darwin' | 'linux'
  },
  dom: {
    content: null,            // #content 요소
    sidebarTree: null,        // #sidebar-tree 요소
    viewerContainer: null,    // #viewer-container 요소
    tabBar: null              // #tab-bar 요소
  },
  fn: {
    renderMarkdown: null,     // 마크다운 렌더링 함수
    navigateTo: null,         // 원본 네비게이션 함수
    navigateToForTab: null    // 탭 인터셉트 네비게이션 (tab-manager가 등록)
  },
  modules: {}                 // 등록된 모듈 { imageResolver, sidebarSearch, ... }
};
```

### 2.3 Main Process 변경 컴포넌트

#### 2.3.1 WindowManager 확장 (window-manager.js)

```
WindowManager
├── 기존
│   ├── createWindow(opts)
│   ├── updateWindow(windowId, opts)
│   ├── closeWindow(windowId?)
│   ├── navigateTo(windowId, filePath)
│   ├── navigateBack/Forward(windowId)
│   └── listWindows()
├── FR-18-001: 파일 감시
│   ├── fileWatchers: Map<windowId, { watcher, debounceTimer }>
│   ├── startFileWatcher(windowId)
│   ├── stopFileWatcher(windowId)
│   └── stopAllFileWatchers()
├── FR-18-003: PDF 내보내기
│   ├── collectMdPaths(tree, depth): string[]
│   └── (숨겨진 BrowserWindow는 index.js에서 직접 관리)
└── FR-18-005: 최근 파일
    └── onRecentFile: callback (index.js에서 설정)
```

#### 2.3.2 index.js 확장

```
index.js
├── 기존
│   ├── IPC 소켓 서버
│   ├── 시스템 트레이
│   └── 설정 관리
├── FR-18-001: autoRefresh 설정 연동
│   └── settings-changed 시 watcher 전체 토글
├── FR-18-002: 포트 파일 관리
│   └── before-quit에서 삭제
├── FR-18-003: PDF 내보내기
│   ├── ipcMain.handle('export-pdf')
│   ├── isExporting 플래그
│   └── cancel-export 리스너
├── FR-18-005: 최근 파일
│   ├── addRecentFile(filePath)
│   └── updateTrayMenu() 확장
└── FR-18-006: 탭 지원
    ├── ipcMain.handle('read-file-for-tab')
    ├── ipcMain.handle('check-file-mtime')
    └── ipcMain.handle('open-file-dialog')
```

#### 2.3.3 mcp-http.mjs 확장

```
startMcpHttpServer(windowManager, store, userDataPath)
└── 포트 바인딩 성공 시 → path.join(userDataPath, 'mcp-port') 파일 기록
```

### 2.4 Preload API 확장 (preload.js)

| API | 방향 | IPC 채널 | 관련 FR |
|-----|------|---------|---------|
| `exportPdf(opts)` | invoke | `export-pdf` | FR-18-003 |
| `cancelExport()` | send | `cancel-export` | FR-18-003 |
| `pdfRenderComplete()` | send | `pdf-render-complete` | FR-18-003 |
| `onExportProgress(cb)` | on | `export-progress` | FR-18-003 |
| `readFileForTab(filePath)` | invoke | `read-file-for-tab` | FR-18-006 |
| `checkFileMtime(filePath)` | invoke | `check-file-mtime` | FR-18-006 |
| `openFileDialog()` | invoke | `open-file-dialog` | FR-18-006 |

## 3. Data Flow

### 3.1 파일 감시 흐름 (FR-18-001)

```
fs.watch(filePath)
  │ change/rename event
  ▼
디바운스 (300ms)
  │
  ▼
fs.promises.readFile(filePath)
  │
  ▼
win.webContents.send('render-markdown', { markdown, filePath, imageBasePath, platform })
  │
  ▼
Renderer: 동일 filePath → scrollTop 보존 + 재렌더링
```

### 3.2 PDF 내보내기 흐름 (FR-18-003)

```
Renderer: FAB 클릭 → 모달 열림
  │
  ▼ ipcRenderer.invoke('export-pdf', { scope, pageSize })
  │
Main: 입력 검증 → dialog.showSaveDialog()
  │
  ▼
숨겨진 BrowserWindow 생성 (show: false)
  │ did-finish-load
  ▼
render-markdown IPC (pdfMode: true)
  │
  ▼ pdf-render-complete (or 30s timeout)
  │
printToPDF(options)
  │
  ▼
fs.writeFile(savePath, buffer)
  │
  ▼
숨겨진 BrowserWindow 닫기 → 결과 반환
```

### 3.3 탭 전환 흐름 (FR-18-006)

```
탭 클릭 또는 사이드바 파일 클릭
  │
  ▼
현재 탭 상태 저장 (scrollTop, renderedHtml)
  │
  ▼
새 탭의 filePath → checkFileMtime IPC
  │
  ├── mtime > cachedAt → readFileForTab → 재렌더링
  └── mtime <= cachedAt → 캐시된 renderedHtml 복원
  │
  ▼
scrollTop 복원, 사이드바 트리 교체
```

### 3.4 이미지 경로 해석 흐름 (FR-18-007)

```
Markdown 파서 (marked.use() 커스텀 렌더러)
  │ image 토큰: { href, title, text }
  ▼
resolveImagePath(href)
  │
  ├── http(s)://, data:, file:// → 그대로 반환
  └── 상대 경로
      │
      ▼
    resolveRelativePath(basePath, href)
      │
      ▼
    isPathWithin(absolutePath, basePath) → 경로 트래버설 검증
      │
      ├── 통과 → pathToFileUrl() → file:///absolute/path
      └── 실패 → 빈 문자열 (차단)
```

## 4. Data Model

### 4.1 electron-store 추가 키

| 키 | 타입 | 기본값 | 관련 FR |
|----|------|--------|---------|
| `autoRefresh` | boolean | `true` | FR-18-001 |
| `enableTabs` | boolean | `false` | FR-18-006 |
| `recentFiles` | string[] | `[]` | FR-18-005 |

### 4.2 파일 감시 상태 (메인 프로세스 메모리)

```javascript
// WindowManager 내부
this.fileWatchers = new Map();
// key: windowId
// value: { watcher: FSWatcher | null, debounceTimer: number | null }
```

### 4.3 탭 상태 (렌더러 메모리)

```javascript
// Tab 객체
{
  id: string,              // UUID
  title: string,           // 탭 표시 제목
  filePath: string | null, // 파일 경로
  markdown: string,        // 원본 markdown
  renderedHtml: string,    // 캐시된 HTML
  scrollTop: number,       // 스크롤 위치
  sidebarTree: object | null,
  currentSidebarPath: string | null,
  cachedAt: number         // Date.now() 타임스탬프
}
```

### 4.4 포트 디스커버리 파일

| 항목 | 내용 |
|------|------|
| 경로 | `{app.getPath('userData')}/mcp-port` |
| 포맷 | 평문, 포트 번호만 |
| 생명주기 | 앱 시작 시 생성, 종료 시 삭제 |

## 5. 파일 변경 매트릭스

| 파일 | P1 | P2 | P3 | P4 | P5 | P6 | P7 |
|------|:--:|:--:|:--:|:--:|:--:|:--:|:--:|
| `src/main/index.js` | ● | ● | ● | | ● | ● | |
| `src/main/window-manager.js` | ● | ● | ● | | ● | | |
| `src/main/mcp-http.mjs` | ● | | | | | | |
| `src/main/preload.js` | | | | | ● | ● | |
| `src/renderer/viewer.html` | ● | | | ● | ● | ● | |
| `src/renderer/viewer.js` | ● | ● | | | | ● | |
| `src/renderer/viewer.css` | | | | ● | ● | ● | |
| `src/renderer/image-resolver.js` | ● | | | | | | |
| `src/renderer/sidebar-search.js` | | | | ● | | | |
| `src/renderer/pdf-export-ui.js` | | | | | ● | | |
| `src/renderer/tab-manager.js` | | | | | | ● | |
| `src/renderer/settings.html` | ● | | | | | | |
| `src/renderer/settings.js` | ● | | | | | | |
| `src/locales/*.json` (4개) | ● | | | | | | |
| `CLAUDE.md` | | | | | | | ● |

P1=Phase 1, ..., P7=Phase 7

## 6. 보안 모델

| 보안 항목 | 구현 방식 | 관련 FR |
|-----------|----------|---------|
| 이미지 경로 트래버설 | `isPathWithin()` 순수 JS 검증 | FR-18-007 |
| PDF BrowserWindow | contextIsolation + sandbox | FR-18-003 |
| pdf-render-complete sender 검증 | `pdfWin.webContents.ipc.once()` | FR-18-003 |
| read-file-for-tab 범위 제한 | `.md` 확장자 + 절대 경로 검증 | FR-18-006 |
| check-file-mtime 정보 유출 | `.md` 확장자 제한 | FR-18-006 |
| 포트 파일 | 숫자만 기록, 인젝션 불가 | FR-18-002 |
| DOMPurify | 기존 새니타이징 유지 | 전체 |
