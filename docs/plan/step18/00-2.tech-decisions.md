# Tech Decisions: DocLight Step 18

## ADR-001: 렌더러 모듈 패턴 — IIFE + window.DocuLight

**결정**: ES Module 대신 IIFE + 전역 네임스페이스 패턴을 사용한다.

**근거**:
1. 기존 vendored 라이브러리(marked, DOMPurify, highlight.js, mermaid)가 전역 변수 UMD 번들
2. ES Module의 `defer` 특성이 기존 DOMContentLoaded 타이밍과 충돌
3. 번들러(webpack/vite) 미사용 프로젝트에서 bare import specifier 불가
4. `window.__docuLightModules` 배열 패턴으로 로드 순서 안전성 확보

**대안**: ES Module + 번들러 도입 → 과도한 변경, Step 18 범위 초과

## ADR-002: 이미지 경로 해석 — 순수 JS (path 모듈 미사용)

**결정**: `resolveRelativePath()`, `isPathWithin()`, `pathToFileUrl()` 모두 순수 JavaScript 문자열 연산으로 구현한다.

**근거**:
- 렌더러 프로세스는 `sandbox: true`이므로 Node.js `path` 모듈 사용 불가
- Preload에서 path 모듈 래핑 추가 시 API 표면 증가 → 불필요한 복잡성

**구현**: SRS §6.3의 `resolveRelativePath()` 레퍼런스 구현을 그대로 사용

## ADR-003: 파일 감시 — fs.watch() (fs.watchFile 대신)

**결정**: `fs.watch(filePath, { persistent: false })`를 사용한다.

**근거**:
1. `fs.watchFile`은 폴링 기반으로 성능 열화 (100ms~5s 간격 CPU 사용)
2. `fs.watch`는 OS 수준 이벤트 (inotify/FSEvents/ReadDirectoryChangesW) 사용
3. Windows NTFS에서 정상 동작
4. `persistent: false`로 앱 종료 차단 방지

**알려진 제한**:
- macOS: `filename` 콜백이 `null`일 수 있음 → 원본 filePath 폴백
- Windows: 이벤트 중복 가능 → 300ms 디바운스로 대응
- atomic save (rename): rename 이벤트 수신 → `fs.existsSync()` 확인 후 change와 동일 처리

## ADR-004: PDF 내보내기 — printToPDF (puppeteer 대신)

**결정**: Electron 내장 `webContents.printToPDF()`를 사용한다.

**근거**:
1. puppeteer는 별도 Chromium 인스턴스 필요 → 바이너리 크기 +100MB
2. Electron의 BrowserWindow가 이미 Chromium이므로 printToPDF() 내장
3. 숨겨진 BrowserWindow로 렌더링 파이프라인 재사용

**구현 세부**:
- `{ show: false }` 숨겨진 BrowserWindow
- WindowManager의 windows Map에 등록하지 않음 (MCP list_viewers 비노출)
- `did-finish-load` 이벤트 사용 (notifyReady 핸드셰이크 미사용)
- Mermaid 렌더링 완료는 MutationObserver + 200ms idle + mermaid.run() Promise 조합

## ADR-005: 탭 상태 관리 — 렌더러 메모리 (IndexedDB 대신)

**결정**: 탭 상태를 렌더러 JS 힙 메모리에만 저장한다.

**근거**:
1. 탭은 창 생명주기에 종속 (창 닫으면 소멸)
2. IndexedDB 영속화 시 stale 데이터 관리 복잡성 증가
3. 20탭 × ~5MB = ~100MB로 메모리 상한 예측 가능

**대안 검토**:
- Phase 2에서 LRU 캐시 eviction 도입 가능 (renderedHtml을 null로 설정, 전환 시 재렌더링)

## ADR-006: 탭-사이드바 인터셉트 — Late Binding 패턴

**결정**: `window.DocuLight.fn.navigateToForTab`을 late binding으로 참조한다.

**근거**:
1. sidebar-search.js가 tab-manager.js 이전에 로드됨
2. tab-manager.js init()에서 navigateTo를 래핑하여 navigateToForTab 등록
3. 클릭 이벤트 시점에 fn.navigateToForTab을 동적 조회 → 초기화 순서 무관

**규칙**: 각 모듈은 init 시점에 `fn.navigateTo`를 로컬 변수에 캐싱하지 않는다.

## ADR-007: 포트 디스커버리 — 평문 파일 (JSON 대신)

**결정**: `{userData}/mcp-port` 파일에 포트 번호만 평문으로 기록한다.

**근거**:
1. 외부 클라이언트가 최소 의존성으로 파싱 가능 (`parseInt(content.trim())`)
2. JSON 파싱 불필요 → shell 스크립트에서도 `cat`으로 즉시 사용
3. 앱 비정상 종료 시 다음 실행에서 덮어쓰기로 자동 해소

## ADR-008: 탭 기능 기본값 — false

**결정**: `enableTabs` 기본값을 `false`로 설정한다.

**근거**:
1. `enableTabs: true`는 사이드바 클릭 동작을 근본적으로 변경
2. 기존 사용자 UX 보존 (단일 문서 교체)
3. 사용자가 Settings에서 명시적으로 활성화하도록 유도

## ADR-009: 동시 PDF 내보내기 방지 — isExporting 플래그

**결정**: `export-pdf` IPC 핸들러에 `isExporting` 플래그를 사용한다.

**근거**:
1. 숨겨진 BrowserWindow 다중 생성 시 리소스 과다 사용
2. 단일 플래그로 단순하게 제어 가능
3. `finally { isExporting = false }` 블록으로 모든 종료 경로에서 복구

## ADR-010: Escape 키 우선순위 체인

**결정**: Escape 키를 우선순위 기반 체인으로 처리한다.

| 우선순위 | 조건 | 동작 |
|----------|------|------|
| 1 | PDF 모달 열림 | 모달 닫기 |
| 2 | 사이드바 검색 활성 | 검색 종료 |
| 3 | always-on-top 활성 | 해제 |

**구현**: 단일 keydown 핸들러에서 조건부 분기, 첫 번째 매칭 시 return.

## 외부 라이브러리

### 기존 유지 (변경 없음)
| 라이브러리 | 버전 | 용도 |
|-----------|------|------|
| `electron` | ^33.4.0 | 데스크톱 프레임워크 |
| `electron-store` | ^8.2.0 | 설정 영속 |
| `@modelcontextprotocol/sdk` | ^1.12.1 | MCP 프로토콜 |
| `marked` | v17.0.1 (vendored) | Markdown 파싱 |
| `DOMPurify` | (vendored) | XSS 방지 |
| `highlight.js` | (vendored) | 코드 신택스 강조 |
| `mermaid` | (vendored) | 다이어그램 렌더링 |

### 신규 의존성
- **없음** — Step 18은 추가 npm 패키지를 설치하지 않는다.

## 언어/프레임워크 호환성

| 항목 | 요구사항 | 확인 |
|------|---------|------|
| Node.js | >= 20.0.0 | `fs.watch()` 안정적 동작 |
| Electron | >= 33.0.0 | `printToPDF()` margins 옵션 지원 |
| marked | v17.0.1 | `marked.use()` API (setOptions deprecated 대체) |
| CSP | `img-src file:` | 이미 허용 상태 |
