# Phase 2: 파일 감시 및 자동 새로고침

## 목표

열려 있는 .md 파일의 변경을 감지하여 자동으로 다시 렌더링한다 (FR-18-001). 외부 에디터에서 파일 수정 시 뷰어에 실시간 반영.

## 선행 조건

- Phase 1 완료 (window.DocuLight 네임스페이스, settings 스키마)

## 아키텍처 참조

- [00-1.architecture.md](./00-1.architecture.md) §2.3.1 WindowManager 확장
- [00-2.tech-decisions.md](./00-2.tech-decisions.md) ADR-003

## 구현 체크리스트

### 2.1 WindowManager에 watcher 관리 추가

**파일**: `src/main/window-manager.js`

- [ ] `this.fileWatchers = new Map()` 초기화
- [ ] `startFileWatcher(windowId)` 메서드 구현:
  - `entry.meta.filePath` 없으면 return (content-only)
  - `autoRefresh` 설정 확인
  - 기존 watcher 있으면 먼저 stopFileWatcher 호출
  - `fs.watch(filePath, { persistent: false })` try/catch로 감싸기
  - 예외 시 console.error + watcher를 null로 설정
  - `change` 이벤트: 300ms 디바운스 → 파일 재읽기 → render-markdown IPC
  - `rename` 이벤트: fs.existsSync(filePath) → 존재하면 change와 동일, 미존재시 watcher 해제
  - macOS filename=null 대응: 원본 filePath로 폴백
  - watcher.on('error') → console.error + watcher 해제
  - fileWatchers.set(windowId, { watcher, debounceTimer: null })
- [ ] `stopFileWatcher(windowId)` 메서드 구현:
  - debounceTimer 먼저 clearTimeout
  - watcher.close()
  - fileWatchers.delete(windowId)
- [ ] `stopAllFileWatchers()` 메서드 구현:
  - 모든 windowId에 대해 stopFileWatcher 호출
- [ ] 파일 재읽기 로직:
  ```javascript
  console.log('[doculight] file-changed:', filePath)
  const markdown = await fs.promises.readFile(filePath, 'utf-8')
  const imageBasePath = /* 기존 로직 */
  win.webContents.send('render-markdown', { markdown, filePath, imageBasePath, platform })
  ```

### 2.2 watcher 시작/해제 연결

**파일**: `src/main/window-manager.js`

- [ ] `onWindowReady(windowId)`: filePath가 있으면 `startFileWatcher(windowId)`
- [ ] `navigateTo(windowId, filePath)`: 기존 watcher 해제 → 새 filePath에 대해 startFileWatcher
- [ ] `closeWindow(windowId?)`: `stopFileWatcher(windowId)` 호출 추가

**파일**: `src/main/index.js`

- [ ] `file-dropped` 핸들러: watcher 시작 연결
- [ ] `settings-changed` 이벤트에서 `autoRefresh` 변경 감지:
  - true → 모든 열린 창의 watcher 시작
  - false → `windowManager.stopAllFileWatchers()`
- [ ] `before-quit` 핸들러: `windowManager.stopAllFileWatchers()` 호출 (포트 파일 삭제 전)

### 2.3 스크롤 위치 보존 (렌더러)

**파일**: `src/renderer/viewer.js`

- [ ] `onRenderMarkdown` 핸들러에서:
  - 수신된 `data.filePath`가 `window.DocuLight.state.currentFilePath`와 동일하면:
    - 렌더링 전: `const savedScrollTop = dom.viewerContainer.scrollTop` 저장
    - 렌더링 후: `dom.viewerContainer.scrollTop = savedScrollTop` 복원
  - 다른 파일이면: 기존 동작 (scrollTop = 0)

## 테스트

### 정상 케이스

```
Given: 뷰어에 test.md가 열려 있고 autoRefresh: true
When: 외부 에디터에서 test.md 수정 후 저장
Then: 300ms 디바운스 후 뷰어 렌더링 갱신
      검증: console.log에 '[doculight] file-changed: test.md' 출력
```

```
Given: test.md가 열려 있고 scrollTop을 500px로 스크롤
When: 외부에서 test.md 수정 후 저장
Then: 자동 새로고침 후 scrollTop이 500 ±5px
```

### 예외 케이스

```
Given: autoRefresh: false
When: 외부에서 test.md 수정
Then: 뷰어 렌더링 미갱신
```

```
Given: 감시 중 파일 삭제
When: test.md 삭제
Then: 기존 렌더링 유지, console.error 로깅, 앱 크래시 없음
```

### 경계값 테스트

```
Given: VS Code atomic save (rename 이벤트)
When: test.md 저장
Then: rename 이벤트 → existsSync 확인 → 파일 재읽기 → 렌더링 갱신
```

### 회귀테스트 조건

- [ ] 창 열기/닫기 정상 동작
- [ ] 사이드바 네비게이션 정상
- [ ] MCP open_markdown/update_markdown 정상
- [ ] Settings UI autoRefresh 체크박스 동작
