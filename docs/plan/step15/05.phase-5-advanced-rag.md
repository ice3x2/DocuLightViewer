# Phase 5: Advanced RAG (Query Rewriting & Document Grading)

## 1. 목표 및 범위

### 1.1 목표
- Document Grading: 검색 결과 관련성 평가
- Query Rewriting: 검색 실패 시 질문 재구성

### 1.2 요구사항 매핑
| 요구사항 ID | 설명 | 수용 기준 |
|-------------|------|----------|
| FR-CB-016 | Query Rewriting | 검색 실패 시 질문 재구성 후 재검색 |
| FR-CB-017 | Document Grading | 검색된 문서 관련성 평가 및 필터링 |

### 1.3 선행 조건
- **Phase 3 완료**: 기본 RAG 워크플로우

### 1.4 아키텍처 참조
- [00-1.architecture.md](./00-1.architecture.md) 섹션 1.2 (데이터 흐름)
- [00-2.tech-decisions.md](./00-2.tech-decisions.md) ADR-005 (Structured Output)

---

## 2. 구현 항목 체크리스트

### 2.1 Document Grading 노드
- [ ] `src/services/chatbot/workflow/nodes/grade.js` 생성
  - [ ] Zod 스키마 (binaryScore: yes/no)
  - [ ] 관련성 평가 프롬프트 (영어)
  - [ ] 점수 계산 (0-1)

### 2.2 Query Rewriting 노드
- [ ] `src/services/chatbot/workflow/nodes/rewrite.js` 생성
  - [ ] 질문 재구성 프롬프트 (영어)
  - [ ] 최대 2회 재시도 제한
  - [ ] rewriteCount 상태 관리

### 2.3 상태 확장
- [ ] `src/services/chatbot/workflow/state.js` 수정
  - [ ] relevanceScore 필드 추가
  - [ ] rewriteCount 필드 추가

### 2.4 그래프 수정
- [ ] `src/services/chatbot/workflow/graph.js` 수정
  - [ ] gradeDocuments 노드 추가
  - [ ] rewriteQuery 노드 추가
  - [ ] routeByRelevance 조건부 엣지 추가

---

## 3. 상세 구현 가이드

### 3.1 Document Grading 노드

```javascript
// src/services/chatbot/workflow/nodes/grade.js

import { z } from "zod";
import { GRADE_PROMPT } from "../prompts.js";

const gradingSchema = z.object({
  binaryScore: z.enum(["yes", "no"]),
  reasoning: z.string().optional(),
});

export async function gradeDocuments(state, { llm }) {
  const { messages, retrievedDocs } = state;
  const question = messages[messages.length - 1].content;

  if (!retrievedDocs || retrievedDocs.length === 0) {
    return {
      relevanceScore: 0,
      currentStep: "gradeDocuments",
    };
  }

  const model = llm.withStructuredOutput(gradingSchema);

  let relevantCount = 0;
  for (const doc of retrievedDocs) {
    const prompt = GRADE_PROMPT
      .replace("{question}", question)
      .replace("{document}", doc.pageContent);

    const result = await model.invoke(prompt);
    if (result.binaryScore === "yes") {
      relevantCount++;
    }
  }

  const relevanceScore = relevantCount / retrievedDocs.length;

  return {
    relevanceScore,
    currentStep: "gradeDocuments",
  };
}
```

### 3.2 Query Rewriting 노드

```javascript
// src/services/chatbot/workflow/nodes/rewrite.js

import { HumanMessage } from "@langchain/core/messages";
import { REWRITE_PROMPT } from "../prompts.js";

export async function rewriteQuery(state, { llm }) {
  const { messages, rewriteCount } = state;

  // 최대 2회 재시도
  if (rewriteCount >= 2) {
    return { currentStep: "rewriteQuery" };
  }

  const originalQuestion = messages[messages.length - 1].content;

  const prompt = REWRITE_PROMPT.replace("{question}", originalQuestion);
  const response = await llm.invoke(prompt);
  const rewrittenQuestion = response.content.trim();

  // 재작성된 질문으로 메시지 교체
  const newMessages = [
    ...messages.slice(0, -1),
    new HumanMessage(rewrittenQuestion),
  ];

  return {
    messages: newMessages,
    rewriteCount: (rewriteCount || 0) + 1,
    currentStep: "rewriteQuery",
  };
}
```

### 3.3 프롬프트 추가

```javascript
// src/services/chatbot/workflow/prompts.js (추가)

export const GRADE_PROMPT = `You are a grader assessing relevance of a retrieved document to a user question.

Here is the retrieved document:
{document}

Here is the user question: {question}

If the document contains keywords or semantic meaning related to the question, grade it as relevant.
Give a binary score 'yes' or 'no' to indicate whether the document is relevant to the question.`;

export const REWRITE_PROMPT = `You are a query optimizer.
Rewrite the following question to improve search results.
Focus on key terms and make the intent clearer.

Original question: {question}

Rewritten question:`;
```

### 3.4 그래프 수정

```javascript
// src/services/chatbot/workflow/graph.js (수정)

/**
 * 관련성 점수에 따른 라우팅
 * - 0.7 이상: 바로 답변 생성
 * - 0.7 미만 & 재시도 가능: 쿼리 재작성 후 재검색
 * - 0.7 미만 & 재시도 초과: 상위 문서로 답변 생성 (graceful degradation)
 */
function routeByRelevance(state) {
  const { relevanceScore, rewriteCount, retrievedDocs } = state;

  // 충분한 관련성 → 답변 생성
  if (relevanceScore >= 0.7) {
    return "generateAnswer";
  }

  // 재시도 가능 → 쿼리 재작성
  if ((rewriteCount || 0) < 2) {
    return "rewriteQuery";
  }

  // 재시도 초과 시: 검색 결과가 있으면 진행, 없으면 no-context 응답
  if (retrievedDocs && retrievedDocs.length > 0) {
    // 상위 3개 문서로 graceful degradation
    return "generateWithLowRelevance";
  }

  return "generateNoContext";
}

export function createChatbotGraph(config, llm, retriever) {
  const workflow = new StateGraph(ChatbotAnnotation)
    // 기존 노드들
    .addNode("gradeDocuments", (state) => gradeDocuments(state, { llm }))
    .addNode("rewriteQuery", (state) => rewriteQuery(state, { llm }))
    .addNode("generateWithLowRelevance", (state) => generateWithLowRelevance(state, { llm, config }))
    .addNode("generateNoContext", (state) => generateNoContext(state, { llm, config }))
    // 엣지 수정
    .addEdge("retrieveDocs", "gradeDocuments")
    .addConditionalEdges("gradeDocuments", routeByRelevance, {
      generateAnswer: "generateAnswer",
      rewriteQuery: "rewriteQuery",
      generateWithLowRelevance: "generateWithLowRelevance",
      generateNoContext: "generateNoContext",
    })
    .addEdge("rewriteQuery", "retrieveDocs")
    .addEdge("generateWithLowRelevance", END)
    .addEdge("generateNoContext", END);
  // ...
}
```

### 3.5 Low Relevance 및 No Context 핸들러

```javascript
// src/services/chatbot/workflow/nodes/generate.js (추가)

import { LOW_RELEVANCE_PROMPT, NO_CONTEXT_PROMPT } from "../prompts.js";

/**
 * 낮은 관련성 문서로 답변 생성 (Graceful Degradation)
 */
export async function generateWithLowRelevance(state, { llm, config }) {
  const { messages, retrievedDocs } = state;
  const userQuestion = messages[messages.length - 1].content;

  // 상위 3개 문서만 사용
  const topDocs = retrievedDocs.slice(0, 3);
  const context = topDocs
    .map((doc, i) => `[${i + 1}] ${doc.metadata.source}\n${doc.pageContent}`)
    .join("\n\n---\n\n");

  const prompt = LOW_RELEVANCE_PROMPT
    .replace("{context}", context)
    .replace("{question}", userQuestion);

  const response = await llm.invoke(prompt);

  return {
    messages: [response],
    currentStep: "generateWithLowRelevance",
  };
}

/**
 * 검색 결과 없이 답변 생성
 */
export async function generateNoContext(state, { llm, config }) {
  const { messages } = state;
  const userQuestion = messages[messages.length - 1].content;

  const prompt = NO_CONTEXT_PROMPT.replace("{question}", userQuestion);
  const response = await llm.invoke(prompt);

  return {
    messages: [response],
    currentStep: "generateNoContext",
  };
}
```

### 3.6 추가 프롬프트

```javascript
// src/services/chatbot/workflow/prompts.js (추가)

export const LOW_RELEVANCE_PROMPT = `The retrieved documents may not be directly relevant to the user's question.
Please provide the best possible answer based on the available information, but clearly indicate uncertainty.

AVAILABLE CONTEXT (may be partially relevant):
{context}

USER'S QUESTION: {question}

INSTRUCTIONS:
1. Attempt to answer based on available information
2. Clearly state if the answer might not be complete or accurate
3. Suggest what additional information might help
4. Be helpful despite limitations

IMPORTANT: Begin your response by acknowledging that the available information may not be complete.

Generate your response:`;

export const NO_CONTEXT_PROMPT = `No relevant documents were found for the user's question.

USER'S QUESTION: {question}

INSTRUCTIONS:
1. Politely inform the user that no relevant documents were found
2. If the question is general knowledge, provide a brief helpful response
3. Suggest the user try:
   - Rephrasing their question
   - Using different keywords
   - Checking if the information exists in the system
4. Stay helpful and constructive

LANGUAGE: Match the language of the user's question.

Generate your response:`;
```

---

## 4. 테스트 섹션

### 4.1 테스트 시나리오

#### TC-CB-016: Query Rewriting
```gherkin
Given 모호한 질문 "그거 어떻게 해?"가 주어짐
  And 첫 번째 검색에서 관련성 점수 < 0.7
When rewriteQuery가 호출됨
Then 질문이 더 명확하게 재구성됨
  And 재검색이 수행됨
```

#### TC-CB-017: Document Grading
```gherkin
Given 검색된 문서 20개가 있음
When gradeDocuments가 호출됨
Then 각 문서의 관련성이 평가됨
  And relevanceScore가 0-1 사이 값으로 설정됨
```

---

## 5. 예상 산출물

```
src/
└── services/
    └── chatbot/
        └── workflow/
            ├── state.js    # (수정) relevanceScore, rewriteCount
            ├── graph.js    # (수정) 새 노드 및 엣지
            ├── prompts.js  # (수정) GRADE_PROMPT, REWRITE_PROMPT
            └── nodes/
                ├── grade.js    # 신규
                └── rewrite.js  # 신규
```

---

## 6. 완료 기준

- [ ] Document Grading 정상 동작
- [ ] 관련성 0.7 미만 시 Query Rewriting 트리거
- [ ] 최대 2회 재시도 후 원본으로 진행
- [ ] 검증 문서 작성 완료
