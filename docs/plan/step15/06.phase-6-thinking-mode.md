# Phase 6: Thinking 모드

## 1. 목표 및 범위

### 1.1 목표
- 복잡한 질문에 대한 단계별 추론 수행
- Thinking 과정 실시간 표시

### 1.2 요구사항 매핑
| 요구사항 ID | 설명 | 수용 기준 |
|-------------|------|----------|
| FR-CB-011 | Thinking 모드 | 복잡한 질문에 대해 단계별 추론 수행 |

### 1.3 선행 조건
- **Phase 3 완료**: 기본 RAG 워크플로우
- **Phase 4 완료**: 대화 관리
- **Phase 5 완료**: Advanced RAG

### 1.4 아키텍처 참조
- [00-1.architecture.md](./00-1.architecture.md) 섹션 1.2 (Thinking Mode 워크플로우)

---

## 2. 구현 항목 체크리스트

### 2.1 상태 확장
- [ ] `src/services/chatbot/workflow/state.js` 수정
  - [ ] thinkingMode 필드 추가

### 2.2 Thinking 모드 노드 구현
- [ ] `src/services/chatbot/workflow/nodes/thinking/` 디렉토리 생성
  - [ ] `analyze.js` - 질문 분석
  - [ ] `plan.js` - 추론 계획 수립
  - [ ] `execute.js` - 단계별 실행

### 2.3 프롬프트 정의
- [ ] `src/services/chatbot/workflow/prompts.js` 수정
  - [ ] ANALYZE_PROMPT (영어)
  - [ ] PLAN_PROMPT (영어)
  - [ ] EXECUTE_PROMPT (영어)

### 2.4 그래프 수정
- [ ] thinkingMode에 따른 분기 추가
- [ ] Thinking 노드 체인 연결

---

## 3. 상세 구현 가이드

### 3.1 Thinking 분석 노드

```javascript
// src/services/chatbot/workflow/nodes/thinking/analyze.js

import { z } from "zod";
import { ANALYZE_PROMPT } from "../../prompts.js";

const analysisSchema = z.object({
  complexity: z.enum(["simple", "moderate", "complex"]),
  keyTopics: z.array(z.string()),
  requiredSteps: z.number().min(1).max(5),
});

export async function analyzeQuestion(state, { llm }) {
  const { messages } = state;
  const question = messages[messages.length - 1].content;

  const model = llm.withStructuredOutput(analysisSchema);
  const prompt = ANALYZE_PROMPT.replace("{question}", question);
  const analysis = await model.invoke(prompt);

  return {
    thinkingAnalysis: analysis,
    currentStep: "analyzeQuestion",
  };
}
```

### 3.2 Thinking 계획 노드

```javascript
// src/services/chatbot/workflow/nodes/thinking/plan.js

import { z } from "zod";
import { PLAN_PROMPT } from "../../prompts.js";

const planSchema = z.object({
  steps: z.array(z.object({
    stepNumber: z.number(),
    description: z.string(),
    expectedOutput: z.string(),
  })),
});

export async function planStrategy(state, { llm }) {
  const { messages, thinkingAnalysis, retrievedDocs } = state;
  const question = messages[messages.length - 1].content;

  const context = retrievedDocs
    .slice(0, 5)
    .map(d => d.pageContent)
    .join("\n---\n");

  const model = llm.withStructuredOutput(planSchema);
  const prompt = PLAN_PROMPT
    .replace("{question}", question)
    .replace("{analysis}", JSON.stringify(thinkingAnalysis))
    .replace("{context}", context);

  const plan = await model.invoke(prompt);

  return {
    thinkingPlan: plan,
    currentStep: "planStrategy",
  };
}
```

### 3.3 Thinking 실행 노드

```javascript
// src/services/chatbot/workflow/nodes/thinking/execute.js

import { EXECUTE_PROMPT } from "../../prompts.js";

export async function executeSteps(state, { llm, config }) {
  const { messages, thinkingPlan, retrievedDocs } = state;
  const question = messages[messages.length - 1].content;

  const context = retrievedDocs
    .map((d, i) => `[${i + 1}] ${d.pageContent}`)
    .join("\n---\n");

  const stepsText = thinkingPlan.steps
    .map(s => `Step ${s.stepNumber}: ${s.description}`)
    .join("\n");

  const prompt = EXECUTE_PROMPT
    .replace("{question}", question)
    .replace("{steps}", stepsText)
    .replace("{context}", context);

  const response = await llm.invoke(prompt);

  return {
    messages: [response],
    currentStep: "executeSteps",
  };
}
```

### 3.4 프롬프트 정의

```javascript
// src/services/chatbot/workflow/prompts.js (추가)

export const ANALYZE_PROMPT = `Analyze the complexity of the following question.

Question: {question}

Determine:
1. Complexity level (simple, moderate, complex)
2. Key topics involved
3. Number of steps required to answer (1-5)`;

export const PLAN_PROMPT = `Create a step-by-step plan to answer this question.

Question: {question}
Analysis: {analysis}
Available context: {context}

Create a plan with clear steps.`;

export const EXECUTE_PROMPT = `Execute the following plan to answer the question.

Question: {question}

Plan:
{steps}

Context from documents:
{context}

Execute each step and provide a comprehensive answer.
IMPORTANT: Respond in the same language as the question.`;
```

### 3.5 그래프 수정

```javascript
// src/services/chatbot/workflow/graph.js (수정)

function routeByThinkingMode(state) {
  if (state.thinkingMode && state.queryType === "question") {
    return "analyzeQuestion";
  }
  return "generateAnswer";
}

// Thinking 모드 노드 추가
.addNode("analyzeQuestion", (state) => analyzeQuestion(state, { llm }))
.addNode("planStrategy", (state) => planStrategy(state, { llm }))
.addNode("executeSteps", (state) => executeSteps(state, { llm, config }))

// 엣지 추가
.addConditionalEdges("gradeDocuments", routeByThinkingMode)
.addEdge("analyzeQuestion", "planStrategy")
.addEdge("planStrategy", "executeSteps")
.addConditionalEdges("executeSteps", checkContextSize)
```

---

## 4. 테스트 섹션

### 4.1 테스트 시나리오

#### TC-CB-011: Thinking 모드 활성화
```gherkin
Given thinkingMode가 true로 설정됨
  And queryType이 "question"임
When 복잡한 질문이 주어짐
Then analyzeQuestion → planStrategy → executeSteps 순으로 실행됨
  And 각 단계 결과가 SSE로 전송됨
```

---

## 5. 예상 산출물

```
src/
└── services/
    └── chatbot/
        └── workflow/
            ├── state.js    # (수정) thinkingMode, thinkingAnalysis, thinkingPlan
            ├── graph.js    # (수정) Thinking 노드 및 라우팅
            ├── prompts.js  # (수정) ANALYZE/PLAN/EXECUTE_PROMPT
            └── nodes/
                └── thinking/
                    ├── analyze.js
                    ├── plan.js
                    └── execute.js
```

---

## 6. 완료 기준

- [ ] Thinking 모드 토글 동작
- [ ] 3단계 추론 과정 실행
- [ ] 각 단계 SSE 이벤트 전송
- [ ] 검증 문서 작성 완료
