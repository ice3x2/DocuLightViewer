# Step 15: RAG 기반 문서 챗봇 - 아키텍처 설계

## 1. 시스템 컨텍스트

### 1.1 전체 시스템 개요

```
┌─────────────────────────────────────────────────────────────────────────────┐
│                              DocLight System                                 │
├─────────────────────────────────────────────────────────────────────────────┤
│                                                                              │
│  ┌────────────────┐        ┌────────────────────────────────────────────┐   │
│  │   기존 DocLight │        │           Chatbot Module (Step 15)        │   │
│  │                │        │                                            │   │
│  │  - File Tree   │        │  ┌──────────┐  ┌──────────┐  ┌──────────┐ │   │
│  │  - Markdown    │◀──────▶│  │ Document │  │ LangGraph│  │ Chatbot  │ │   │
│  │    Viewer      │        │  │ Pipeline │  │ Workflow │  │   UI     │ │   │
│  │  - Admin       │        │  └──────────┘  └──────────┘  └──────────┘ │   │
│  └────────────────┘        └────────────────────────────────────────────┘   │
│                                        │                                     │
│                                        │ API Calls                           │
│                                        ▼                                     │
│  ┌──────────────────────────────────────────────────────────────────────┐   │
│  │                       External LLM Providers                          │   │
│  │                                                                       │   │
│  │   ┌──────────────┐   ┌──────────────┐   ┌──────────────┐             │   │
│  │   │   OpenAI     │   │ Azure OpenAI │   │   Ollama     │             │   │
│  │   │  - GPT-4o    │   │  - GPT-4o    │   │  - llama3    │             │   │
│  │   │  - Embedding │   │  - Embedding │   │  - nomic     │             │   │
│  │   └──────────────┘   └──────────────┘   └──────────────┘             │   │
│  └──────────────────────────────────────────────────────────────────────┘   │
│                                                                              │
└─────────────────────────────────────────────────────────────────────────────┘
```

### 1.2 데이터 흐름

```
[사용자 질문]
     │
     ▼
┌──────────────────────────────────────────────────────────────────────┐
│                        Request Flow                                   │
│                                                                       │
│  Browser ──POST──▶ /api/chatbot/chat ──SSE──▶ ChatbotController      │
│                                                       │               │
│                                                       ▼               │
│                              ┌─────────────────────────────────────┐ │
│                              │        LangGraph Workflow           │ │
│                              │                                     │ │
│                              │  [classifyQuery]                    │ │
│                              │        │                            │ │
│                              │        ▼                            │ │
│                              │  [retrieveDocs] ◀── VectorStore     │ │
│                              │        │                            │ │
│                              │        ▼                            │ │
│                              │  [gradeDocuments]                   │ │
│                              │        │                            │ │
│                              │   ┌────┴────┐                       │ │
│                              │   │ score   │                       │ │
│                              │   │ < 0.7?  │                       │ │
│                              │   └────┬────┘                       │ │
│                              │   yes  │  no                        │ │
│                              │   ▼    │                            │ │
│                              │ [rewriteQuery] │                    │ │
│                              │   │    │                            │ │
│                              │   └────┼────────▶ [generateAnswer]  │ │
│                              │        │                 │          │ │
│                              │        │                 ▼          │ │
│                              │        │      [checkContextSize]    │ │
│                              │        │                 │          │ │
│                              │        │         ┌──────┴──────┐    │ │
│                              │        │         │ > 70%?      │    │ │
│                              │        │         └──────┬──────┘    │ │
│                              │        │           yes  │  no       │ │
│                              │        │           ▼    │           │ │
│                              │        │  [summarizeHistory]  │     │ │
│                              │        │           │    │           │ │
│                              │        └───────────┴────┴──▶ END    │ │
│                              └─────────────────────────────────────┘ │
│                                                       │               │
│                                              SSE Stream               │
│                                                       ▼               │
│                              ┌─────────────────────────────────────┐ │
│                              │     Chatbot UI (Real-time Update)   │ │
│                              └─────────────────────────────────────┘ │
└──────────────────────────────────────────────────────────────────────┘
```

---

## 2. 컴포넌트 다이어그램

### 2.1 서버 사이드 컴포넌트

```
┌─────────────────────────────────────────────────────────────────────────────┐
│                           src/services/chatbot/                              │
├─────────────────────────────────────────────────────────────────────────────┤
│                                                                              │
│  ┌──────────────────────────────────────────────────────────────────────┐   │
│  │                      ChatbotService (index.js)                        │   │
│  │  - initialize(): Promise<void>                                        │   │
│  │  - chat(message, threadId, options): AsyncGenerator<SSEEvent>         │   │
│  │  - getHistory(threadId): ChatHistory                                  │   │
│  │  - clearHistory(threadId): void                                       │   │
│  │  - getStatus(): StatusResponse                                        │   │
│  └───────────────────────────────────┬──────────────────────────────────┘   │
│                                      │                                       │
│          ┌───────────────────────────┼───────────────────────────┐          │
│          │                           │                           │          │
│          ▼                           ▼                           ▼          │
│  ┌──────────────────┐   ┌──────────────────┐   ┌──────────────────┐        │
│  │  DocumentPipeline │   │  WorkflowEngine  │   │  SessionManager  │        │
│  │                  │   │                  │   │                  │        │
│  │  - DocWatcher    │   │  - StateGraph    │   │  - MemorySaver   │        │
│  │  - DocLoader     │   │  - Nodes         │   │  - ThreadStore   │        │
│  │  - VectorStore   │   │  - Edges         │   │                  │        │
│  └────────┬─────────┘   └────────┬─────────┘   └──────────────────┘        │
│           │                      │                                          │
│           │                      │                                          │
│  ┌────────▼─────────┐   ┌────────▼─────────────────────────────────────┐   │
│  │   LLMFactory     │   │              Workflow Nodes                   │   │
│  │                  │   │  ┌───────────┐ ┌───────────┐ ┌───────────┐   │   │
│  │  - createLLM()   │   │  │ classify  │ │ retrieve  │ │  grade    │   │   │
│  │  - createEmbed() │   │  │  Query    │ │   Docs    │ │  Docs     │   │   │
│  └──────────────────┘   │  └───────────┘ └───────────┘ └───────────┘   │   │
│                         │  ┌───────────┐ ┌───────────┐ ┌───────────┐   │   │
│                         │  │ rewrite   │ │ generate  │ │ summarize │   │   │
│                         │  │  Query    │ │  Answer   │ │ History   │   │   │
│                         │  └───────────┘ └───────────┘ └───────────┘   │   │
│                         └──────────────────────────────────────────────┘   │
│                                                                              │
└─────────────────────────────────────────────────────────────────────────────┘
```

### 2.2 클라이언트 사이드 컴포넌트

```
┌─────────────────────────────────────────────────────────────────────────────┐
│                          public/js/chatbot.js                                │
├─────────────────────────────────────────────────────────────────────────────┤
│                                                                              │
│  ┌──────────────────────────────────────────────────────────────────────┐   │
│  │                         ChatbotApp                                    │   │
│  │  - init(): void                                                       │   │
│  │  - sendMessage(content): Promise<void>                                │   │
│  │  - toggleThinkingMode(): void                                         │   │
│  └───────────────────────────────┬──────────────────────────────────────┘   │
│                                  │                                          │
│      ┌───────────────────────────┼───────────────────────────┐             │
│      │                           │                           │             │
│      ▼                           ▼                           ▼             │
│  ┌──────────────────┐   ┌──────────────────┐   ┌──────────────────┐       │
│  │   SSEClient      │   │   MessageList    │   │  MarkdownRenderer│       │
│  │                  │   │                  │   │                  │       │
│  │  - connect()     │   │  - addMessage()  │   │  - render()      │       │
│  │  - onEvent()     │   │  - updateLast()  │   │  - sanitize()    │       │
│  │  - close()       │   │  - scrollTo()    │   │                  │       │
│  └──────────────────┘   └──────────────────┘   └──────────────────┘       │
│                                                                              │
│  ┌──────────────────┐   ┌──────────────────┐   ┌──────────────────┐       │
│  │ WorkflowIndicator│   │  RetrievalInfo   │   │   InputArea      │       │
│  │                  │   │                  │   │                  │       │
│  │  - setStep()     │   │  - showSources() │   │  - getValue()    │       │
│  │  - complete()    │   │  - showScore()   │   │  - clear()       │       │
│  └──────────────────┘   └──────────────────┘   └──────────────────┘       │
│                                                                              │
└─────────────────────────────────────────────────────────────────────────────┘
```

---

## 3. 클래스 다이어그램

### 3.1 LLM Factory 계층

```
┌─────────────────────────────────────────────────────────────────────────┐
│                            <<interface>>                                 │
│                           BaseChatModel                                  │
│  ─────────────────────────────────────────────────────────────────────  │
│  + invoke(messages: Message[]): Promise<AIMessage>                      │
│  + stream(messages: Message[]): AsyncGenerator<AIMessageChunk>          │
│  + withStructuredOutput(schema: ZodSchema): ChatModel                   │
└─────────────────────────────────────────────────────────────────────────┘
                                    △
                                    │ implements
          ┌─────────────────────────┼─────────────────────────┐
          │                         │                         │
┌─────────┴─────────┐   ┌──────────┴──────────┐   ┌─────────┴─────────┐
│    ChatOpenAI     │   │  AzureChatOpenAI    │   │    ChatOllama     │
│ (@langchain/openai)│   │ (@langchain/openai) │   │(@langchain/ollama)│
├───────────────────┤   ├─────────────────────┤   ├───────────────────┤
│ - model: string   │   │ - model: string     │   │ - model: string   │
│ - apiKey: string  │   │ - azureOpenAIApiKey │   │ - baseUrl: string │
│ - temperature: num│   │ - azureOpenAIApi... │   │ - temperature: num│
└───────────────────┘   └─────────────────────┘   └───────────────────┘


┌─────────────────────────────────────────────────────────────────────────┐
│                            <<interface>>                                 │
│                            Embeddings                                    │
│  ─────────────────────────────────────────────────────────────────────  │
│  + embedDocuments(texts: string[]): Promise<number[][]>                 │
│  + embedQuery(text: string): Promise<number[]>                          │
└─────────────────────────────────────────────────────────────────────────┘
                                    △
                                    │ implements
          ┌─────────────────────────┼─────────────────────────┐
          │                         │                         │
┌─────────┴─────────┐   ┌──────────┴──────────┐   ┌─────────┴─────────┐
│  OpenAIEmbeddings │   │AzureOpenAIEmbeddings│   │ OllamaEmbeddings  │
│ (@langchain/openai)│   │ (@langchain/openai) │   │(@langchain/ollama)│
├───────────────────┤   ├─────────────────────┤   ├───────────────────┤
│ - model: string   │   │ - azureOpenAI...    │   │ - model: string   │
│ - apiKey: string  │   │   DeploymentName    │   │ - baseUrl: string │
└───────────────────┘   └─────────────────────┘   └───────────────────┘
```

### 3.2 LLMFactory 클래스

```
┌─────────────────────────────────────────────────────────────────────────┐
│                            LLMFactory                                    │
│  src/services/chatbot/llm-factory.js                                    │
├─────────────────────────────────────────────────────────────────────────┤
│ + createLLM(config: LLMConfig): BaseChatModel                           │
│ + createEmbeddings(config: EmbeddingConfig): Embeddings                 │
├─────────────────────────────────────────────────────────────────────────┤
│ - createOpenAILLM(config): ChatOpenAI                                   │
│ - createAzureLLM(config): AzureChatOpenAI                               │
│ - createOllamaLLM(config): ChatOllama                                   │
│ - createOpenAIEmbeddings(config): OpenAIEmbeddings                      │
│ - createAzureEmbeddings(config): AzureOpenAIEmbeddings                  │
│ - createOllamaEmbeddings(config): OllamaEmbeddings                      │
└─────────────────────────────────────────────────────────────────────────┘
```

### 3.3 Document Pipeline 클래스

```
┌─────────────────────────────────────────────────────────────────────────┐
│                            DocWatcher                                    │
│  src/services/chatbot/doc-watcher.js                                    │
├─────────────────────────────────────────────────────────────────────────┤
│ - docsRoot: string                                                      │
│ - watcher: FSWatcher (chokidar)                                         │
│ - debounceMs: number                                                    │
│ - pendingChanges: Map<string, Timeout>                                  │
├─────────────────────────────────────────────────────────────────────────┤
│ + constructor(docsRoot, options)                                        │
│ + on(event: 'add'|'change'|'remove', handler): void                     │
│ + close(): Promise<void>                                                │
│ - debouncedEmit(event, path): void                                      │
└─────────────────────────────────────────────────────────────────────────┘

┌─────────────────────────────────────────────────────────────────────────┐
│                            DocLoader                                     │
│  src/services/chatbot/doc-loader.js                                     │
├─────────────────────────────────────────────────────────────────────────┤
│ + loadMarkdownWithFrontmatter(filePath): Promise<{                      │
│     pageContent: string,                                                │
│     metadata: { filePath, source, name?, description?, ...}             │
│   }>                                                                    │
│ + parseFrontmatter(content): { frontmatter: object, body: string }      │
└─────────────────────────────────────────────────────────────────────────┘

┌─────────────────────────────────────────────────────────────────────────┐
│                         VectorStoreManager                               │
│  src/services/chatbot/vector-store.js                                   │
├─────────────────────────────────────────────────────────────────────────┤
│ - embeddings: Embeddings                                                │
│ - vectorStore: MemoryVectorStore                                        │
│ - splitter: RecursiveCharacterTextSplitter                              │
│ - documentHashes: Map<string, string>                                   │
│ - config: RAGConfig                                                     │
├─────────────────────────────────────────────────────────────────────────┤
│ + constructor(embeddings, config)                                       │
│ + initialize(): Promise<void>                                           │
│ + addDocument(filePath, content, metadata): Promise<void>               │
│ + removeDocument(filePath): Promise<void>                               │
│ + getRetriever(k?: number): VectorStoreRetriever                        │
│ + getStats(): { totalDocs, totalChunks, lastUpdated }                   │
│ - computeHash(content): string                                          │
└─────────────────────────────────────────────────────────────────────────┘
```

### 3.4 LangGraph Workflow 클래스

```
┌─────────────────────────────────────────────────────────────────────────┐
│                         ChatbotAnnotation                                │
│  src/services/chatbot/workflow/state.js                                 │
├─────────────────────────────────────────────────────────────────────────┤
│ + messages: Message[] (MessagesAnnotation)                              │
│ + summary: string                                                       │
│ + queryType: 'question'|'summary'|'chitchat'|'unknown'                  │
│ + retrievedDocs: Document[]                                             │
│ + relevanceScore: number                                                │
│ + currentStep: string                                                   │
│ + thinkingMode: boolean                                                 │
│ + rewriteCount: number                                                  │
└─────────────────────────────────────────────────────────────────────────┘

┌─────────────────────────────────────────────────────────────────────────┐
│                         WorkflowBuilder                                  │
│  src/services/chatbot/workflow/graph.js                                 │
├─────────────────────────────────────────────────────────────────────────┤
│ + createChatbotGraph(config, llm, retriever): CompiledStateGraph        │
├─────────────────────────────────────────────────────────────────────────┤
│ - routeByQueryType(state): string                                       │
│ - routeByRelevance(state): string                                       │
│ - checkContextSize(state, config): string                               │
└─────────────────────────────────────────────────────────────────────────┘

┌─────────────────────────────────────────────────────────────────────────┐
│                      Workflow Node Functions                             │
│  src/services/chatbot/workflow/nodes/                                   │
├─────────────────────────────────────────────────────────────────────────┤
│ classify.js:                                                            │
│   + classifyQuery(state, { llm }): Promise<Partial<State>>              │
│                                                                         │
│ retrieve.js:                                                            │
│   + retrieveDocs(state, { retriever }): Promise<Partial<State>>         │
│                                                                         │
│ grade.js:                                                               │
│   + gradeDocuments(state, { llm }): Promise<Partial<State>>             │
│                                                                         │
│ rewrite.js:                                                             │
│   + rewriteQuery(state, { llm }): Promise<Partial<State>>               │
│                                                                         │
│ generate.js:                                                            │
│   + generateAnswer(state, { llm, config }): Promise<Partial<State>>     │
│                                                                         │
│ summarize.js:                                                           │
│   + summarizeHistory(state, { llm, config }): Promise<Partial<State>>   │
│   + estimateTokens(state): number                                       │
└─────────────────────────────────────────────────────────────────────────┘
```

---

## 4. 시퀀스 다이어그램

### 4.1 기본 RAG 질의응답 플로우

```
┌────────┐    ┌──────────┐    ┌──────────┐    ┌──────────┐    ┌─────────┐
│Browser │    │Controller│    │ Workflow │    │VectorStore│    │   LLM   │
└───┬────┘    └────┬─────┘    └────┬─────┘    └────┬─────┘    └────┬────┘
    │              │               │               │               │
    │ POST /chat   │               │               │               │
    │─────────────>│               │               │               │
    │              │               │               │               │
    │              │ stream()      │               │               │
    │              │──────────────>│               │               │
    │              │               │               │               │
    │              │               │ classifyQuery │               │
    │              │               │───────────────────────────────>│
    │              │               │               │               │
    │ SSE: step    │<──────────────│               │               │
    │<─────────────│               │               │               │
    │              │               │               │               │
    │              │               │ retrieveDocs  │               │
    │              │               │──────────────>│               │
    │              │               │               │               │
    │              │               │  documents    │               │
    │              │               │<──────────────│               │
    │              │               │               │               │
    │ SSE: retrieval               │               │               │
    │<─────────────│<──────────────│               │               │
    │              │               │               │               │
    │              │               │ gradeDocuments│               │
    │              │               │───────────────────────────────>│
    │              │               │               │               │
    │ SSE: step    │<──────────────│               │               │
    │<─────────────│               │               │               │
    │              │               │               │               │
    │              │               │ generateAnswer│               │
    │              │               │───────────────────────────────>│
    │              │               │               │               │
    │              │               │ stream tokens │               │
    │ SSE: token   │<──────────────│<──────────────────────────────│
    │<─────────────│               │               │               │
    │ SSE: token   │<──────────────│<──────────────────────────────│
    │<─────────────│               │               │               │
    │ ...          │               │               │               │
    │              │               │               │               │
    │ SSE: done    │<──────────────│               │               │
    │<─────────────│               │               │               │
    │              │               │               │               │
```

### 4.2 문서 변경 감지 및 재임베딩 플로우

```
┌──────────┐    ┌──────────┐    ┌──────────┐    ┌──────────┐    ┌─────────┐
│FileSystem│    │DocWatcher│    │DocLoader │    │VectorStore│    │Embedding│
└────┬─────┘    └────┬─────┘    └────┬─────┘    └────┬─────┘    └────┬────┘
     │               │               │               │               │
     │ file changed  │               │               │               │
     │──────────────>│               │               │               │
     │               │               │               │               │
     │               │ debounce(1s)  │               │               │
     │               │───────┐       │               │               │
     │               │       │       │               │               │
     │               │<──────┘       │               │               │
     │               │               │               │               │
     │               │ emit('change')│               │               │
     │               │──────────────>│               │               │
     │               │               │               │               │
     │               │               │ loadMarkdown  │               │
     │               │               │ WithFrontmatter               │
     │               │               │──────────────>│               │
     │               │               │               │               │
     │               │               │ { content,    │               │
     │               │               │   metadata }  │               │
     │               │               │<──────────────│               │
     │               │               │               │               │
     │               │               │ addDocument   │               │
     │               │               │──────────────>│               │
     │               │               │               │               │
     │               │               │               │ computeHash   │
     │               │               │               │───────┐       │
     │               │               │               │       │       │
     │               │               │               │<──────┘       │
     │               │               │               │               │
     │               │               │               │ (hash changed?)
     │               │               │               │               │
     │               │               │               │ removeOldDocs │
     │               │               │               │───────┐       │
     │               │               │               │       │       │
     │               │               │               │<──────┘       │
     │               │               │               │               │
     │               │               │               │ splitText     │
     │               │               │               │───────┐       │
     │               │               │               │       │       │
     │               │               │               │<──────┘       │
     │               │               │               │               │
     │               │               │               │ embedDocuments│
     │               │               │               │──────────────>│
     │               │               │               │               │
     │               │               │               │   vectors     │
     │               │               │               │<──────────────│
     │               │               │               │               │
     │               │               │               │ addToStore    │
     │               │               │               │───────┐       │
     │               │               │               │       │       │
     │               │               │               │<──────┘       │
     │               │               │               │               │
```

---

## 5. 데이터 모델

### 5.1 설정 스키마

```typescript
// config.json5 chatbot 섹션 타입
interface ChatbotConfig {
  llm: LLMConfig;
  embedding: EmbeddingConfig;
  rag?: RAGConfig;
  context?: ContextConfig;
  systemPrompt?: string;
}

interface LLMConfig {
  type: 'openai' | 'azure-openai' | 'ollama';
  endpoint: string;
  apiKey: string;  // ollama는 빈 문자열 허용
  model: string;
  contextLength: number;
  temperature?: number;  // default: 0.7
  maxTokens?: number;    // default: 4096
  // azure-openai 전용
  apiVersion?: string;
  deploymentName?: string;
}

interface EmbeddingConfig {
  type: 'openai' | 'azure-openai' | 'ollama';
  endpoint: string;
  apiKey: string;
  model: string;
  // azure-openai 전용
  apiVersion?: string;
  deploymentName?: string;
}

interface RAGConfig {
  chunkSize?: number;      // default: 1000
  chunkOverlap?: number;   // default: 200
  retrievalCount?: number; // default: 20
}

interface ContextConfig {
  compressionThreshold?: number; // default: 0.7
  compressionTarget?: number;    // default: 0.1
}
```

### 5.2 LangGraph 상태 스키마

```typescript
interface ChatbotState {
  // MessagesAnnotation 기본
  messages: Array<HumanMessage | AIMessage | SystemMessage>;

  // 대화 요약 (컨텍스트 압축용)
  summary: string;

  // 질문 분류 결과
  queryType: 'question' | 'summary' | 'chitchat' | 'unknown';

  // 검색된 문서
  retrievedDocs: Document[];

  // 문서 관련성 점수
  relevanceScore: number;

  // 현재 워크플로우 단계
  currentStep: string;

  // Thinking 모드 활성화 여부
  thinkingMode: boolean;

  // Query Rewriting 횟수
  rewriteCount: number;
}
```

### 5.3 SSE 이벤트 스키마

```typescript
// 워크플로우 단계 업데이트
interface StepEvent {
  type: 'step';
  data: {
    step: string;
    message: string;
  };
}

// 검색 결과
interface RetrievalEvent {
  type: 'retrieval';
  data: {
    count: number;
    topScore: number;
    sources: string[];
  };
}

// 토큰 스트리밍
interface TokenEvent {
  type: 'token';
  data: {
    content: string;
  };
}

// Thinking 모드 중간 결과
interface ThinkingEvent {
  type: 'thinking';
  data: {
    phase: string;
    content: string;
  };
}

// 완료
interface DoneEvent {
  type: 'done';
  data: {
    totalTokens: number;
    duration: number;
    threadId: string;
  };
}

// 에러
interface ErrorEvent {
  type: 'error';
  data: {
    message: string;
    code: string;
    retryAfter?: number;
  };
}

type SSEEvent = StepEvent | RetrievalEvent | TokenEvent | ThinkingEvent | DoneEvent | ErrorEvent;
```

---

## 6. 패키지 구조

```
src/
├── services/
│   └── chatbot/
│       ├── index.js                 # ChatbotService 메인 클래스
│       ├── doc-watcher.js           # 문서 감시 (chokidar)
│       ├── doc-loader.js            # 문서 로드 및 Frontmatter 파싱
│       ├── vector-store.js          # 벡터 스토어 관리
│       ├── llm-factory.js           # LLM 인스턴스 생성
│       ├── embedding-factory.js     # Embedding 인스턴스 생성
│       ├── token-estimator.js       # 토큰 추정 유틸리티
│       └── workflow/
│           ├── state.js             # ChatbotAnnotation 정의
│           ├── graph.js             # StateGraph 빌더
│           ├── prompts.js           # 시스템 프롬프트 (영어)
│           └── nodes/
│               ├── classify.js      # 질문 분류 노드
│               ├── retrieve.js      # 문서 검색 노드
│               ├── grade.js         # 문서 평가 노드
│               ├── rewrite.js       # 질문 재작성 노드
│               ├── generate.js      # 답변 생성 노드
│               ├── summarize.js     # 히스토리 요약 노드
│               └── thinking/        # Thinking 모드 노드
│                   ├── analyze.js
│                   ├── plan.js
│                   └── execute.js
├── controllers/
│   └── chatbot-controller.js        # API 컨트롤러 (SSE)
├── routes/
│   └── chatbot.js                   # 라우트 정의
├── middleware/
│   └── sse.js                       # SSE 미들웨어
└── views/
    └── chatbot.ejs                  # 챗봇 UI 템플릿

public/
├── js/
│   └── chatbot.js                   # 클라이언트 로직
└── css/
    └── chatbot.css                  # 챗봇 스타일
```

---

## 7. 외부 의존성

### 7.1 핵심 LangChain 패키지

| 패키지 | 버전 | 용도 |
|--------|------|------|
| `@langchain/core` | ^0.3.x | 코어 기능, 메시지 타입, 프롬프트 |
| `@langchain/langgraph` | ^0.2.x | StateGraph, Annotation, MemorySaver |
| `@langchain/openai` | ^0.3.x | ChatOpenAI, AzureChatOpenAI, OpenAIEmbeddings |
| `@langchain/ollama` | ^0.1.x | ChatOllama, OllamaEmbeddings |
| `@langchain/textsplitters` | ^0.1.x | RecursiveCharacterTextSplitter |
| `@langchain/classic` | ^0.0.x | MemoryVectorStore |

### 7.2 유틸리티 패키지

| 패키지 | 버전 | 용도 |
|--------|------|------|
| `zod` | ^3.x | 스키마 검증, withStructuredOutput |
| `chokidar` | ^3.6.x | 파일 시스템 감시 |

### 7.3 기존 DocLight 패키지 (재사용)

| 패키지 | 용도 |
|--------|------|
| `marked` | Markdown 렌더링 |
| `dompurify` | XSS 방지 |
| `express` | HTTP 서버 |

---

## 8. 보안 아키텍처

### 8.1 API 키 보호

```
┌─────────────────────────────────────────────────────────────────────┐
│                        API Key Flow                                  │
│                                                                      │
│  ┌─────────┐                      ┌─────────────────────────────┐   │
│  │ Browser │  (No API Key)        │       Server                │   │
│  │         │ ─────────────────────▶│                            │   │
│  │         │                      │  config.json5               │   │
│  │         │                      │  ┌───────────────────────┐  │   │
│  │         │                      │  │ chatbot.llm.apiKey    │──┼──▶ LLM API
│  │         │                      │  │ chatbot.embedding...  │  │   │
│  │         │                      │  └───────────────────────┘  │   │
│  └─────────┘                      └─────────────────────────────┘   │
│                                                                      │
│  ✓ API Key는 서버에서만 사용                                          │
│  ✓ 클라이언트로 절대 전송 안함                                        │
│  ✓ 환경 변수 또는 config.json5에서 로드                              │
└─────────────────────────────────────────────────────────────────────┘
```

### 8.2 XSS 방지

```
┌─────────────────────────────────────────────────────────────────────┐
│                        XSS Protection Flow                           │
│                                                                      │
│  LLM Response ──▶ marked.parse() ──▶ DOMPurify.sanitize() ──▶ DOM  │
│                                                                      │
│  ✓ 모든 Markdown 렌더링 결과 sanitize                                │
│  ✓ 코드 블록 내 스크립트 무력화                                       │
│  ✓ 악성 HTML 태그 제거                                               │
└─────────────────────────────────────────────────────────────────────┘
```

### 8.3 Rate Limiting

```
┌─────────────────────────────────────────────────────────────────────┐
│                        Rate Limiting                                 │
│                                                                      │
│  세션별 제한: 10회/분                                                 │
│                                                                      │
│  ┌──────────────────────────────────────────────────────────────┐   │
│  │  threadId: "abc123"                                          │   │
│  │  requests: [                                                 │   │
│  │    { timestamp: 1234567890000 },                             │   │
│  │    { timestamp: 1234567891000 },                             │   │
│  │    ...                                                       │   │
│  │  ]                                                           │   │
│  │                                                              │   │
│  │  if (requests.filter(r => now - r.timestamp < 60000) >= 10)  │   │
│  │    return 429 Too Many Requests                              │   │
│  └──────────────────────────────────────────────────────────────┘   │
└─────────────────────────────────────────────────────────────────────┘
```

---

## 9. 성능 최적화 전략

### 9.1 임베딩 캐싱

```
문서 변경 시:
1. 해시 계산 (content → SHA256 → base64[:32])
2. 기존 해시와 비교
3. 변경된 경우에만 재임베딩

효과: 재시작 시 처리 시간 50% 단축
```

### 9.2 배치 임베딩

```
다수 문서 처리 시:
1. 청크 수집 (최대 100개)
2. embedDocuments() 일괄 호출
3. 벡터 스토어에 배치 추가

효과: 처리량 3배 향상
```

### 9.3 스트리밍 최적화

```
SSE 스트리밍:
1. 토큰 단위 전송 (streamMode: "messages")
2. Connection: keep-alive
3. 청크 인코딩

효과: 체감 응답 시간 단축 (TTFB ≤ 2초)
```

---

## 10. 다국어 응답 전략

### 10.1 시스템 프롬프트 (영어 고정)

```javascript
// src/services/chatbot/workflow/prompts.js

export const SYSTEM_PROMPT = `You are a helpful document assistant.
You answer questions based on the retrieved documents.
Be concise and accurate.

IMPORTANT LANGUAGE RULE:
- If the user asks in Korean, respond in Korean.
- If the user asks in English, respond in English.
- Match the user's language in your response.`;

export const CLASSIFY_PROMPT = `Classify the following user input into one of these categories:
1. question: A specific question about documents
2. summary: A request for summarization
3. chitchat: Casual conversation, greetings
4. unknown: Cannot classify

User input: {input}

Respond in JSON format.`;

export const GRADE_PROMPT = `You are a grader assessing relevance of retrieved documents.
...`;

export const REWRITE_PROMPT = `Rewrite the following question to improve search results.
...`;
```

### 10.2 언어 감지 로직

```javascript
// 사용자 질문 언어 감지
function detectLanguage(text) {
  const koreanRegex = /[\uAC00-\uD7AF]/;
  return koreanRegex.test(text) ? 'ko' : 'en';
}

// 답변 생성 시 언어 힌트 포함
const language = detectLanguage(userQuestion);
const languageHint = language === 'ko'
  ? 'Respond in Korean.'
  : 'Respond in English.';
```

---

## 11. 에러 처리 및 폴백 전략

### 11.1 에러 분류 체계

```typescript
// 에러 코드 정의
enum ChatbotErrorCode {
  // LLM 관련 (1xx)
  LLM_CONNECTION_ERROR = 'ERR_LLM_100',
  LLM_RATE_LIMIT = 'ERR_LLM_101',
  LLM_TIMEOUT = 'ERR_LLM_102',
  LLM_INVALID_RESPONSE = 'ERR_LLM_103',
  LLM_CONTEXT_LENGTH_EXCEEDED = 'ERR_LLM_104',

  // 벡터 검색 관련 (2xx)
  VECTOR_NO_DOCUMENTS = 'ERR_VEC_200',
  VECTOR_LOW_RELEVANCE = 'ERR_VEC_201',
  VECTOR_EMBEDDING_FAILED = 'ERR_VEC_202',

  // 워크플로우 관련 (3xx)
  WORKFLOW_INVALID_STATE = 'ERR_WF_300',
  WORKFLOW_MAX_RETRIES = 'ERR_WF_301',
  WORKFLOW_NODE_FAILED = 'ERR_WF_302',

  // 세션 관련 (4xx)
  SESSION_NOT_FOUND = 'ERR_SES_400',
  SESSION_EXPIRED = 'ERR_SES_401',

  // 일반 (5xx)
  UNKNOWN_ERROR = 'ERR_GEN_500',
}

interface ErrorResponse {
  code: ChatbotErrorCode;
  message: string;
  recoverable: boolean;
  retryAfter?: number;
  fallbackAction?: string;
}
```

### 11.2 노드별 에러 처리 전략

```
┌─────────────────────────────────────────────────────────────────────────────┐
│                        Error Handling Strategy                               │
├─────────────────────────────────────────────────────────────────────────────┤
│                                                                              │
│  [classifyQuery] ─── Error ───► Fallback: queryType = "question"            │
│        │                         (질문으로 가정하고 진행)                      │
│        ▼                                                                     │
│  [retrieveDocs] ─── Error ───► Fallback: retrievedDocs = []                 │
│        │             No docs ──► Fallback: generateAnswer with no context   │
│        ▼                                                                     │
│  [gradeDocuments] ── Error ───► Fallback: relevanceScore = 0.5              │
│        │              All fail ► Fallback: use top 3 docs by similarity     │
│        ▼                                                                     │
│  [rewriteQuery] ─── Error ────► Fallback: use original query                │
│        │            Max retry ─► Proceed to generateAnswer                  │
│        ▼                                                                     │
│  [generateAnswer] ── Error ───► Fallback: graceful error message            │
│        │             Timeout ──► Partial response + continue                 │
│        ▼                                                                     │
│  [summarizeHistory] ─ Error ──► Fallback: truncate old messages             │
│                                                                              │
└─────────────────────────────────────────────────────────────────────────────┘
```

### 11.3 재시도 전략 (Exponential Backoff)

```javascript
// src/services/chatbot/retry-strategy.js

const RETRY_CONFIG = {
  maxRetries: 3,
  initialDelayMs: 1000,
  maxDelayMs: 10000,
  backoffMultiplier: 2,
  retryableErrors: [
    'ECONNRESET',
    'ETIMEDOUT',
    'ERR_LLM_101',  // Rate limit
    'ERR_LLM_102',  // Timeout
  ],
};

async function withRetry(fn, config = RETRY_CONFIG) {
  let lastError;
  for (let attempt = 0; attempt < config.maxRetries; attempt++) {
    try {
      return await fn();
    } catch (error) {
      lastError = error;
      if (!isRetryable(error, config.retryableErrors)) {
        throw error;
      }
      const delay = Math.min(
        config.initialDelayMs * Math.pow(config.backoffMultiplier, attempt),
        config.maxDelayMs
      );
      await sleep(delay);
    }
  }
  throw lastError;
}
```

### 11.4 Graceful Degradation

| 실패 시나리오 | 폴백 동작 | 사용자 메시지 |
|--------------|----------|--------------|
| LLM 연결 실패 | 캐시된 응답 또는 에러 | "현재 AI 서비스에 접속할 수 없습니다. 잠시 후 다시 시도해주세요." |
| 검색 결과 없음 | 직접 LLM 응답 | "관련 문서를 찾지 못했습니다. 일반적인 답변을 드리겠습니다." |
| 모든 문서 관련성 낮음 | 상위 3개 문서로 진행 | "정확히 일치하는 문서는 없지만, 가장 관련된 내용을 기반으로 답변드리겠습니다." |
| 컨텍스트 길이 초과 | 자동 요약 후 재시도 | (내부 처리, 사용자에게 투명) |
| 스트리밍 중 연결 끊김 | 부분 응답 저장 | "연결이 끊어졌습니다. 이전 응답이 저장되었습니다." |

---

## 12. 관측성 (Observability) 아키텍처

### 12.1 LangSmith 트레이싱 통합

```javascript
// src/services/chatbot/tracing.js

import { Client } from "langsmith";

// 환경변수로 제어
// LANGSMITH_TRACING=true
// LANGSMITH_API_KEY=your_key
// LANGSMITH_PROJECT=doclight-chatbot

const tracingEnabled = process.env.LANGSMITH_TRACING === 'true';

export function setupTracing() {
  if (!tracingEnabled) {
    return { enabled: false };
  }

  return {
    enabled: true,
    client: new Client(),
    callbacks: {
      handleLLMStart: (llm, prompts, runId) => { /* log */ },
      handleLLMEnd: (output, runId) => { /* log */ },
      handleLLMError: (error, runId) => { /* log */ },
      handleChainStart: (chain, inputs, runId) => { /* log */ },
      handleChainEnd: (outputs, runId) => { /* log */ },
      handleRetrieverStart: (retriever, query, runId) => { /* log */ },
      handleRetrieverEnd: (documents, runId) => { /* log */ },
    },
  };
}
```

### 12.2 구조화된 로깅

```javascript
// src/services/chatbot/logger.js

// 워크플로우 단계별 로그 포맷
const logFormat = {
  workflow: {
    start: (threadId, input) => ({
      level: 'info',
      event: 'workflow.start',
      threadId,
      inputLength: input.length,
      timestamp: Date.now(),
    }),
    nodeStart: (threadId, nodeName, state) => ({
      level: 'debug',
      event: 'workflow.node.start',
      threadId,
      node: nodeName,
      stateKeys: Object.keys(state),
      timestamp: Date.now(),
    }),
    nodeEnd: (threadId, nodeName, duration, result) => ({
      level: 'debug',
      event: 'workflow.node.end',
      threadId,
      node: nodeName,
      durationMs: duration,
      resultKeys: Object.keys(result),
      timestamp: Date.now(),
    }),
    nodeError: (threadId, nodeName, error) => ({
      level: 'error',
      event: 'workflow.node.error',
      threadId,
      node: nodeName,
      error: error.message,
      code: error.code,
      stack: error.stack,
      timestamp: Date.now(),
    }),
    end: (threadId, totalDuration, success) => ({
      level: 'info',
      event: 'workflow.end',
      threadId,
      totalDurationMs: totalDuration,
      success,
      timestamp: Date.now(),
    }),
  },
  retrieval: {
    search: (threadId, query, k) => ({
      level: 'debug',
      event: 'retrieval.search',
      threadId,
      queryLength: query.length,
      k,
      timestamp: Date.now(),
    }),
    results: (threadId, count, topScore, sources) => ({
      level: 'info',
      event: 'retrieval.results',
      threadId,
      documentCount: count,
      topScore,
      sources: sources.slice(0, 5),
      timestamp: Date.now(),
    }),
  },
  llm: {
    call: (threadId, model, tokenEstimate) => ({
      level: 'debug',
      event: 'llm.call',
      threadId,
      model,
      estimatedTokens: tokenEstimate,
      timestamp: Date.now(),
    }),
    response: (threadId, model, duration, tokenCount) => ({
      level: 'info',
      event: 'llm.response',
      threadId,
      model,
      durationMs: duration,
      tokens: tokenCount,
      timestamp: Date.now(),
    }),
  },
};
```

### 12.3 메트릭 수집

```javascript
// src/services/chatbot/metrics.js

// 수집할 핵심 메트릭
const metrics = {
  // 응답 시간
  responseTime: new Histogram({
    name: 'chatbot_response_time_ms',
    help: 'Response time in milliseconds',
    labelNames: ['queryType', 'thinkingMode'],
    buckets: [100, 500, 1000, 2000, 5000, 10000],
  }),

  // 노드별 처리 시간
  nodeProcessingTime: new Histogram({
    name: 'chatbot_node_processing_time_ms',
    help: 'Node processing time in milliseconds',
    labelNames: ['node'],
    buckets: [50, 100, 200, 500, 1000, 2000],
  }),

  // 검색 결과 관련성
  retrievalRelevance: new Histogram({
    name: 'chatbot_retrieval_relevance',
    help: 'Relevance score of retrieved documents',
    buckets: [0, 0.2, 0.4, 0.6, 0.7, 0.8, 0.9, 1],
  }),

  // 재시도 횟수
  retryCount: new Counter({
    name: 'chatbot_retry_count',
    help: 'Number of retries',
    labelNames: ['node', 'errorCode'],
  }),

  // 에러 발생 횟수
  errorCount: new Counter({
    name: 'chatbot_error_count',
    help: 'Number of errors',
    labelNames: ['node', 'errorCode'],
  }),

  // 토큰 사용량
  tokenUsage: new Counter({
    name: 'chatbot_token_usage',
    help: 'Token usage',
    labelNames: ['model', 'type'], // type: input, output
  }),

  // 활성 세션 수
  activeSessions: new Gauge({
    name: 'chatbot_active_sessions',
    help: 'Number of active sessions',
  }),
};
```

### 12.4 디버그 모드

```javascript
// src/services/chatbot/debug.js

// 환경변수: CHATBOT_DEBUG=true
const debugEnabled = process.env.CHATBOT_DEBUG === 'true';

export class DebugTracer {
  constructor(threadId) {
    this.threadId = threadId;
    this.steps = [];
    this.startTime = Date.now();
  }

  addStep(name, input, output, duration) {
    if (!debugEnabled) return;

    this.steps.push({
      name,
      timestamp: Date.now() - this.startTime,
      duration,
      inputSummary: this._summarize(input),
      outputSummary: this._summarize(output),
    });
  }

  getTrace() {
    return {
      threadId: this.threadId,
      totalDuration: Date.now() - this.startTime,
      steps: this.steps,
    };
  }

  _summarize(obj) {
    // 대용량 데이터 요약 (디버그 로그용)
    if (Array.isArray(obj)) return `Array(${obj.length})`;
    if (typeof obj === 'string') return obj.slice(0, 100) + (obj.length > 100 ? '...' : '');
    if (typeof obj === 'object') return Object.keys(obj).join(', ');
    return String(obj);
  }
}

// SSE로 디버그 정보 전송 (개발 모드에서만)
interface DebugEvent {
  type: 'debug';
  data: {
    node: string;
    duration: number;
    inputSummary: string;
    outputSummary: string;
    memoryUsage: number;
  };
}
```

### 12.5 Health Check 확장

```javascript
// GET /api/chatbot/health
{
  status: 'healthy' | 'degraded' | 'unhealthy',
  timestamp: 1234567890,
  components: {
    llm: {
      status: 'healthy',
      latencyMs: 150,
      lastCheck: 1234567800,
    },
    embedding: {
      status: 'healthy',
      latencyMs: 50,
      lastCheck: 1234567800,
    },
    vectorStore: {
      status: 'healthy',
      documentCount: 150,
      chunkCount: 1200,
      lastUpdated: 1234567700,
    },
    session: {
      status: 'healthy',
      activeCount: 5,
      memoryUsageMB: 128,
    },
  },
  version: '1.0.0',
}
```

---

## 13. 세션 관리 고급 전략

### 13.1 세션 TTL 및 정리

```javascript
// src/services/chatbot/session-manager.js

const SESSION_CONFIG = {
  maxIdleTimeMs: 30 * 60 * 1000,  // 30분
  maxSessionDurationMs: 2 * 60 * 60 * 1000,  // 2시간
  cleanupIntervalMs: 5 * 60 * 1000,  // 5분마다 정리
  maxSessionsPerIp: 5,
};

class SessionManager {
  constructor(checkpointer, config = SESSION_CONFIG) {
    this.checkpointer = checkpointer;
    this.config = config;
    this.sessions = new Map();  // threadId -> { createdAt, lastAccessedAt, ip }

    // 주기적 정리
    this.cleanupInterval = setInterval(
      () => this.cleanup(),
      this.config.cleanupIntervalMs
    );
  }

  async getOrCreate(threadId, ip) {
    if (this.sessions.has(threadId)) {
      const session = this.sessions.get(threadId);
      session.lastAccessedAt = Date.now();
      return { isNew: false, threadId };
    }

    // IP별 세션 제한 체크
    const sessionsForIp = [...this.sessions.values()].filter(s => s.ip === ip);
    if (sessionsForIp.length >= this.config.maxSessionsPerIp) {
      throw new Error('MAX_SESSIONS_PER_IP_EXCEEDED');
    }

    this.sessions.set(threadId, {
      createdAt: Date.now(),
      lastAccessedAt: Date.now(),
      ip,
    });

    return { isNew: true, threadId };
  }

  cleanup() {
    const now = Date.now();
    for (const [threadId, session] of this.sessions) {
      const idleTime = now - session.lastAccessedAt;
      const totalTime = now - session.createdAt;

      if (idleTime > this.config.maxIdleTimeMs ||
          totalTime > this.config.maxSessionDurationMs) {
        this.sessions.delete(threadId);
        // checkpointer에서도 제거 (메모리 해제)
        this.checkpointer.delete(threadId);
      }
    }
  }

  async destroy() {
    clearInterval(this.cleanupInterval);
    this.sessions.clear();
  }
}
```

### 13.2 상태 직렬화/역직렬화

```javascript
// 세션 상태 영구 저장 (선택적 확장)
interface SerializedSession {
  threadId: string;
  messages: SerializedMessage[];
  summary: string;
  createdAt: number;
  lastAccessedAt: number;
  metadata: Record<string, unknown>;
}

// Redis 기반 Checkpointer (향후 확장용)
class RedisCheckpointer {
  constructor(redisClient) {
    this.client = redisClient;
    this.prefix = 'chatbot:session:';
  }

  async put(threadId, state) {
    await this.client.setEx(
      `${this.prefix}${threadId}`,
      7200,  // 2시간 TTL
      JSON.stringify(state)
    );
  }

  async get(threadId) {
    const data = await this.client.get(`${this.prefix}${threadId}`);
    return data ? JSON.parse(data) : null;
  }

  async delete(threadId) {
    await this.client.del(`${this.prefix}${threadId}`);
  }
}
```
