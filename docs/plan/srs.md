# 📘 Software Requirements Specification (SRS)

## Project: **DocuLight**

### Subtitle: *Lightweight Markdown File Viewer & Manager*

---

## 1. 개요

### 1.1 목적

**DocuLight**는 사내 Markdown 문서를 쉽게 탐색, 열람, 관리하기 위한 경량 웹 서버입니다.
Markdown 파일(.md) 및 그 하위 구조를 브라우저에서 시각적으로 트리 형태로 표시하며,
간단한 REST API를 통해 파일 업로드, 삭제, 다운로드가 가능합니다.

본 시스템은 **비개발자도 Markdown 문서를 중앙 저장소에 업로드하고, 브라우저로 탐색**할 수 있도록 설계되었습니다.

### 1.2 범위

* **하나의 루트 디렉토리**를 기준으로 문서를 관리합니다.
* **단일 인스턴스 Node.js 서버**에서 동작하며, PM2 등 프로세스 매니저를 통해 구동합니다.
* **단일 API 키**를 이용한 인증으로 쓰기/삭제/다운로드 권한을 제어합니다.
* **디렉터리 구조**는 옵시디언(Obsidian) 좌측 트리와 유사하게 표시되며, **IndexedDB**에 UI 상태(펼침/접힘)를 저장합니다.
* **브라우저에서 실시간 렌더링(marked)** 을 수행하며 서버는 HTML 렌더링 캐시를 하지 않습니다.

---

## 2. 시스템 요약

| 구분         | 내용                                             |
| ---------- | ---------------------------------------------- |
| **시스템 이름** | DocuLight                                       |
| **주요 기능**  | 문서 트리 탐색, Markdown 렌더링, 파일 업로드/다운로드/삭제, ZIP 관리 |
| **대상 사용자** | 사내 문서 관리 담당자, 개발/기획/디자인 등 비개발자                 |
| **운영 환경**  | Node.js 18 이상, Express + EJS                   |
| **저장소**    | 로컬 파일 시스템(문서 루트), 브라우저 IndexedDB(트리 상태)        |
| **보안 정책**  | 단일 API 키 (X-API-Key), 경로 검증, excludes 규칙 적용    |
| **성능 목표**  | 없음 (비기능 요구 없음, 단순 사내용)                         |
| **배포 방식**  | PM2로 단일 서버 구동                                  |
| **로그 방식**  | winston 기반 파일 로그 (log 디렉토리 내 일자별 기록)           |

---

## 3. 주요 사용자 및 사용 시나리오

### 3.1 사용자 정의

* **Viewer** : 문서 열람만 수행하는 일반 사내 사용자.
* **Admin** : API Key를 가진 사용자로 업로드, 삭제, 다운로드 가능.

### 3.2 사용 시나리오

| 시나리오         | 설명                                                    |
| ------------ | ----------------------------------------------------- |
| **문서 탐색**    | 좌측 트리에서 디렉터리를 펼치고 Markdown 파일을 클릭해 본문 렌더링.            |
| **문서 상태 유지** | 브라우저 IndexedDB에 트리 접힘/펼침 상태 저장 후, 다음 접속 시 복원.         |
| **파일 업로드**   | 특정 디렉터리에 Markdown 또는 ZIP 파일 업로드 (덮어쓰기).               |
| **파일 삭제**    | 디렉터리 또는 파일을 재귀 삭제.                                    |
| **파일 다운로드**  | 단일 파일 또는 전체 디렉터리를 ZIP으로 다운로드.                         |
| **문서 렌더링**   | marked.js로 Markdown → HTML 변환, mermaid.js로 다이어그램 렌더링. |

---

## 4. 기능 요구사항 (Functional Requirements)

### FR-1. 문서 트리 탐색

* **입력**: path (상대경로)
* **출력**: 디렉터리 및 파일 목록(JSON)
* **기능 상세**:

    1. 루트 디렉터리 하위 항목만 탐색 가능.
    2. 숨김파일(`.`으로 시작) 및 excludes 규칙에 매칭되는 항목은 표시하지 않음.
    3. 결과는 **사전식 정렬**.
    4. 폴더는 굵은 글씨, 그 하위에 `.md` 파일 나열.
* **예외상황**:

    * path 파라미터가 루트 밖 → 400 PATH_TRAVERSAL
    * 존재하지 않음 → 404 NOT_FOUND
    * 권한 부족 → 403 PERMISSION_DENIED

---

### FR-2. 문서 내용 조회

* **입력**: 파일 경로 (`GET /raw?path=...`)
* **출력**: Markdown 원문 (text/plain)
* **기능 상세**:

    * `.md` 확장자만 허용.
    * 프론트엔드에서 `marked`로 GitHub 스타일 렌더링.
    * 코드 블록, mermaid, 링크, 테이블 지원.
* **예외상황**:

    * 파일 없음 → 404 NOT_FOUND
    * 확장자 불일치 → 415 UNSUPPORTED_TYPE
    * 접근 금지 경로 → 400 PATH_TRAVERSAL

---

### FR-3. 파일 업로드

* **입력**: multipart/form-data (file)
* **정책**:

    * 동일 파일 존재 시 **덮어쓰기**.
    * ZIP 업로드 시 압축 내부 파일을 **상대경로 기준으로 해제**.
    * 충돌 시 모두 덮어쓰기.
    * 업로드 최대 크기 = `maxUploadMB` (기본 10MB).
    * 업로드 로그 기록.
* **예외상황**:

    * API 키 누락/오류 → 401
    * 크기 초과 → 413
    * ZIP 내부에 ../ 경로 → 해당 항목 무시 (로그 경고)
    * excludes 매칭 → 업로드 불가 403 EXCLUDED
    * 디스크 용량 부족 → 500 INTERNAL

---

### FR-4. 파일/디렉터리 삭제

* **입력**: path
* **정책**:

    * **재귀 삭제** 허용.
    * excludes 규칙에 매칭된 항목은 삭제 불가.
    * 삭제 중 파일이 잠겨 있으면 2회 재시도 후 실패 처리.
* **예외상황**:

    * 인증 실패 → 401
    * 파일 없음 → 404
    * 파일 사용중 → 409 FILE_BUSY
    * I/O 오류 → 500 INTERNAL

---

### FR-5. 다운로드

* **단일 파일 다운로드**

    * `GET /api/download/file?path=...`
    * 헤더 `X-API-Key` 필수.
    * Content-Disposition: attachment.
* **디렉터리 ZIP 다운로드**

    * `GET /api/download/dir?path=...`
    * ZIP 파일명 = 디렉터리명.zip
    * excludes 규칙 적용.
    * 스트리밍으로 전송.
* **예외상황**:

    * 인증 실패 → 401
    * 대상 없음 → 404
    * excludes 대상 → 403 EXCLUDED
    * ZIP 오류 → 500

---

### FR-6. 트리 상태 저장 (Client)

* **저장 위치**: 브라우저 IndexedDB
* **내용**:

    * 디렉터리별 `{ expanded: boolean }`
    * `lastOpenedFile` (최근 열람 파일)
* **동작**:

    * 트리 토글 시 즉시 저장.
    * 초기 접속 시 IndexedDB 상태 복원.

---

### FR-7. 설정 파일 관리

* **형식:** JSON5
* **예시:**

  ```json5
  {
    docsRoot: "/data/docs",
    apiKey: "secret123",
    maxUploadMB: 10,
    excludes: ["**/.git/", "*.tmp"],
    logDir: "./log"
  }
  ```
* **검증**:

    * docsRoot 존재 여부 확인.
    * apiKey 미입력 시 오류로 종료.
    * excludes 배열 검증 (문자열만 허용).
    * logDir 없으면 자동 생성.

---

## 5. 비기능 요구사항 (Non-Functional Requirements)

| 분류      | 요구사항                                           | 비고        |
| ------- | ---------------------------------------------- | --------- |
| **성능**  | 응답 시간 제한 없음 (비기능 목표 미설정)                       | 사내용       |
| **가용성** | 단일 인스턴스, PM2로 상시 운영                            |           |
| **보안**  | Path Traversal 차단, excludes 필터 적용, 단일 API 키 인증 |           |
| **로그**  | 모든 FS 작업 및 오류는 로그 기록                           | `winston` |
| **확장성** | 다중 루트/역할 분리/검색 기능은 후속 버전 고려                    |           |
| **캐시**  | 서버 캐시 없음, 클라이언트 실시간 렌더링                        |           |
| **호환성** | Chrome, Edge, Firefox 최신 버전 지원                 |           |
| **국제화** | UTF-8 파일명 완전 지원                                |           |
| **신뢰성** | 업로드/삭제 동시 요청 시 경로 단위 Mutex로 충돌 방지              |           |

---

## 6. 예외 처리 정책 요약

| 구분          | 코드                | 상태  | 설명          |
| ----------- | ----------------- | --- | ----------- |
| 루트 밖 접근     | PATH_TRAVERSAL    | 400 | 루트 이탈 경로 접근 |
| 인증 실패       | UNAUTHORIZED      | 401 | API 키 누락/오류 |
| 권한 부족       | PERMISSION_DENIED | 403 | 파일 접근 불가    |
| excludes 매칭 | EXCLUDED          | 403 | 제외 규칙 적용    |
| 파일 없음       | NOT_FOUND         | 404 | 존재하지 않음     |
| 확장자 오류      | UNSUPPORTED_TYPE  | 415 | `.md` 아님    |
| 파일 크기 초과    | PAYLOAD_TOO_LARGE | 413 | 업로드 제한 초과   |
| 경로 충돌       | CONFLICT          | 409 | 락 타임아웃      |
| ZIP 내부 ../  | PATH_TRAVERSAL    | 400 | 보안 차단       |
| 파일 사용중      | FILE_BUSY         | 409 | 2회 재시도 후 실패 |
| I/O 오류      | INTERNAL          | 500 | 일반 오류       |

---

## 7. 데이터 및 스키마 구조

### 7.1 IndexedDB (클라이언트)

```js
database: "DocuLight"
store: "treeState"  // key: dirPath, value: { expanded: boolean, ts }
store: "lastOpened" // key: "file", value: { path, ts }
```

### 7.2 서버 설정(JSON5)

```json5
{
  "docsRoot": "/data/docs",
  "apiKey": "secret123",
  "maxUploadMB": 10,
  "excludes": ["**/.git/", "*.tmp"],
  "logDir": "./log"
}
```

---

## 8. REST API 요약

| Method | Path                       | 인증 | 설명              |
| ------ | -------------------------- | -- | --------------- |
| GET    | `/api/tree?path=`          | ❌  | 디렉터리/파일 목록      |
| GET    | `/raw?path=`               | ❌  | Markdown 원문     |
| POST   | `/api/upload?path=`        | ✅  | 파일 업로드 (ZIP 포함) |
| DELETE | `/api/entry?path=`         | ✅  | 파일/디렉터리 삭제      |
| GET    | `/api/download/file?path=` | ✅  | 파일 다운로드         |
| GET    | `/api/download/dir?path=`  | ✅  | 디렉터리 ZIP 다운로드   |
| GET    | `/healthz`                 | ❌  | 헬스체크 (200 OK)   |

---

## 9. 운영 요구사항

| 항목       | 내용                                 |
| -------- | ---------------------------------- |
| 실행       | `pm2 start app.js --name DocuLight` |
| 로그       | `./log/DocuLight-YYYYMMDD.log`      |
| 백업       | 문서 루트 및 설정 파일 백업                   |
| 장애 복구    | 로그 분석 후 수동 복원                      |
| 업데이트     | zip 업로드로 문서 교체 가능                  |
| 디스크 모니터링 | OS 수준에서 수행                         |
| 헬스체크     | `/healthz` (상태 200 OK)             |

---

## 10. 제약 조건

| 구분    | 제약 내용                         |
| ----- | ----------------------------- |
| 문서 루트 | 단일 디렉터리만 허용                   |
| 인증    | 단일 API 키만 허용                  |
| UI    | 옵시디언 유사 트리, 접힘상태 IndexedDB 저장 |
| 경로    | 루트 밖 접근 절대 금지                 |
| ZIP   | ../ 경로 무시 및 로그 남김             |
| 업로드   | 무조건 덮어쓰기                      |
| CORS  | 제한 없음 (내부망만 사용)               |
| DB    | 서버 DB 미사용 (파일 시스템 기반)         |
| 캐시    | 없음 (MVP)                      |

---

## 11. 테스트 항목

| 번호   | 테스트 시나리오                | 기대 결과                 |
| ---- | ----------------------- | --------------------- |
| T-01 | 루트 밖 경로 요청              | 400 PATH_TRAVERSAL    |
| T-02 | 숨김파일 `.gitignore` 포함 폴더 | 목록에서 제외               |
| T-03 | 업로드 크기 초과               | 413 PAYLOAD_TOO_LARGE |
| T-04 | ZIP 내부 `../` 파일 포함      | 해당 파일 무시              |
| T-05 | 재귀 삭제 수행                | 정상 삭제                 |
| T-06 | 같은 파일 동시에 업로드           | 두 번째 덮어쓰기             |
| T-07 | API 키 누락                | 401 UNAUTHORIZED      |
| T-08 | excludes 대상 업로드         | 403 EXCLUDED          |
| T-09 | 디렉터리 ZIP 다운로드           | 스트리밍 완료               |
| T-10 | 접힘/펼침 상태 유지             | IndexedDB 복원 성공       |

---

## 12. 향후 개선 계획

* 다중 루트 지원 (`docsRoots[]`)
* 복수 API 키 및 권한 스코프(Role 분리)
* 검색 기능 (全文 search)
* 서버 측 렌더링 및 캐시
* 문서 버전 관리
* 파일 메타데이터 DB 관리

---

## 13. 승인 및 변경 이력

| 버전   | 작성일        | 작성자 | 주요 변경 내용       |
| ---- | ---------- | --- | -------------- |
| v0.1 | 2025-10-23 | PM  | 최초 작성          |
| v0.2 | 예정         | PM  | SDS 반영 및 설정 확정 |

---

✅ **DocuLight**는 단일 API 키 기반의 경량 Markdown 관리 서버로,
명확한 경로 검증·덮어쓰기 정책·예외처리 규칙을 포함하여,
사내 문서 관리의 표준화된 인터페이스를 제공합니다.

---

원하시면 이 SRS 를 기반으로

* **모듈 사양서(각 JS 모듈별 인터페이스 + 시퀀스)**
* **API 사전 (Request/Response/에러 예제 포함)**
* **JSON5 설정 Schema 정의 (예: `DocuLight.config.schema.json`)**
  를 이어서 작성해드릴 수 있습니다.

다음으로 어떤 문서를 원하시나요?
